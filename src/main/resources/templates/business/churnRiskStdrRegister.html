<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout}">
<head>
<meta charset="UTF-8">
<title>churn_risk_stdr_register</title>

<link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>

<style>
.fixed-photo{
	width:150px;
	height:200px;
	object-fit:cover;
}
.form-select{ color:#000 !important; }

/* ===== 이 화면 전용 범위(wrapper) ===== */
.churn-stdr-wrapper .help-text{
	font-size:12px;
	color:#6c757d;
	font-weight:300;
	opacity:0.75;

	/* 길면 내려가도 됨 */
	white-space:normal;
	margin-left: 0;
}

.churn-stdr-wrapper .card-header-left{
	display:flex;
	align-items:center;
	gap:4px;
}

.churn-stdr-wrapper .card-header-left .card-title{
	margin-bottom:0;
	white-space:nowrap;
}

/* (선택) 안내문이 너무 길어서 카드 헤더 높이가 커지는 게 싫으면 아래 주석 해제
.churn-stdr-wrapper .help-text{
	white-space:nowrap;
	overflow:hidden;
	text-overflow:ellipsis;
}
*/
</style>
</head>

<body layout:fragment="content">
	<div class="churn-stdr-wrapper">

		<!-- 휴면기준 -->
		<div class="row">
			<div class="card mb-3">
				<div class="card-header">
					<div class="card-header-left">
						<h5 class="card-title me-2">휴면기준</h5>
						<span class="help-text">* 기준값은 숫자만 입력해주십시오.</span>
					</div>
					<div class="card-header-right">
						<button type="button" class="btn btn-outline-dark btnSave" data-type="dormancy">저장</button>
					</div>
				</div>

				<div class="card-body">
					<div id="Dormancygrid" style="margin:20px;"></div>
				</div>
			</div>
		</div>

		<!-- 이탈위험기준 -->
		<div class="row">
			<div class="card mb-3">
				<div class="card-header">
					<div class="card-header-left">
						<h5 class="card-title me-2">이탈위험기준</h5>
						<span class="help-text">* 기준값은 숫자만 입력해주십시오.</span>
					</div>
					<div class="card-header-right">
						<button type="button" class="btn btn-outline-dark btnSave" data-type="churn">저장</button>
					</div>
				</div>

				<div class="card-body">
					<div id="Churngrid" style="margin:20px;"></div>
				</div>
			</div>
		</div>

	</div>

	<script th:inline="javascript">
	const allList = /*[[${getChurnStdrList}]]*/ [];

	// ===== 공통 테마 =====
	tui.Grid.applyTheme('default', {
		cell: {
			normal: { border:'#ccc', background:'#fff', showVerticalBorder:true },
			header: { border:'#ccc', background:'#E3E6ED', showVerticalBorder:true },
			editable: { background:'#FFFDF0', text:'#000' },
			selectedHeader: { background:'#E3E6ED' },
			selected: { background:'#ffffff' }
		}
	});

	// ===== 데이터 분리 =====
	const DormancyData = allList.filter(row => row.salesChange === "휴면");
	const ChurnData    = allList.filter(row => row.salesChange === "이탈");

	// ===== 그리드 생성(휴면) =====
	const Dormancygrid = new tui.Grid({
		el: document.getElementById('Dormancygrid'),
		data: DormancyData,
		scrollX: false,
		scrollY: false,
		minBodyHeight: 0,
		columns: [
			{ header:'기준유형', name:'ty', sortable:true, align:'center', width:200 },
			{ header:'휴면/이탈 타입', name:'salesChange', sortable:true, align:'center', hidden:true },
			{ header:'기준값', name:'stdrValue', editor:'text', align:'center', width:200 },
			{ header:'설명', name:'stdrDc' },
			{ header:'사용여부', name:'yn', align:'center', width:200 }
		]
	});

	// ===== 그리드 생성(이탈) =====
	const Churngrid = new tui.Grid({
		el: document.getElementById('Churngrid'),
		data: ChurnData,
		scrollX: false,
		scrollY: false,
		minBodyHeight: 0,
		autoWidth: true,
		columns: [
			{ header:'기준유형', name:'ty', sortable:true, align:'center', width:200 },
			{ header:'휴면/이탈 타입', name:'salesChange', sortable:true, align:'center', hidden:true },
			{ header:'기준값', name:'stdrValue', editor:'text', align:'center', width:200 },
			{ header:'설명', name:'stdrDc' },
			{ header:'사용여부', name:'yn', align:'center', width:200 }
		]
	});

	// ===== 기준값: 숫자만 + 자동 접미사(개월 이상 / % 이상) =====
	function attachNumericAutoSuffix(grid) {

		// 편집 시작: input에 숫자만 남기기
		grid.on('editingStart', (ev) => {
			if (!ev || ev.columnName !== 'stdrValue') return;

			setTimeout(() => {
				const input = document.querySelector('.tui-grid-layer-editing input');
				if (!input) return;

				input.setAttribute('inputmode', 'numeric');

				input.oninput = () => {
					input.value = input.value.replace(/[^0-9]/g, '');
				};
			}, 0);
		});

		// 편집 확정(엔터/탭/클릭 등): 숫자 + 접미사 자동
		grid.on('afterChange', (ev) => {
			if (!ev || !ev.changes) return;

			ev.changes.forEach((ch) => {
				if (ch.columnName !== 'stdrValue') return;

				const row = grid.getRow(ch.rowKey) || {};
				const raw = String(ch.value ?? '');
				const digits = raw.replace(/[^0-9]/g, '');

				if (!digits) {
					grid.setValue(ch.rowKey, 'stdrValue', '', false);
					return;
				}

				// 규칙: ty에 '기간' 또는 '주기' 들어가면 개월, 아니면 퍼센트
				const ty = String(row.ty ?? '');
				const isMonthType = ty.includes('기간') || ty.includes('주기');

				const suffix = isMonthType ? '개월 이상' : '% 이상';
				const newVal = digits + suffix;

				if (newVal !== raw) {
					grid.setValue(ch.rowKey, 'stdrValue', newVal, false);
				}
			});
		});
	}

	attachNumericAutoSuffix(Dormancygrid);
	attachNumericAutoSuffix(Churngrid);

	// ===== 저장 버튼 =====
	document.querySelectorAll('.btnSave').forEach(btn => {
		btn.addEventListener('click', function () {
			const type = this.dataset.type; // "dormancy" 또는 "churn"

			// 편집 종료
			Dormancygrid.finishEditing();
			Churngrid.finishEditing();

			// 변경분 수집
			const DormancyModified = Dormancygrid.getModifiedRows();
			const ChurnModified    = Churngrid.getModifiedRows();

			const DormancyList = DormancyModified.updatedRows.concat(DormancyModified.createdRows);
			const ChurnList    = ChurnModified.updatedRows.concat(ChurnModified.createdRows);

			fetch('/churnRiskStdrRegister/update', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({
					dormancyList: DormancyList,
					churnList: ChurnList
				})
			})
			.then(res => res.text())
			.then(() => {
				if (type === 'dormancy') alert('휴면 기준 저장되었습니다.');
				else if (type === 'churn') alert('이탈 기준 저장되었습니다.');
				else alert('저장되었습니다.');
			})
			.catch(err => console.error(err));
		});
	});
	</script>
</body>
</html>
