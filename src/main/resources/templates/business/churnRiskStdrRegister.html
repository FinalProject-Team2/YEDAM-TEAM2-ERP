<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout}">
<head>
<meta charset="UTF-8">
<title>churn_risk_stdr_register</title>
<link rel="stylesheet"
	href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>
</head>
<style>
.fixed-photo {
	width: 150px; /* 원하는 가로 크기 */
	height: 200px; /* 원하는 세로 크기 */
	object-fit: cover; /* 비율 유지하며 영역에 맞게 채움 */
}

.form-select {
	color: #000 !important;
}
</style>
<body layout:fragment="content">
	<!-- 휴면기준 -->
	<div class="card mb-3">
		<div class="card-header">
			<div class="card-header-left">
				<h5 class="card-title">휴면기준</h5>
			</div>
			<!-- card-header-left end -->
			<div class="card-header-right">
				<button type="button" class="btn btn-outline-dark btnSave" data-type="dormancy">저장</button>
			</div>
			<!-- //card-header right end -->
		</div>
		<!-- //card-header -->
		<div class="card-body">
			<div id="Dormancygrid" style="margin: 20px;"></div>
		</div>
	</div>
	<!-- 이탈위험기준 -->
	<div class="card mb-3">
		<div class="card-header">
			<div class="card-header-left">
				<h5 class="card-title">이탈위험기준</h5>
			</div>
			<!-- card-header-left end -->
			<div class="card-header-right">
				<button type="button" class="btn btn-outline-dark btnSave" data-type="churn">저장</button>
			</div>
			<!-- //card-header right end -->
		</div>
		<div class="card-body">
			<div id="Churngrid" style="margin: 20px;"></div>
		</div>
	</div>













	<script th:inline="javascript">
	
	const allList = /*[[${getChurnStdrList}]]*/ [];
 		// 그리드 디자인
		tui.Grid.applyTheme('default', {
			cell : {
				normal : { // 일반 셀(본문)
					border : '#ccc',
					background : "#fff",
					showVerticalBorder : true, // 세로 라인 표시
				},
				header : { // 헤더 셀
					border : '#ccc',
					background : '#E3E6ED',
					showVerticalBorder : true,
				},
				editable : { // ★ 편집 가능한 셀 공통 스타일
					background : '#FFFDF0', // 연노랑 같은 색으로 표시
					text : '#000'
				},
				selectedHeader : { // 헤더 클릭했을 때 색
					background : '#E3E6ED' // 헤더랑 똑같이 → 색 안 바뀌는 것처럼 보임
				},
				selected : { // 선택된 셀 색
					background : '#ffffff' // 필요하면 여기도 조정
				}
			}
		});
		const DormancyData = allList.filter(row => row.salesChange === "휴면");
		    console.log('DormancyData = ', DormancyData);
		// Grid 생성
		const Dormancygrid = new tui.Grid({
			el : document.getElementById('Dormancygrid'),
			data : DormancyData,
			scrollX : false,
			scrollY : false,
			minBodyHeight : 0,
			columns : [ {
				header : '기준유형',
				name : 'ty',
				sortable : 'true',
				align : 'center',
				width: 200
			}, {
				header : '휴면/이탈 타입',
				name : 'salesChange',
				sortable : 'true',
				align : 'center',
				hidden: true
			},{
				header : '기준값',
				name : 'stdrValue',
				editor : 'text',
				align : 'center',
				width: 200
			}, {
				header : '설명',
				name : 'stdrDc',
				editor : 'text'
			}, {
				header : '사용여부',
				name : 'yn',
				align : 'center',
				width: 200
			} ]
		});
		// 이탈위험기준 데이터
		tui.Grid.applyTheme('default', {
			cell : {
				normal : { // 일반 셀(본문)
					border : '#ccc',
					background : "#fff",
					showVerticalBorder : true, // 세로 라인 표시
				},
				header : { // 헤더 셀
					border : '#ccc',
					background : '#E3E6ED',
					showVerticalBorder : true,
				},
				editable : { // ★ 편집 가능한 셀 공통 스타일
					background : '#FFFDF0', // 연노랑 같은 색으로 표시
					text : '#000'
				},
				selectedHeader : { // 헤더 클릭했을 때 색
					background : '#E3E6ED' // 헤더랑 똑같이 → 색 안 바뀌는 것처럼 보임
				},
				selected : { // 선택된 셀 색
					background : '#ffffff' // 필요하면 여기도 조정
				}
			}
		});
		const ChurnData = allList.filter(row => row.salesChange === "이탈");
		// Grid 생성
		const Churngrid = new tui.Grid({
			el : document.getElementById('Churngrid'),
			data : ChurnData,
			scrollX : false,
			scrollY : false,
			minBodyHeight : 0,
			autoWidth : true,
			columns : [ {
				header : '기준유형',
				name : 'ty',
				sortable : 'true',
				align : 'center',
				width: 200
			}, {
				header : '휴면/이탈 타입',
				name : 'salesChange',
				sortable : 'true',
				align : 'center',
				hidden: true
			},{
				header : '기준값',
				name : 'stdrValue',
				editor : 'text',
				align : 'center',
				width: 200
			}, {
				header : '설명',
				name : 'stdrDc',
				editor : 'text'
			}, {
				header : '사용여부',
				name : 'yn',
				align : 'center',
				width: 200
			} ]
		});
		
		document.querySelectorAll('.btnSave').forEach(btn => {
		    btn.addEventListener('click', function () {
		        const type = this.dataset.type; // "dormancy" 또는 "churn"

		        // 두 그리드 모두 편집 종료
		        Dormancygrid.finishEditing();
		        Churngrid.finishEditing();

		        const DormancyModified = Dormancygrid.getModifiedRows();
		        const ChurnModified    = Churngrid.getModifiedRows();

		        const DormancyList = DormancyModified.updatedRows.concat(DormancyModified.createdRows);
		        const ChurnList    = ChurnModified.updatedRows.concat(ChurnModified.createdRows);

		        fetch('/churnRiskStdrRegister/update', {
		            method: 'POST',
		            headers: { 'Content-Type': 'application/json' },
		            body: JSON.stringify({
		                dormancyList: DormancyList,
		                churnList: ChurnList
		            })
		        })
		        .then(res => res.text())
		        .then(msg => {
		            // 눌린 버튼 타입에 따라 메시지만 다르게
		            if (type === 'dormancy') {
		                alert('휴면 기준 저장되었습니다.');
		            } else if (type === 'churn') {
		                alert('이탈 기준 저장되었습니다.');
		            } else {
		                alert('저장되었습니다.');
		            }
		        })
		        .catch(err => console.error(err));
		    });
		});

			
	</script>
</body>
</html>