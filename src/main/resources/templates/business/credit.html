
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout}">
<head>
<meta charset="UTF-8">
<script src="/assets/js/teamUtil.js"></script>
<title>여신 관리</title>
<style type="text/css">
/* 그리드 버튼 스타일 */
.grid-btn {
    padding: 4px 10px;
    border: 1px solid #bbb;
    background-color: #fff;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
}
.grid-btn:hover {
    background-color: #eee;
}
</style>
</head>

<body layout:fragment="content">
	<div class="lock-account-wrapper">

		<!-- 여신 조회 -->
		<div class="row mb-3">
			<div class="col-md-12">
				<div class="card">

					<!-- 카드 헤더 : 제목 + 초기화/조회 버튼 -->
					<div class="card-header with-actions">
						<div class="card-header-left">
							<h5 class="card-title">검색 조건</h5>
						</div>
						<div class="card-header-right">
							<button type="button" class="btn btn-dark" id="creditInit">초기화</button>
							<button type="button" class="btn btn-outline-dark" id="searchCredit">조회</button>
						</div>
					</div>

					<!-- /card-body start -->
					<div class="card-body">
						<div class="row">
							<div class="col-md-4">
							<label for="autoCustcomId" class="form-label">고객사코드</label>

								<!-- [자동완성][추가] 고객사Id input + 추천 목록을 함께 감싸는 래퍼 -->
								<div class="position-relative">
									<!-- [자동완성][기존 input에 autocomplete="off"만 추가] -->
									<input id="autoCustcomId" type="text" class="form-control" placeholder="고객사코드를 입력해주세요" autocomplete="off">
									<!-- 브라우저 기본 자동완성 끄기 -->

									<!-- [자동완성][추가] 사용자Id 자동완성 후보 리스트 -->
									<ul id="autoCustcomIdSuggest" class="list-group position-absolute w-100" style="z-index: 2000;">
										<!-- JS에서 <li> 항목이 동적으로 추가됨 -->
									</ul>
								</div>
				            </div>
				            
							<div class="col-md-4">
								<label for="autoCustcomName" class="form-label">고객사명</label>

								<!-- [자동완성][추가] 고객사명 input + 추천 목록을 함께 감싸는 래퍼 -->
								<div class="position-relative">
									<!-- [자동완성][기존 input에 autocomplete="off"만 추가] -->
									<input id="autoCustcomName" type="text" class="form-control" placeholder="고객사명을 입력해주세요" autocomplete="off">
									<!-- 브라우저 기본 자동완성 끄기 -->

									<!-- [자동완성][추가] 고객사명 자동완성 후보 리스트 -->
									<ul id="autoCustcomNameSuggest" class="list-group position-absolute w-100" style="z-index: 2000;">
										<!-- JS에서 <li> 항목이 동적으로 추가됨 -->
									</ul>
								</div>
				            </div>
						</div><!-- row end -->
							
						</div>
					</div>
					<!-- /card-body end -->
				</div>
			</div>
		</div>

		<!-- 여신한도 카드 -->
		<div class="row">
			<div class="col-md-12 d-flex">
				<div class="card w-100 h-100">

					<!-- 카드 헤더 : 제목 + 잠금 해제 버튼 -->
					<div class="card-header with-actions">
						<div class="card-header-left">
							<h5 class="card-title">여신한도설정</h5>
						</div>
						<div class="card-header-right">
							<button type="button" class="btn btn-dark" id="limitInit">초기화</button>
							<button type="button" class="btn btn-outline-dark" id="limitSave">저장</button>
						</div>

					</div>

					<div class="card-body">
						<div class="creditGridWrap">
							<div id="creditGrid"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
		


<div th:replace="business/modal/creditCustModal :: creditModal"></div>

<script>
    // 1. Toast UI Grid 테마
tui.Grid.applyTheme('default', {
  cell: {
    normal: {
      border: '#dedede',
      background: '#ffffff',
      showVerticalBorder: true
    },
    header: {
      border: '#dedede',
      background: '#f5f5f5',
      showVerticalBorder: true
    },
    // ✅ rowHeader는 기본 흰색으로 두기 (헤더/바디 공통)
    rowHeader: {
      border: '#dedede',
      background: '#ffffff',
      showVerticalBorder: true
    },
    editable: {
      background: '#FFFDF0',
      text: '#000'
    },
    selectedHeader: {
      background: '#f5f5f5'
    },
    selected: {
      background: '#ffffff'
    }
  }
});



    // 2. 더미 데이터
    const creditData = [];

    // 3. Grid 공통 옵션
    const businessGridOptions = {
        bodyHeight: 260,
        scrollX: true,
        scrollY: true,
        rowHeaders: [],// 좌측 체크박스
        rowHeight: 40,
        columnOptions: {
            minWidth: 80,
            resizable: true
        }
    };

    // 4. 여신한도 목록 Grid 생성
    const creditGrid = new tui.Grid({
        el: document.getElementById('creditGrid'),
        data: creditData,
        ...businessGridOptions,
        columns: [
            { header: '고객코드', name: 'custcomId', width: 140 },
            { header: '고객사', name: 'custcomName', width: 180 },
            {
           	  header: '고객사상세조회',
           	  name: 'clientSelect',
           	  width: 120,
           	  align: 'center',
	          formatter: ({ rowKey, row }) => {   // ← rowKey 같이 받기
	              const label = row.custcomNameResult || '고객사조회';
	              return `
	                <button type="button"
	                        class="grid-btn open-client-modal-btn"
	                        data-row-key="${rowKey}">
	                  ${label}
	                </button>
	              `;
           	  }
           	},
            { header: '신용등급', name: 'creditGrad', width: 120 },
            { header: '여신체크', name: 'cdtlnCheck', width: 120 },
            { header: '담보한도', name: 'mrtggLmt', width: 180 },
            { header: '신용한도', name: 'creditLmt', width: 180 },
            { header: '여신한도', name: 'cdtlnLmt', width: 180 },
            { header: '한도초과여부', name: 'lmtoverCheck', width: 110 },
        ]
    });

 	// 5-1 초기화버튼
    document.getElementById("creditInit").addEventListener("click", function () {

        // 1) searchForm 객체 초기화
        const searchForm = {
            custcomId: "",
            custcomName: "",
        };

        // 2) 화면 Input 값 초기화
        document.querySelector("#autoCustcomId").value = "";
        document.querySelector("#autoCustcomName").value = "";

        console.log("검색조건 초기화:", searchForm);
    });

	// 5-2 조회버튼 (jQuery 버전)
	$(document).on("click", "#searchCredit", function () {

	    // 1) 화면 입력값 → searchForm 에 세팅
	    let searchForm = {
	    		custcomId: $("#autoCustcomId").val().trim(),
	    		custcomName: $("#autoCustcomName").val().trim(),
	    };

	    console.log("보낼 searchForm >>> ", searchForm);

	    // 2) AJAX 요청
	    $.ajax({
	        url: "/credit/list",
	        type: "POST",
	        contentType: "application/json",
	        data: JSON.stringify(searchForm),
	        success: function (res) {
	            console.log("조회결과 >>> ", res);

	            // 3) 그리드 데이터 반영
	            creditGrid.resetData(res);
	        },
	        error: function (err) {
	            console.error("조회 중 오류:", err);
	        }
	    });
	});   

    
    

	// 5-3. 고객코드 자동완성
	if (window.TeamCommon && TeamCommon.autocomplete && typeof TeamCommon.autocomplete.init === 'function') {
     TeamCommon.autocomplete.init({
       inputSelector: '#autoCustcomId',
       listSelector: '#autoCustcomIdSuggest',
       url: '/credit/custcomIdSearch',
       paramName: 'keyword',
       minLength: 1,
       delay: 300,
       preventClose: true,
       mapResponse: item => ({
           id: item.customId,
           label: item.custcomId,      // 자동완성 목록에 실제로 보이는 값
           value: item.custcomId,      // input에 입력될 기본값
           name: item.custcomName      // 추가 저장된 고객사명
       }),
       onSelect: item => {
           $('#autoCustcomId').val(item.value);
           $('#autoCustcomName').val(item.name);
       }
     });
   } else {
     console.warn('TeamCommon.autocomplete.init 을 찾을 수 없습니다. teamUtil.js / autocomplete 유틸 로딩 확인');
   }
   // 5-4 고객사명 자동완성
   if (window.TeamCommon && TeamCommon.autocomplete && typeof TeamCommon.autocomplete.init === 'function') {
     TeamCommon.autocomplete.init({
       inputSelector: '#autoCustcomName',
       listSelector: '#autoCustcomNameSuggest',
       url: '/credit/custcomNameSearch',
       paramName: 'keyword',
       minLength: 1,
       delay: 300,
       preventClose: true,
       mapResponse: item => ({
           id: item.custcomId,
           label: item.custcomName,
           value: item.custcomName
       }),
       onSelect: item => {
           $('#autoCustcomName').val(item.value);
           $('#autoCustcomId').val(item.id);
       }
     });
   } else {
     console.warn('TeamCommon.autocomplete.init 을 찾을 수 없습니다. teamUtil.js / autocomplete 유틸 로딩 확인');
   }
   


	// 6.고객사정보 모달
		const modal   = document.getElementById("creditModal");
		const back    = document.getElementById("creditBackdrop");
		
		function openCreditModal() {
			modal.classList.add("show");
			modal.style.display = "block";
			back.style.display = "block";
			
		}
		
		function closeCreditModal() {
			modal.classList.remove("show");
			modal.style.display = "none";
			back.style.display = "none";
		}
		
		// 바깥 클릭 시 닫기
		modal.addEventListener("click", (event) => {
			if (!event.target.closest(".modal-content")) {
			  closeCreditModal();
			}
		});
		
		document.addEventListener('click', (e) => {

		  if (e.target.classList.contains('open-client-modal-btn')) {

		    const cell = creditGrid.getFocusedCell();
		    const row = cell ? creditGrid.getRow(cell.rowKey) : null;
		    if (!row) return;

		    // 바깥 버튼과 동일하게 모달 열기
		    openCreditModal();
		  }
		}); // end 모달
	   


</script>
</body>
</html>