<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout}">
<head>
<meta charset="UTF-8">
<title>견적서 관리</title>
<style>
.ui-autocomplete {
  z-index: 9999 !important;
}
.approve-btn,
.reject-btn,
.order-btn {
  padding: 6px 8px;
  font-size: 14px;
  line-height: 1;
  min-width: 50px;
  border-radius: 4px;
}

/* 버튼 사이 간격 */
.approve-btn + .reject-btn {
  margin-left: 4px; 
}

/* 모달창 css  */
.compact-input .form-control,
.compact-input .icon-btn,
.compact-input .input-group-text {
  height: 32px !important;
  font-size: 0.85rem !important;
  padding: 4px 8px !important;
}

.compact-input .icon-btn {
  width: 34px !important;
  display: flex;
  align-items: center;
  justify-content: center;
}

.compact-input i {
  font-size: 15px !important;
}

/* Label size */
.form-label {
  font-size: 0.85rem;
  margin-bottom: 4px;
}

/* Grid spacing top */
#newEstiGrid {
  margin-top: 6px;
}

</style>

</head>
<body layout:fragment="content">
	<div class="esti-manage-wrapper">
		<!-- 견적 조회 카드 -->
		<div class="row mb-3">
			<div class="col-md-12">
				<div class="card">

					<!-- 카드 헤더 : 제목 + 초기화/조회 버튼 -->
					<div class="card-header">
						<div class="card-header-left">
							<h5 class="card-title">견적서 조회</h5>
						</div>
						<div class="card-header-right">
							<button type="button" class="btn btn-dark" id="btnReset">초기화</button>
							<button type="button" class="btn btn-outline-dark" id="btnSearch">조회</button>
						</div>
					</div>
					<!-- end card-header -->

					<div class="card-body">
						<div class="row g-2">
							<div class="col-md-3">
								<label for="custcomName" class="form-label">고객사 명</label> <input
									id="custcomName" type="text" class="form-control"
									placeholder="YEDAM">
							</div>
							
							<div class="col-1"></div>

							<div class="col-md-6">
								<label class="form-label">납기일</label>
								<div class="d-flex align-items-center js-date-range">

									<!-- 시작일 -->
									<div class="input-group date">
										<input type="text"
											class="form-control datepicker js-date-range-start"
											placeholder="시작일"> <span
											class="input-group-text js-date-range-icon-start"> <i
											class="bi bi-calendar"></i>
										</span>
									</div>

									<span class="mx-1 fw-bold fs-5">~</span>

									<!-- 종료일 -->
									<div class="input-group date ms-2">
										<input type="text"
											class="form-control datepicker js-date-range-end"
											placeholder="종료일"> <span
											class="input-group-text js-date-range-icon-end"> <i
											class="bi bi-calendar"></i>
										</span>
									</div>

								</div>
							</div>

						</div>
					</div>
					<!-- card-body -->
				</div>
				<!-- end card -->
			</div>
		</div>
		<!-- end row -->

		<!-- 견적서목록 카드 -->
		<div class="row">

			<!-- 견적서목록 그리드 -->
			<div class="col-md-12 d-flex">
				<div class="card w-100 h-100">

					<!-- 카드 헤더 : 제목 + 잠금 해제 버튼 -->
					<div class="card-header with-actions">
						<div class="card-header-left">
							<h5 class="card-title">견적서 목록</h5>
						</div>
						<div class="card-header-right">
							<button type="button" class="btn btn-outline-dark" id="newEstiBtn">신규</button>
						</div>
					</div>

					<div class="card-body">
						<div class="estiGridWrap">
							<div id="estiGrid"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- end 견적서목록 카드 -->
	</div>
	<!-- end esti-manage-wrapper -->


<div th:replace="business/modal/newEstiModal :: newEstiModal"></div>


<script>
	// 0. 데이터
	const estiData = [];
	let searchForm = {
		    custcomName: "",
		    dueStart: "",
		    dueEnd: ""
	};

	// 1-1. Grid 공통 옵션
	const estiGridOptions = {
	    bodyHeight: 340,
	    scrollX: true,
	    scrollY: true,  // 세로
	    /* rowHeaders: ['checkbox'],     // 좌측 체크박스 */
	    columnOptions: {
	        minWidth: 80,
	        resizable: true
	    }
	}; // 1-1. 끝

	// 1-2. 견적서 목록 그리드 생성
	const estiGrid = new tui.Grid({
		el: document.getElementById('estiGrid'),
		data: estiData,
		...estiGridOptions,
		columns: [
			{ header: '견적서코드', name: 'estiId' },
			{ header: '버전', name: 'version' },
			{ header: '고객사명', name: 'custcomNameResult' },
			{ header: '여신한도', name: 'cdtlnLmt', align: 'right' },
			{ header: '금액합계(원)', name: 'totalAmount', align: 'right'  },
			{ header: '상품명', name: 'productName' },
			{ header: '납기일', name: 'dueDt', align: 'right'  },
			{
			    header: '승인 / 반려',
			    name: 'apRj',
			    align: 'center',
			    formatter: ({ row }) => {
			    	if (row.estiSt === 'es1') {
		    	      return `
		    	        <button class="btn btn-success approve-btn" data-id="${row.estiId}">승인</button>
		    	        <button class="btn btn-danger reject-btn" data-id="${row.estiId}">반려</button>
		    	      `;
		    	    }

		    	    if (row.estiSt === 'es2') {
		    	      return `
		    	        <button class="btn btn-primary order-btn" data-id="${row.estiId}">주문서 등록</button>
		    	      `;
		    	    }
		    	    
		    	    if (row.estiSt === 'es3') {
		    	      return `
		    	        <button class="btn btn-success approve-btn" disabled style="opacity:0.5; cursor:not-allowed;">승인</button>
		    	        <button class="btn btn-danger reject-btn" disabled style="opacity:0.5; cursor:not-allowed;">반려</button>
		    	      `;
		    	    }
		    	    
		    	    return "";
			    }
	    	},
			{ 
	    		header: '상태', 
	    		name: 'estiStNm', 
	    		align: 'center',
	    		formatter: ({ row }) => {
	    		    // 반려일 경우 비고도 보여줌
	    		    if (row.estiSt === 'es3') {
	    		      return `
	    		        <div style="line-height:1.2;">
	    		          <div>${row.estiStNm}</div>              <!-- 반려 -->
	    		          <div style="color:#dc3545; font-size:12px;">${row.recallResn || ''}</div>
	    		        </div>
	    		      `;
	    		    }
	    		  return row.estiStNm;   // 승인/대기 등은 원래 그대로
    		    } 
			},
		]
	}); // 1-2. 견적서목록 그리드 생성 끝
	
	// 2. 버튼 이벤트
	// 2-1. 초기화 버튼 이벤트
	document.getElementById("btnReset").addEventListener("click", function () {
	
	    // 1) searchForm 객체 초기화
	    searchForm = {
	        custcomName: "",
	        dueStart: "",
	        dueEnd: ""
	    };
	
	    // 2) 화면 Input 값 초기화
	    document.querySelector("#custcomName").value = "";
	    document.querySelector(".js-date-range-start").value = "";
	    document.querySelector(".js-date-range-end").value = "";
	
	    // datepicker 를 쓰는 경우 UI 리프레시
	    $('.js-date-range-start').datepicker('update', '');
	    $('.js-date-range-end').datepicker('update', '');
	
	    console.log("검색조건 초기화:", searchForm);
	});
	
	// 2-2. 조회 버튼 이벤트
	document.getElementById("btnSearch").addEventListener("click", function () {
	
	    // 1) 화면 입력값 → searchForm 에 세팅
	    searchForm.custcomName = document.querySelector("#custcomName").value.trim();
	    searchForm.dueStart = document.querySelector(".js-date-range-start").value;
	    searchForm.dueEnd = document.querySelector(".js-date-range-end").value;
	
	    console.log("보낼 searchForm >>> ", searchForm);
	
	    // 2) 백엔드 조회 요청 (POST /esti/list)
	    axios.post("/esti/list", searchForm)
	        .then(res => {
	            console.log("조회결과 >>> ", res.data);
	
	            // 3) 그리드 데이터 반영
	            estiGrid.resetData(res.data);
	        })
	        .catch(err => console.error("조회 중 오류:", err));
	});
	
	
	
	// 2-3. 승인 버튼 이벤트
	$(document).on('click', '.approve-btn', function () {
	
	  const estiId = $(this).data('id');   // data-id
	  const row = estiGrid.getData().find(r => r.estiId == estiId);  // rowKey = estiId 가정
	
	  if (!row) {
	    console.warn('행을 찾을 수 없습니다. estiId =', estiId);
	    return;
	  }
	
	  const limit = Number(row.cdtlnLmt ?? 0);      // 여신한도
	  const total = Number(row.totalAmount ?? 0);  // 금액합계
	  const version = row.version;
	
	  if (limit < total) {
	    const confirmed = confirm("여신한도가 부족합니다.\n그래도 승인하시겠습니까?");
	    if (!confirmed) return;
	  }
	
	  // jQuery AJAX로 상태 업데이트 호출
	  $.ajax({
	    url: '/esti/updateStatus',
	    method: 'POST',
	    contentType: 'application/json',
	    data: JSON.stringify({
	      estiId: estiId,
	      version: version,
	      estiSt: 'es2'   // 승인 코드
	    })
	  })
	  .done(function () {
	    alert('승인 처리되었습니다.');
	    // 그리드 상태 갱신
	    const rowKey = row.rowKey ?? estiId;
	    estiGrid.setValue(rowKey, 'estiSt', 'es2');
	    estiGrid.setValue(rowKey, 'estiStNm', '승인');
	  })
	  .fail(function () {
    	alert('승인 처리 중 오류가 발생했습니다.');
	  });
	}); // 2-3 승인 버튼 이벤트 끝
	
	
	
	// 2-4. 반려 버튼 이벤트
	$(document).on('click', '.reject-btn', function () {
	
	  const estiId = $(this).data('id');
	  const row = estiGrid.getData().find(r => r.estiId == estiId);
	
	  if (!row) return;
	
	  // 반려 사유 입력
	  const reason = prompt("반려 사유를 입력하세요:");
	  if (!reason) return;
	
	  $.ajax({
	    url: '/esti/updateStatus',
	    method: 'POST',
	    contentType: 'application/json',
	    data: JSON.stringify({
	      estiId: estiId,
	      estiSt: 'es3',
	      version: row.version,     // ★ version 포함해야 함
	      recallResn: reason        // ★ 반려 사유 필드
	    })
	  })
	  .done(function () {
	    alert('반려 처리되었습니다.');
	
	    // 그리드 즉시 갱신
	    estiGrid.setValue(row.rowKey ?? estiId, 'estiSt', 'es3');
	    estiGrid.setValue(row.rowKey ?? estiId, 'estiStNm', '반려');
	    estiGrid.setValue(row.rowKey ?? estiId, 'recallResn', reason);
	  })
	  .fail(function (xhr) {
	    console.error(xhr);
	    alert('반려 처리 중 오류가 발생했습니다.');
	  });
	  
	  /* console.log("row.rowKey : ", row.rowKey); */
	}); // 2-4. 반려 버튼 이벤트 끝

	
	
// 모달 내부 상품명 auto complete
class ProductAutoComplete {
  constructor(props) {
    const el = document.createElement('input');
    el.type = 'text';
    el.className = 'tui-grid-content-input';
    el.value = props.value;

    // autocomplete 설정
    $(el).autocomplete({
      minLength: 1,
      source: function(request, response) {
        $.ajax({
          url: '/esti/productSearch',
          data: { keyword: request.term },
          success: function(data) {
        	  response(data.map(item => ({
        	        label: item.productName,
        	        value: item.productName,
        	        productId: item.productId,
        	        basisSaleAmt: item.basisSaleAmt
       	      })));
          },
        });
      },

      // 사용자가 선택했을 때 실행
      select: function(event, ui) {
        const grid = window.newEstiGrid;
        const rowKey = props.rowKey;

        // 현재 행 데이터 변경
        grid.setValue(rowKey, 'productName', ui.item.value);
        grid.setValue(rowKey, 'basisSaleAmt', ui.item.basisSaleAmt);  // 판매단가 자동 세팅
      }
    });

    this.el = el;
  }

  getElement() {
    return this.el;
  }

  getValue() {
    return this.el.value;
  }

  mounted() {
    this.el.focus();
  }
}
	
	
// ---------------------------- 신규 견적서 모달 스크립트
	//1. 그리드 생성
	window.newEstiGrid = null;

	function loadNewEstiGrid(data = []) {
	  if (window.newEstiGrid) {
	    window.newEstiGrid.resetData(data);
	    return;
	  }
	
	  window.newEstiGrid = new tui.Grid({
	    el: document.getElementById('newEstiGrid'),
	    scrollX: true,
	    scrollY: true,
	    bodyHeight: 350,
	    columnOptions: {
	        resizable: false,   // 컬럼 리사이즈 가능
	        minWidth: 80      // 기본 최소 폭
	    },
	    rowHeaders: ['checkbox'],
	    columns: [
    	  {
    	    header: '상품명*',
    	    name: 'productName',
    	    width: 200,
    	    editor: {
    	      type: ProductAutoComplete
    	    }
    	  },
	      { header: '수량*', 
	    	  name: 'qy',  
	    	  width: 90,
	    	  editor: {
	    	      type: 'text',
	    	      options: {
	    	          inputType: 'number'
	    	      }
	    	  }},
	      { header: '판매단가', name: 'basisSaleAmt',  width: 180, align:'right' },
	      { header: '할인율(%)', name: 'dcRate',  width: 90, align:'right' },
	      { header: '할인금액', name: 'saleAmt',  width: 180, align:'right' },
	      { 
	    	  header: '최종금액', 
	    	  name: 'finalAmt',  
	    	  width: 222, 
	    	  align:'right',
	    	  whiteSpace: 'normal',     // 줄바꿈 가능
	    	  formatter({ value }) {
	    	    return value ? value.toLocaleString() : '';
	    	  }
	      },
	    ]
	  });
	  
	  window.newEstiGrid.on('afterChange', (ev) => {
	      ev.changes.forEach(change => {
	          const rowKey = change.rowKey;

	          const qty = window.newEstiGrid.getValue(rowKey, 'qy');
	          const price = window.newEstiGrid.getValue(rowKey, 'basisSaleAmt');

	          if (qty && price) {
	            const total = qty * price;
	            window.newEstiGrid.setValue(rowKey, 'finalAmt', total);
	          }
	      });
	  });
	  
	}
	
	
	
	
// -------------------------------- 모달오픈 버튼이벤트
	// 신규 버튼 클릭 이벤트
	$(document).on("click", "#newEstiBtn", function () {
	  openNewEstiModal();
	});


    // 1-1 신규 견적서 모달
	const openBtn = document.getElementById("newEstiBtn");
	const modal   = document.getElementById("newEstiModal");
	const back    = document.getElementById("newEstiBackdrop");
	
	function openNewEstiModal() {
		modal.classList.add("show");
		modal.style.display = "block";
		back.style.display = "block";
		
		if (!window.newEstiGrid) {
		  loadNewEstiGrid();
		} else {
		  window.newEstiGrid.refreshLayout();
		}
	}
	
	function closeNewEstiModal() {
		modal.classList.remove("show");
		modal.style.display = "none";
		back.style.display = "none";
	}
	
	// 바깥 클릭 시 닫기
	modal.addEventListener("click", (event) => {
		if (!event.target.closest(".modal-content")) {
		  closeNewEstiModal();
		}
	});

// end 신규 견적서 모달

	// 2. 모달 행추가 버튼 이벤트
	$('#addRowBtn').on('click', function () {
	    
	    // 신규 행 기본값
	    const newRow = {
	        productName: '',
	        qy: '',
	        unit: '',
	        basisSaleAmt: '',
	        discountAmt: '',
	        finalAmt: ''
	    };
	
	    // 그리드에 행 추가 (맨 마지막에 추가)
	    window.newEstiGrid.appendRow(newRow, { at: 0 });
	
	});
	
	// 3. 모달 행삭제 버튼 이벤트
	$('#deleteRowBtn').on('click', function () {
	    const rowKeys = window.newEstiGrid.getCheckedRowKeys();   // 체크된 row key 목록
	
	    if (rowKeys.length === 0) {
	        alert("삭제할 행을 선택해주세요.");
	        return;
	    }
	
	    // 선택된 row 제거
	    window.newEstiGrid.removeRows(rowKeys);
	});
	
</script>

</body>
</html>