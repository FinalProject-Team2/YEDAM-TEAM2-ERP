<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout}">
<head>
<meta charset="UTF-8">
<!-- <link rel="stylesheet"
	href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script> -->

<title>출하관리</title>
<style>
.form-select {
	color: #000 !important;
}
</style>
</head>
<body layout:fragment="content">
	<div class="row">
		<!-- 검색조건 -->
		<div class="col-md-12">
			<div class="card mb-3">
				<div class="card-header">
					<h5 class="card-title">검색조건</h5>
					<div class="card-header-right">
					    <button type="button" class="btn btn-dark" id="btnReset">초기화</button>
						<button class="btn btn-outline-dark" id="searchBtn">조회</button>
					</div>
				</div>
				<div class="card-body">
					<div class="row">
						<div class="col-md-2">
							<label for="custcomId" class="form-label">고객코드</label> 
							<input id="custcomId" type="text" class="form-control"  placeholder="고객사코드를 입력해주세요" >
						
						</div>
						<div class="col-md-3">
							<label for="custcomName" class="form-label">고객사명</label>
							<input id="custcomName" type="text" class="form-control" placeholder="고객사명을 입력해주세요" >
						</div>
						<div class="col-md-2">
							<label for="nm" class="form-label">작업자</label>
							<input id="nm" type="text" class="form-control" placeholder="작업자를 입력해주세요" >
						</div>
						<div class="col-md-4">
								<label class="form-label">출하요청일</label>
								<div class="d-flex align-items-center js-date-range">

									<!-- 시작일 -->
									<div class="input-group date">
										<input type="text" class="form-control datepicker js-date-range-start" placeholder="시작일">
										<span class="input-group-text js-date-range-icon-start">
										<i class="bi bi-calendar"></i>
										</span>
									</div>

									<span class="mx-1 fw-bold fs-5">~</span>

									<!-- 종료일 -->
									<div class="input-group date ms-2">
										<input type="text" class="form-control datepicker js-date-range-end" placeholder="종료일">
										<span class="input-group-text js-date-range-icon-end">
										<i class="bi bi-calendar"></i>
										</span>
									</div>

								</div>
							</div>
					</div>
				</div>
			</div>

			<!-- 사원목록 -->
			<div class="card">
				<div class="card-header">
					<h5 class="card-title">출하목록</h5>
					<div class="card-header-right">

						<!-- <button id="addRowBtn" class="btn btn-outline-dark">행추가</button> -->
						<!-- <div th:replace="~{fragments/buttons :: addRowButton('MENU_SALES_009', 'addRowBtn')}"></div> -->
						<!-- <button type="button" class="btn btn-dark">반려</button> -->
						<!-- 반려의 id 값 : rejBtn -->
						<div th:replace="~{fragments/buttons :: rejButton('MENU_SALES_009', 'rejBtn')}"></div>
						<!-- <button class="btn btn-outline-dark" id="openRciptTretModal">출하처리</button> -->
						<div th:replace="~{fragments/buttons :: tretButton('MENU_SALES_009', 'openRciptTretModal')}"></div>
					</div>
				</div>
				<div class="card-body">
					<div id="oustGrid"></div>
				</div>
			</div>
		</div>
	</div>
	<!--<div th:replace="business/modal/rciptTretModal :: rciptTretModal"></div>
	<div th:replace="business/modal/delayModal :: delayModal"></div>
	-->
	
	
<script>
//숫자 변환 유틸 (기존 그대로 사용)
function toNumber(val) {
  if (val === null || val === undefined) return 0;
  const str = String(val).replace(/,/g, '').trim();
  if (str === '') return 0;
  return Number(str) || 0;
}

// 전역
const searchForm = {
    custcomId: "",
    custcomName: "",
    nm: "",
    dueStart: "",
    dueEnd: ""
};

// 그리드 데이터
    const oustData = [];
    	
    	
// Grid 생성
        const oustGrid = new tui.Grid({
            el: document.getElementById('oustGrid'),
            data: oustData,
            rowHeaders: ['checkbox'],
            scrollX: true,
            scrollY: true,
            bodyHeight: 400,
            autoWidth: true,
            columns: [
            	  { header: '출하지시ID', name: 'oustId', align: 'center' },
            	  { header: '고객사', name: 'custcomName', align: 'center' },
            	  { header: '담당자', name: 'psch', align: 'center'  },
            	  { header: '담당자연락처', name: 'pschTel', align: 'right'  },
            	  { header: '출하완료일', name: 'shipmntDt', align: 'right' },
            	  { header: '출하요청일', name: 'oustRequestDt', align: 'right' },
            	  { header: '상품명', name: 'productName' },
            	  { header: '금액합계(원)', name: 'ttPrice', align: 'right',
      				formatter: ({ value }) => {
                        const num = toNumber(value);
                        return num ? num.toLocaleString() : '';
                    }
      			  },
            	  //{ header: '작업자', name: 'empId' },
             	  //{ header: '주문수량(EA)', name: 'ttSoQy' }, 
            	  { header: '출하상태', name: 'shipmntSt', width: 120, align: 'center' }, 
            	]
        });


// =================================== 버튼 이벤트
	// 1. 초기화버튼 이벤트
	document.getElementById("btnReset").addEventListener("click", function () {
	
	    // 화면 Input 값 초기화
	    document.querySelector("#custcomId").value = "";
	    document.querySelector("#custcomName").value = "";
	    document.querySelector("#nm").value = "";
	    document.querySelector(".js-date-range-start").value = "";
	    document.querySelector(".js-date-range-end").value = "";
	
	    // datepicker 를 쓰는 경우 UI 리프레시
	    $('.js-date-range-start').datepicker('update', '');
	    $('.js-date-range-end').datepicker('update', '');
	
    console.log("검색조건 초기화:", searchForm);
});

// 2-2. 조회 버튼 이벤트
document.getElementById("searchBtn").addEventListener("click", function () {

    // 1) 화면 입력값 → searchForm 에 세팅
    searchForm.custcomId = document.querySelector("#custcomId").value.trim();
    searchForm.custcomName = document.querySelector("#custcomName").value.trim();
    searchForm.nm = document.querySelector("#nm").value.trim();
    searchForm.dueStart = document.querySelector(".js-date-range-start").value;
    searchForm.dueEnd = document.querySelector(".js-date-range-end").value;


    // 2) 백엔드 조회 요청 
    axios.post("/shipment/list", searchForm)
        .then(res => {
            console.log("조회결과 >>> ", res.data);

            // 3) 그리드 데이터 반영
            oustGrid.resetData(res.data);
        })
        .catch(err => console.error("조회 중 오류:", err));
});


//================================================================== <출하처리 버튼 이벤트>

document.getElementById("openRciptTretModal").addEventListener("click", function () {

    const checkedRows = oustGrid.getCheckedRows();

    if (checkedRows.length === 0) {
        alert("출하처리할 항목을 선택하세요.");
        return;
    }

    // oustId 배열 추출
    const oustIds = checkedRows.map(row => row.oustId);

    axios.post("/shipment/complete", oustIds, {
    	  headers: { "Content-Type": "application/json" }
    	});


});

       
    </script>
</body>
</html>
