<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout}">
<head>
<meta charset="UTF-8">
<title>주문서 관리</title>
</head>
<body layout:fragment="content">
	<div class="so-manage-wrapper">
		<!-- 견주문 조회 카드 -->
		<div class="row mb-3">
			<div class="col-md-12">
				<div class="card">

					<!-- 카드 헤더 : 제목 + 초기화/조회 버튼 -->
					<div class="card-header">
						<div class="card-header-left">
							<h5 class="card-title">주문서 조회</h5>
						</div>
						<div class="card-header-right">
							<button type="button" class="btn btn-dark" id="SearchInitBtn">초기화</button>
							<button type="button" class="btn btn-outline-dark" id="SearchBtn">조회</button>
						</div>
					</div>
					<!-- end card-header -->

					<div class="card-body">
						<div class="row g-2">
							<div class="col-md-3">
								<label for="custcomName" class="form-label">고객사 명</label>
								<input id="custcomName" type="text" class="form-control" placeholder="고객사 명 입력">
							</div>

							<div class="col-md-6">
								<label class="form-label">납기일</label>
								<div class="d-flex align-items-center js-date-range">

									<!-- 시작일 -->
									<div class="input-group date">
										<input type="text"
											class="form-control datepicker js-date-range-start"
											placeholder="시작일"> <span
											class="input-group-text js-date-range-icon-start"> <i
											class="bi bi-calendar"></i>
										</span>
									</div>

									<span class="mx-1 fw-bold fs-5">~</span>

									<!-- 종료일 -->
									<div class="input-group date ms-2">
										<input type="text"
											class="form-control datepicker js-date-range-end"
											placeholder="종료일"> <span
											class="input-group-text js-date-range-icon-end"> <i
											class="bi bi-calendar"></i>
										</span>
									</div>

								</div>
							</div>

						</div>
					</div>
					<!-- card-body -->
				</div>
				<!-- end card -->
			</div>
		</div>
		<!-- end row -->

		<!-- 주문서목록 카드 -->
		<div class="row">

			<!-- 주문서목록 그리드 -->
			<div class="col-md-12 d-flex">
				<div class="card w-100 h-100">

					<!-- 카드 헤더 : 제목 + 잠금 해제 버튼 -->
					<div class="card-header with-actions">
						<div class="card-header-left">
							<h5 class="card-title">주문서 목록</h5>
						</div>
						<div class="card-header-right">
							<button type="button" class="btn btn-outline-dark" id="insertSoBtn">승인</button>
							<button type="button" class="btn btn-outline-dark" id="insertSoBtn">보류</button>
							<button type="button" class="btn btn-danger" id="deleteRowBtn">삭제</button>
						</div>
					</div>

					<div class="card-body">
						<div class="soGridWrap">
							<div id="soGrid"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- end 주문서목록 카드 -->
	</div>
	<!-- end so-manage-wrapper -->

	<script>
	// 0. 데이터
	const soData = [];
	const loadedSoSet = new Set();  // 어떤 so_id 의 상세를 이미 불러왔는지 체크용

	// 1-1. Grid 공통 옵션
	const soGridOptions = {
	    bodyHeight: 340,
	    scrollX: true,
	    scrollY: true,  // 세로
	    rowHeaders: ['checkbox'],     // 좌측 체크박스
	    columnOptions: {
	        minWidth: 80,
	        resizable: true
	    }
	}; // 1-1. 끝

	// 1-2. 주문서 목록 그리드 생성
	const soGrid = new tui.Grid({
		el: document.getElementById('soGrid'),
		data: soData,
		...soGridOptions,
		treeColumnOptions: {
		  name: 'productName',        // 이 컬럼에 펼침/접기 아이콘 표시
		  useIcon: true
		},
		columns: [
			{ header: '주문서코드', name: 'soId' },
			{ header: '고객사명', name: 'custcomName' },
			{ header: '담당자', name: 'psch' },
			{ header: '연락처', name: 'pschTel' },
			{ header: '납기일', name: 'dueDt' },
			{ header: '상품명', name: 'productName' },
			{ header: '금액합계(원)', name: 'ttSupplyAmt' },
			{ header: '총주문수량', name: 'ttSoQy' },
			{ header: '재고수량', name: 'currStockQy' },
			{ header: '진행상태', name: 'progrsSt' },
		]	
	}); // 1-2. 주문서목록 그리드 생성 끝
	
	// expand 이벤트에서 상품별 상세 + 재고를 동적으로 추가
	soGrid.on('expand', function (ev) {
	  const rowKey = ev.rowKey;
	  const row    = soGrid.getRow(rowKey);
	  if (!row) return;
	
	  const soId = row.soId;
	
	  // 이미 한 번 로딩한 주문이면 다시 안 불러오기
	  if (loadedSoSet.has(soId)) {
	    return;
	  }
	
	  fetch(`/so/detailStock/${soId}`)
	    .then(res => {
	      if (!res.ok) {
	        return res.text().then(t => {
	          console.error('GET /so/detailStock 에러 >>> ', t);
	          throw new Error('server error');
	        });
	      }
	      return res.json();
	    })
	    .then(detailList => {
	      detailList.forEach(d => {
	        // 자식 행 추가
	        soGrid.appendRow(
	          {
	            rowType: 'detail',          // 나중에 formatter에서 구분할 때 쓰고 싶으면 추가
	            soId:    soId,              // 필요 없으면 빼도 됨
	            productId:    d.productId,
	            productName:  d.productName,
	            qy:           d.qy,
	            price:        d.price,
	            ttSupplyAmt:  d.supplyAmt,  // 자식 행에서는 "공급가액" 으로 사용
	            currStockQy:  d.currStockQy // 상품별 재고수량
	            // 다른 컬럼은 필요하다면 추가
	          },
	          { parentRowKey: rowKey }      // 이 행을 rowKey 의 자식으로 붙임
	        );
	      });
	
	      loadedSoSet.add(soId);
	    })
	    .catch(err => {
	      console.error(err);
	      alert('주문 상세를 불러오지 못했습니다.');
	    });
	});

	
	
	// ======================================================================== 2. 버튼 이벤트
	// 2-1. 초기화 버튼 이벤트
	document.getElementById("SearchInitBtn").addEventListener("click", function () {
	
	    // 1) searchForm 객체 초기화
	    searchForm = {
	        custcomName: "",
	        dueStart: "",
	        dueEnd: ""
	    };
	
	    // 2) 화면 Input 값 초기화
	    document.querySelector("#custcomName").value = "";
	    document.querySelector(".js-date-range-start").value = "";
	    document.querySelector(".js-date-range-end").value = "";
	
	    // datepicker 를 쓰는 경우 UI 리프레시
	    $('.js-date-range-start').datepicker('update', '');
	    $('.js-date-range-end').datepicker('update', '');
	
	    console.log("검색조건 초기화:", searchForm);
	});
	
	// 2-2. 조회 버튼 이벤트
	document.getElementById("SearchBtn").addEventListener("click", function () {
	
	    // 1) 화면 입력값 → searchForm 에 세팅
	    searchForm.custcomName = document.querySelector("#custcomName").value.trim();
	    searchForm.dueStart = document.querySelector(".js-date-range-start").value;
	    searchForm.dueEnd = document.querySelector(".js-date-range-end").value;
	
	    console.log("보낼 searchForm >>> ", searchForm);
	
	    // 2) 백엔드 조회 요청 (POST /esti/list)
	    axios.post("/esti/list", searchForm)
	        .then(res => {
	            console.log("조회결과 >>> ", res.data);
	
	            // 3) 그리드 데이터 반영
	            estiGrid.resetData(res.data);
	        })
	        .catch(err => console.error("조회 중 오류:", err));
	});
	
	
</script>

</body>
</html>