<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout}">
<head>
<meta charset="UTF-8">
<title>주문서 관리</title>
<style>
</style>
</head>
<body layout:fragment="content">
	<div class="so-manage-wrapper">
		<!-- 견주문 조회 카드 -->
		<div class="row mb-3">
			<div class="col-md-12">
				<div class="card">

					<!-- 카드 헤더 : 제목 + 초기화/조회 버튼 -->
					<div class="card-header">
						<div class="card-header-left">
							<h5 class="card-title">주문서 조회</h5>
						</div>
						<div class="card-header-right">
							<button type="button" class="btn btn-dark" id="SearchInitBtn">초기화</button>
							<button type="button" class="btn btn-outline-dark" id="SearchBtn">조회</button>
						</div>
					</div>
					<!-- end card-header -->

					<div class="card-body">
						<div class="row g-2">
							<div class="col-md-3">
								<label for="custcomName" class="form-label">고객사 명</label>
								<input id="custcomName" type="text" class="form-control" placeholder="고객사 명 입력">
							</div>

							<div class="col-md-6">
								<label class="form-label">납기일</label>
								<div class="d-flex align-items-center js-date-range">

									<!-- 시작일 -->
									<div class="input-group date">
										<input type="text"
											class="form-control datepicker js-date-range-start"
											placeholder="시작일"> <span
											class="input-group-text js-date-range-icon-start"> <i
											class="bi bi-calendar"></i>
										</span>
									</div>

									<span class="mx-1 fw-bold fs-5">~</span>

									<!-- 종료일 -->
									<div class="input-group date ms-2">
										<input type="text"
											class="form-control datepicker js-date-range-end"
											placeholder="종료일"> <span
											class="input-group-text js-date-range-icon-end"> <i
											class="bi bi-calendar"></i>
										</span>
									</div>

								</div>
							</div>

						</div>
					</div>
					<!-- card-body -->
				</div>
				<!-- end card -->
			</div>
		</div>
		<!-- end row -->

		<!-- 주문서목록 카드 -->
		<div class="row">

			<!-- 주문서목록 그리드 -->
			<div class="col-md-12 d-flex">
				<div class="card w-100 h-100">

					<!-- 카드 헤더 : 제목 + 잠금 해제 버튼 -->
					<div class="card-header with-actions">
						<div class="card-header-left">
							<h5 class="card-title">주문서 목록</h5>
						</div>
						<div class="card-header-right">
							<button type="button" class="btn btn-outline-dark" id="approveSoBtn">승인</button>
							<button type="button" class="btn btn-outline-dark" id="rejectSoBtn">보류</button>
							<button type="button" class="btn btn-danger" id="deleteSoBtn">주문취소</button>
						</div>
					</div>

					<div class="card-body">
						<div class="soGridWrap">
							<div id="soGrid"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- end 주문서목록 카드 -->
	</div>
	<!-- end so-manage-wrapper -->

<script>
	// 0. 데이터
	const soData = [];
	const loadedSoSet = new Set();  // 어떤 so_id 의 상세를 이미 불러왔는지 체크용
	let searchForm = {
		    custcomName: "",
		    dueStart: "",
		    dueEnd: ""
	};

	// 1-1. Grid 공통 옵션
	const soGridOptions = {
	    bodyHeight: 340,
	    scrollX: true,
	    scrollY: true,  // 세로
	    rowHeaders: ['checkbox'],     // 좌측 체크박스
	    columnOptions: {
	        minWidth: 80,
	        resizable: true
	    }
	}; // 1-1. 끝

	// 1-2. 주문서 목록 그리드 생성
	const soGrid = new tui.Grid({
		el: document.getElementById('soGrid'),
		data: soData,
		...soGridOptions,
		treeColumnOptions: {
		  name: 'productName',        // 이 컬럼에 펼침/접기 아이콘 표시
		  useIcon: true,
		  indentWidth: 20 // 들여쓰기 간격인데 확인하고 수정
		},
		columns: [
			{ header: '주문서코드', name: 'soId' },
			{ header: '고객사명', name: 'custcomName' },
			{ header: '담당자', name: 'psch' },
			{ header: '연락처', name: 'pschTel', align: 'right'  },
			{ header: '납기일', name: 'dueDt', align: 'right' },
			{ header: '상품명', name: 'productName', width: 250 },
			{ header: '금액합계(원)', name: 'ttSupplyAmt', align: 'right' },
			{ header: '총주문수량', name: 'ttSoQy', align: 'right' },
			{ header: '재고수량', name: 'currStockQy', align: 'right' },
			{ 
			  header: '진행상태',
			  name: 'codeNm',
			  ailgn: 'center',
			  formatter: ({ row }) => {
			      if (!row.codeNm) return '';
			      if (row.stResn) {
			          return `${row.codeNm}<br><span style="color:red">${row.stResn}</span>`;
			      }
			      return row.codeNm;
			  }
			},
			{ name: 'header', hidden: true },
			{ name: 'stResn', hidden: true },
			{ name: 'progrsSt', hidden: true },
			{ name: 'soDetailNo', hidden: true }
		]	
	}); // 1-2. 주문서목록 그리드 생성 끝
	
	
	
	// ======================================================================== 2. 버튼 이벤트
	// 2-1. 초기화 버튼 이벤트
	document.getElementById("SearchInitBtn").addEventListener("click", function () {
	
	    // 1) searchForm 객체 초기화
	    searchForm = {
	        custcomName: "",
	        dueStart: "",
	        dueEnd: ""
	    };
	
	    // 2) 화면 Input 값 초기화
	    document.querySelector("#custcomName").value = "";
	    document.querySelector(".js-date-range-start").value = "";
	    document.querySelector(".js-date-range-end").value = "";
	
	    // datepicker 를 쓰는 경우 UI 리프레시
	    $('.js-date-range-start').datepicker('update', '');
	    $('.js-date-range-end').datepicker('update', '');
	
	    console.log("검색조건 초기화:", searchForm);
	});
	
	// 2-2. 조회 버튼 이벤트
	document.getElementById("SearchBtn").addEventListener("click", function () {
	
	    // 1) 화면 입력값 → searchForm 에 세팅
	    searchForm.custcomName = document.querySelector("#custcomName").value.trim();
	    searchForm.dueStart = document.querySelector(".js-date-range-start").value;
	    searchForm.dueEnd = document.querySelector(".js-date-range-end").value;
	
	    console.log("보낼 searchForm >>> ", searchForm);
	
	    // 2) 백엔드 조회 요청 (POST /esti/list)
	    axios.post("/so/list", searchForm)
	    .then(res => {
	    	console.log("서버에서 받은 원본 데이터 >>> ", res.data);
	        const treeData = res.data.map(header => ({
	            ...header,
	            _children: header.detailList
	        }));
	        console.log("트리 구조로 만든 데이터 >>> ", treeData);
	        soGrid.resetData(treeData);
	        console.log("첫 번째 행 row 데이터 >>> ", soGrid.getRow(0));
	    });
	});
	
	
	
	// 2-3. 승인버튼 이벤트
	document.getElementById("approveSoBtn").addEventListener("click", () => {
	
	    // 1) 사용자 체크한 전체 row
	    const checkedRows = soGrid.getCheckedRows();
	
	    if (checkedRows.length === 0) {
	        alert("승인할 주문서를 선택해주세요.");
	        return;
	    }
	
	    // 2) 부모(row.header == 'h')만 필터링
	    const parentRows = checkedRows.filter(r => r.header === 'h');
	
	    if (parentRows.length === 0) {
	        alert("부모(주문서 헤더)만 승인할 수 있습니다.");
	        return;
	    }
	
	    // 3) 각 부모별 자식 재고 검사 수행
	    for (const parent of parentRows) {
	
	        // 해당 부모의 모든 자식 가져오기
	        const childRows = soGrid.getChildRows(parent.rowKey);
	
	        for (const child of childRows) {
	
	            // 재고 < 주문수량 → 승인 불가
	            if (child.currStockQy < child.ttSoQy) {
	                alert(
	                    `주문서 ${parent.soId} 승인 불가\n` +
	                    `상품명: ${child.productName}\n` +
	                    `재고(${child.currStockQy}) < 주문수량(${child.ttSoQy})`
	                );
	                return; // 승인 중단
	            }
	        }
	    }
	
	    // 4) 서버에 승인 요청 (부모만 보냄)
	    const payload = parentRows.map(p => ({
	        soId: p.soId
	    }));
	
	    fetch("/so/approve", {
	        method: "POST",
	        headers: {"Content-Type": "application/json"},
	        body: JSON.stringify(payload)
	    })
	    .then(r => r.json())
	    .then(res => {
	        if (res.success) {
	            alert("승인 완료되었습니다.");
	            document.getElementById("SearchBtn").click();
	        } else {
	            alert(res.message || "승인 실패");
	        }
	    });
	}); // 승인버튼 end
	
	
	// 2-4. 보류버튼 이벤트
	// 보류 버튼 클릭 (단건만 가능)
	document.getElementById('rejectSoBtn').addEventListener('click', async () => {

	  const checkedKeys = soGrid.getCheckedRowKeys();
	
	  // 부모행만 선택
	  const parentKeys = checkedKeys.filter(key => {
	    const row = soGrid.getRow(key);
	    return row._children && row._children.length > 0;
	  });
	
	  if (parentKeys.length === 0) {
	    alert("보류 할 주문서를 선택하세요.");
	    return;
	  }
	
	  if (parentKeys.length > 1) {
	    alert("보류는 한 건씩만 처리할 수 있습니다.\n하나만 선택해주세요.");
	    return;
	  }
	
	  const row = soGrid.getRow(parentKeys[0]);
	  const soId = row.soId;
	  
	  const reason = prompt(`[${soId}] 보류 사유를 입력하세요:`);
	  if (reason === null) return;
	  if (reason.trim() === "") {
	    alert("보류 사유는 필수입니다.");
	    return;
	  }
	
	  if (!confirm(`${soId} 주문서를 보류 처리하시겠습니까?`)) {
	    return;
	  }
	
	  try {
	    const res = await axios.post("/so/reject", { soId, reason });
	    alert(res.data.message || "보류 처리되었습니다.");
	    document.getElementById("SearchBtn").click();
	  } catch (err) {
	    console.error(err);
	    alert("보류 처리 중 오류가 발생했습니다.");
	  }
	});
	
	
	
	// 2-5. 주문취소버튼 이벤트
	document.getElementById('deleteSoBtn').addEventListener('click', async () => {

	  const checkedKeys = soGrid.getCheckedRowKeys();
	
	  // 부모행만 선택
	  const parentKeys = checkedKeys.filter(key => {
	    const row = soGrid.getRow(key);
	    return row._children && row._children.length > 0;
	  });
	
	  if (parentKeys.length === 0) {
	    alert("취소 할 주문서를 선택하세요.");
	    return;
	  }
	
	  if (parentKeys.length > 1) {
	    alert("취소는 한 건씩만 처리할 수 있습니다.\n하나만 선택해주세요.");
	    return;
	  }
	
	  const row = soGrid.getRow(parentKeys[0]);
	  const soId = row.soId;
	  
	  const reason = prompt(`[${soId}] 취소 사유를 입력하세요:`);
	  if (reason === null) return;
	  if (reason.trim() === "") {
	    alert("취소 사유는 필수입니다.");
	    return;
	  }
	
	  if (!confirm(`${soId} 주문서를 취소 처리하시겠습니까?`)) {
	    return;
	  }
	
	  try {
	    const res = await axios.post("/so/cancel", { soId, reason });
	    alert(res.data.message || "취소 처리되었습니다.");
	    document.getElementById("SearchBtn").click();
	  } catch (err) {
	    console.error(err);
	    alert("취소 처리 중 오류가 발생했습니다.");
	  }
	});
	
</script>

</body>
</html>