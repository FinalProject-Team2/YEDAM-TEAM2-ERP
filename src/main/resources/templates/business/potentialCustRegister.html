<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout}">

<head>
<meta charset="UTF-8">

<title>employee-register</title>
<link rel="stylesheet"
	href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>
<style>
.fixed-photo {
	width: 150px; /* 원하는 가로 크기 */
	height: 200px; /* 원하는 세로 크기 */
	object-fit: cover; /* 비율 유지하며 영역에 맞게 채움 */
}

.form-select {
	color: #000 !important;
}
</style>
</head>
<body layout:fragment="content">

	<div class="d-flex justify-content-end mb-2">
		<button class="btn btn-outline-dark" id="btnSaveAll">전체 저장</button>
	</div>

	<div class="row">
		<div class="col-md-6">
			<!-- 업종 -->
			<div class="card mb-3" style="height: 500px;">
				<!-- 카드 헤더 : 제목 + 초기화/조회 버튼 -->
				<div class="card-header">
					<div class="card-header-left">
						<h5 class="card-title">업종</h5>
					</div>
					<div class="card-header-right">
						<div th:replace="~{fragments/buttons :: addRowButton('MENU_SALES_012', 'btnAddIndustry')}"></div>
						<div th:replace="~{fragments/buttons :: saveButton('MENU_SALES_012', 'btnSaveIndustry')}"></div>
						<div th:replace="~{fragments/buttons :: deleteButton('MENU_SALES_012', 'btnDeleteIndustry')}"></div>
					</div>
				</div>
				<div class="card-body">
					<div id="industryGrid" style="margin: 20px;"></div>
				</div>
			</div>

			<!-- 설립 -->
			<div class="card" style="height: 500px;">
				<!-- 카드 헤더 : 제목 + 초기화/조회 버튼 -->
				<div class="card-header">
					<div class="card-header-left">
						<h5 class="card-title">설립</h5>
					</div>
					<div class="card-header-right">
						<div th:replace="~{fragments/buttons :: addRowButton('MENU_SALES_012', 'btnAddYear')}"></div>
						<div th:replace="~{fragments/buttons :: saveButton('MENU_SALES_012', 'btnSaveYear')}"></div>
						<div th:replace="~{fragments/buttons :: deleteButton('MENU_SALES_012', 'btnDeleteYear')}"></div>
					</div>
				</div>
				<div class="card-body">
					<div id="yearGrid" style="margin: 20px;"></div>
				</div>
			</div>
		</div>

		<!-- 우측 패널 -->
		<div class="col-md-6">
			<!-- 규모 -->
			<div class="card mb-3" style="height: 500px;">
				<!-- 카드 헤더 : 제목 + 초기화/조회 버튼 -->
				<div class="card-header">
					<div class="card-header-left">
						<h5 class="card-title">규모</h5>
					</div>
					<div class="card-header-right">
						<div th:replace="~{fragments/buttons :: addRowButton('MENU_SALES_012', 'btnAddSize')}"></div>
						<div th:replace="~{fragments/buttons :: saveButton('MENU_SALES_012', 'btnSaveSize')}"></div>
						<div th:replace="~{fragments/buttons :: deleteButton('MENU_SALES_012', 'btnDeleteSize')}"></div>
					</div>
				</div>
				<div class="card-body">
					<div id="sizeGrid" style="margin: 20px;"></div>
				</div>
			</div>

			<!-- 지역/상권 -->
			<div class="card mb-3" style="height: 500px;">
				<!-- 카드 헤더 : 제목 + 초기화/조회 버튼 -->
				<div class="card-header">
					<div class="card-header-left">
						<h5 class="card-title">지역/상권</h5>
					</div>
					<div class="card-header-right">
							<div th:replace="~{fragments/buttons :: addRowButton('MENU_SALES_012', 'btnAddRegion')}"></div>
						    <div th:replace="~{fragments/buttons :: saveButton('MENU_SALES_012', 'btnSaveRegion')}"></div>
						    <div th:replace="~{fragments/buttons :: deleteButton('MENU_SALES_012', 'btnDeleteRegion')}"></div>
						</div>
					</div>
				<div class="card-body">
					<div id="regionGrid" style="margin: 20px;"></div>
				</div>
				</div>
			</div>
		</div>
	
	
	
	
	
	
	
	
	
	
	<script th:inline="javascript">
	
	const STDR_ID_INDUSTRY = "STDR-001"; // 업종
	const STDR_ID_SIZE     = "STDR-002"; // 규모
	const STDR_ID_YEAR     = "STDR-003"; // 설립
	const STDR_ID_REGION   = "STDR-004"; // 지역/상권
	
	// 선택된 rowKey 저장용
	let selectedIndustryRowKey = null;
	let selectedSizeRowKey     = null;
	let selectedYearRowKey     = null;
	let selectedRegionRowKey   = null;
	
	// 그리드 디자인
	tui.Grid.applyTheme('default', {
		cell : {
			normal : { // 일반 셀(본문)
				border : '#ccc',
				background : "#fff",
				showVerticalBorder : true, // 세로 라인 표시
			},
			header : { // 헤더 셀
				border : '#ccc',
				background : '#E3E6ED',
				showVerticalBorder : true,
			},
			editable : { // ★ 편집 가능한 셀 공통 스타일
				background : '#FFFDF0', // 연노랑 같은 색으로 표시
				text : '#000'
			},
			selectedHeader : { // 헤더 클릭했을 때 색
				background : '#E3E6ED' // 헤더랑 똑같이 → 색 안 바뀌는 것처럼 보임
			},
			selected : { // 선택된 셀 색
				background : '#ffffff' // 필요하면 여기도 조정
			}
		}
	});
	
	//업종
	const industryGrid = new tui.Grid({
	    el: document.getElementById('industryGrid'),
	    scrollX: false,
	    scrollY: true,
	    rowHeaders: ['checkbox'],
	    columns: [
	        { header: '상세', name: 'stdrIteamInfo', editor: 'text'},
	        { header: '점수', name: 'infoScore', editor: 'text' },
	        { header: '상태', name: 'rowStatus', hidden: true },
	        { header: 'STDR_ID', name: 'stdrId', hidden: true },
	        { header: '상세ID', name: 'stdrDetailId', hidden: true }
	    ]
	});
	//규모
	const sizeGrid = new tui.Grid({
	    el: document.getElementById('sizeGrid'),
	    scrollX: false,
	    scrollY: true,
	    rowHeaders: ['checkbox'],
	    columns: [
	        { header: '상세', name: 'stdrIteamInfo', editor: 'text' },
	        { header: '점수', name: 'infoScore', editor: 'text' },
	        { header: '상태', name: 'rowStatus', hidden: true },
	        { header: 'STDR_ID', name: 'stdrId', hidden: true },
	        { header: '상세ID', name: 'stdrDetailId', hidden: true }
	    ]
	});
	//설립일
	const yearGrid = new tui.Grid({
	    el: document.getElementById('yearGrid'),
	    scrollX: false,
	    scrollY: true,
	    bodyHeight: 200,
	    rowHeaders: ['checkbox'],
	    columns: [
	        { header: '상세', name: 'stdrIteamInfo', editor: 'text' },
	        { header: '점수', name: 'infoScore', editor: 'text' },
	        { header: '상태', name: 'rowStatus', hidden: true },
	        { header: 'STDR_ID', name: 'stdrId', hidden: true },
	        { header: '상세ID', name: 'stdrDetailId', hidden: true }
	    ]
	});
	//지역
	const regionGrid = new tui.Grid({
	    el: document.getElementById('regionGrid'),
	    scrollX: false,
	    scrollY: true,
	    bodyHeight: 200,
	    rowHeaders: ['checkbox'],
	    columns: [
	        { header: '상세', name: 'stdrIteamInfo', editor: 'text'},
	        { header: '점수', name: 'infoScore', editor: 'text' },
	        { header: '상태', name: 'rowStatus', hidden: true },
	        { header: 'STDR_ID', name: 'stdrId', hidden: true },
	        { header: '상세ID', name: 'stdrDetailId', hidden: true }
	    ]
	});

		
	//전체 조회하고 STDR_ID별로 기준분류
	function getPotentialStdrDetailList() {
	    $.ajax({
	        url: '/potentialCustRegister/get',
	        type: 'GET',
	        dataType: 'json',
	        success: function (list) {
	        	
	        	 // 상태값 초기화
	            list.forEach(function(r) {
	                if (!r.rowStatus) {
	                    r.rowStatus = "";
	                }
	            });
	        	 
	            // STDR_ID별 분류
	            const industryList = list.filter(r => r.stdrId === STDR_ID_INDUSTRY);
	            const sizeList     = list.filter(r => r.stdrId === STDR_ID_SIZE);
	            const yearList     = list.filter(r => r.stdrId === STDR_ID_YEAR);
	            const regionList   = list.filter(r => r.stdrId === STDR_ID_REGION);

	            industryGrid.resetData(industryList);
	            sizeGrid.resetData(sizeList);
	            yearGrid.resetData(yearList);
	            regionGrid.resetData(regionList);
	            
	            // 선택 초기화
	            selectedIndustryRowKey = null;
	            selectedSizeRowKey     = null;
	            selectedYearRowKey     = null;
	            selectedRegionRowKey   = null;
	        },
	        error: function (err) {
	        	 console.error("조회 오류:", err);
	             alert("조회 중 오류가 발생했습니다.");
	        }
	    });
	}

	// 페이지 로딩 시 자동 조회
	$(document).ready(function () {
	    getPotentialStdrDetailList();
	
 	// 전체 저장 버튼 이벤트
	    $('#btnSaveAll').on('click', function () {
	        savePotentialStdrDetailList();
	    });
	 // === 업종 카드 ===
	    $('#btnAddIndustry').on('click', function () {
	      addIndustryRow();
	    });
	    $('#btnSaveIndustry').on('click', function () {
	      savePotentialStdrDetailList();
	    });
	    $('#btnDeleteIndustry').on('click', function () {
	      deleteRows(industryGrid);
	    });

	    // === 설립 카드 ===
	    $('#btnAddYear').on('click', function () {
	      addYearRow();
	    });
	    $('#btnSaveYear').on('click', function () {
	      savePotentialStdrDetailList();
	    });
	    $('#btnDeleteYear').on('click', function () {
	      deleteRows(yearGrid);
	    });

	    // === 규모 카드 ===
	    $('#btnAddSize').on('click', function () {
	      addSizeRow();
	    });
	    $('#btnSaveSize').on('click', function () {
	      savePotentialStdrDetailList();
	    });
	    $('#btnDeleteSize').on('click', function () {
	      deleteRows(sizeGrid);
	    });

	    // === 지역/상권 카드 ===
	    $('#btnAddRegion').on('click', function () {
	      addRegionRow();
	    });
	    $('#btnSaveRegion').on('click', function () {
	      savePotentialStdrDetailList();
	    });
	    $('#btnDeleteRegion').on('click', function () {
	      deleteRows(regionGrid);
	    });
	});
	//
	//
	//
	//
	//기준별 STDR_DETAIL_ID 자동 증가 + 추가 버튼
	function getNextDetailId(grid, stdrId) {
	    const rows = grid.getData();
	    let maxNo = 0;

	    rows.forEach(function (r) {
	        if (!r.stdrDetailId) return;
	        const parts = r.stdrDetailId.split('.');
	        if (parts.length !== 2) return;
	        const num = parseInt(parts[1], 10);
	        if (!isNaN(num) && num > maxNo) {
	            maxNo = num;
	        }
	    });

	    return stdrId + '.' + (maxNo + 1);
	}

	function addIndustryRow() {
	    const newId = getNextDetailId(industryGrid, STDR_ID_INDUSTRY);
	    industryGrid.appendRow({
	        stdrDetailId: newId,
	        stdrId: STDR_ID_INDUSTRY,
	        stdrIteamInfo: '',
	        infoScore: 0,
	        rowStatus: 'I'
	    }, { focus: true });
	}

	function addSizeRow() {
	    const newId = getNextDetailId(sizeGrid, STDR_ID_SIZE);
	    sizeGrid.appendRow({
	        stdrDetailId: newId,
	        stdrId: STDR_ID_SIZE,
	        stdrIteamInfo: '',
	        infoScore: 0,
	        rowStatus: 'I'
	    }, { focus: true });
	}

	function addYearRow() {
	    const newId = getNextDetailId(yearGrid, STDR_ID_YEAR);
	    yearGrid.appendRow({
	        stdrDetailId: newId,
	        stdrId: STDR_ID_YEAR,
	        stdrIteamInfo: '',
	        infoScore: 0,
	        rowStatus: 'I'
	    }, { focus: true });
	}

	function addRegionRow() {
	    const newId = getNextDetailId(regionGrid, STDR_ID_REGION);
	    regionGrid.appendRow({
	        stdrDetailId: newId,
	        stdrId: STDR_ID_REGION,
	        stdrIteamInfo: '',
	        infoScore: 0,
	        rowStatus: 'I'
	    }, { focus: true });
	}
	//
	//
	//
	//
	//update
	function bindRowStatusChange(grid) {
    grid.on('afterChange', function (ev) {
        ev.changes.forEach(function (change) {
            const rowKey = change.rowKey;
            const row = grid.getRow(rowKey);
            if (!row) return;
            // 2) 새로 추가된(I) 이거나 이미 삭제표시(D)인 건 건들지 말기
            if (row.rowStatus === 'I' || row.rowStatus === 'D') {
                return;
            }

            // 3) 나머지는 수정(U) 처리
            grid.setValue(rowKey, 'rowStatus', 'U', false);
		        });
		    });
		}
	bindRowStatusChange(industryGrid);
	bindRowStatusChange(sizeGrid);
	bindRowStatusChange(yearGrid);
	bindRowStatusChange(regionGrid);
	//
	//
	//
	//
	// 체크된 행들 한 번에 삭제 마킹
	function deleteCheckedRows(grid) {
	 console.log("deleteCheckedRows 호출");
   	 const rowKeys = grid.getCheckedRowKeys();  // 체크된 rowKey 배열

	    if (!rowKeys || rowKeys.length === 0) {
	        alert('삭제할 행을 체크하십시오.');
	        return;
	    }
	
	    rowKeys.forEach(function(rowKey) {
	        const row = grid.getRow(rowKey);
	        if (!row) return;
	
	        // 새로 추가한 행(I) 이거나 ID 없는 경우 → 그냥 화면에서 제거 (DB insert도 안 됐으니까)
	        if (row.rowStatus === 'I' || !row.stdrDetailId) {
	            grid.removeRow(rowKey);
	            return;
	        }
	
	        // 기존 DB에 있던 행 → 삭제 플래그만 세팅
	        grid.setValue(rowKey, 'rowStatus', 'D', false);
	        grid.addRowClassName(rowKey, 'row-deleted');
	        grid.uncheck(rowKey); // 체크 해제
	        savePotentialStdrDetailList();
	    });
	}


	
	
	// 전체 저장
	window.savePotentialStdrDetailList = function () {
	    const industryData = industryGrid.getData();
	    const sizeData     = sizeGrid.getData();
	    const yearData     = yearGrid.getData();
	    const regionData   = regionGrid.getData();

	    const sendList = []
	        .concat(industryData, sizeData, yearData, regionData)
	        .filter(r => r.rowStatus === 'I' || r.rowStatus === 'U' || r.rowStatus === 'D');

	    if (sendList.length === 0) {
	        alert('변경된 내용이 없습니다.');
	        return;
	    }

	    $.ajax({
	        url: '/potentialCustRegister/save',
	        type: 'POST',
	        contentType: 'application/json',
	        data: JSON.stringify(sendList),
	        success: function (res) {
	            if (res === 'OK') {
	                alert('저장 완료');
	                getPotentialStdrDetailList();
	            } else {
	                alert('저장 실패');
	            }
	        },
	        error: function () {
	            alert('저장 중 오류');
	        }
	    });
	}
	
	// 각 카드의 삭제 버튼에서 호출
	$("#btnDeleteIndustry").on("click", function () {
	    deleteRows(industryGrid);
	});
	$("#btnDeleteSize").on("click", function () {
	    deleteRows(sizeGrid);
	});
	$("#btnDeleteYear").on("click", function () {
	    deleteRows(yearGrid);
	});
	$("#btnDeleteRegion").on("click", function () {
	    deleteRows(regionGrid);
	});
	
	//삭제
	function deleteRows(grid) {
    const checkedRows = grid.getCheckedRows();

    if (checkedRows.length === 0) {
        alert("삭제할 행을 선택하세요.");
        return;
    }

    const deleteIdList = checkedRows.map(r => r.stdrDetailId);

    checkedRows.forEach(row => {
        grid.setValue(row.rowKey, "rowStatus", "D");
    });

    $.ajax({
        url: "/business/potentialStdr/delete",
        type: "post",
        contentType: "application/json",
        data: JSON.stringify(deleteIdList),
        success: function () {
            alert("삭제되었습니다.");

            checkedRows.forEach(row => {
                grid.removeRow(row.rowKey);
            });
        },
        error: function () {
            alert("삭제 중 오류 발생");
        }
    });
}



	</script>
<style>
	.row-deleted td {
    background-color: #eee !important;
    text-decoration: line-through;
}
</style>
	
</body>
</html>