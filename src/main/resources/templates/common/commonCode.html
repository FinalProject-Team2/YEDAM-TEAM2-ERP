<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout}">
<head>
<meta charset="UTF-8">
<title>공통 코드 관리</title>

<!-- Toast UI Grid -->
<link rel="stylesheet"
	href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>

<style>
/* form-select 색상은 style.css 공통 사용 → 별도 오버라이드 제거 */
.common-code-wrapper #groupGrid, .common-code-wrapper #codeGrid {
	width: 100%;
	margin-top: 4px;
}

.common-code-wrapper .card-title {
	font-weight: 600;
}

/* 제목 h5 아래 여백 줄이기 */
.common-code-wrapper .card-header-left h5 {
	margin-bottom: 0;
}

/* 버튼 간격은 style.css 의 .card-header-right(gap) 공통 사용 → 여기선 추가 마진 제거 */

/* 자동완성 UL 공통 스타일 */
#codeGroupSuggest {
  max-height: 200px;
  overflow-y: auto;
  background: #ffffff;
  border: 1px solid #dee2e6;
  padding: 0;
  margin-top: 2px;
  z-index: 2000; /* 이미 넣어놨으면 그대로 둬도 됨 */
}

/* 각 아이템 텍스트 확실히 보이게 */
#codeGroupSuggest .autocomplete-item {
  font-size: 0.9rem;              /* 혹시 상위에서 0으로 잡았을 경우 대비 */
  color: #212529 !important;      /* 검정에 가깝게 */
  background-color: #ffffff;
  cursor: pointer;
}

/* hover 시 강조 */
#codeGroupSuggest .autocomplete-item:hover,
#codeGroupSuggest .autocomplete-item:focus {
  background-color: #f8f9fa;
}

</style>
</head>

<body layout:fragment="content">
	<div class="common-code-wrapper">

		<!-- 공통 코드 조회 카드 -->
		<div class="row">
			<div class="col-md-12 mb-3">
				<div class="card">

					<!-- 헤더: 제목 + 초기화/조회 버튼 -->
					<div class="card-header">
						<div class="card-header-left">
							<h5 class="card-title">공통 코드 조회</h5>
						</div>
						<div class="card-header-right">
							<button id="btnReset" class="btn btn-dark" type="button">초기화</button>
							<button id="btnSearch" class="btn btn-outline-dark" type="button">조회</button>
						</div>
					</div>

					<div class="card-body">
						<div class="row mb-2">
							<div class="col-md-6">
								<label for="codeGroupName">코드 그룹 명</label>

								<!-- [자동완성][추가] 코드 그룹명 input + 추천 목록을 함께 감싸는 래퍼 -->
								<div class="position-relative">
									<!-- [자동완성][기존 input에 autocomplete="off"만 추가] -->
									<input id="codeGroupName" type="text" class="form-control"
										placeholder="직급" autocomplete="off">
									<!-- 브라우저 기본 자동완성 끄기 -->

									<!-- [자동완성][추가] 코드 그룹명 자동완성 후보 리스트 -->
									<ul id="codeGroupSuggest"
										class="list-group position-absolute w-100"
										style="z-index: 2000;">
										<!-- JS에서 <li> 항목이 동적으로 추가됨 -->
									</ul>
								</div>

								<!-- 필요하면 그룹 ID용 hidden 추가 (예시)
                            <input type="hidden" id="codeGroupId" name="codeGroupId">
                            -->
							</div>
						</div>
					</div>

				</div>
			</div>
		</div>

		<!-- 좌측: 그룹 Grid / 우측: 코드 Grid -->
		<div class="row">
			<!-- 그룹 Grid 카드 -->
			<div class="col-md-6">
				<div class="card mb-3">

					<!-- 헤더: 코드 그룹 목록 -->
					<div class="card-header">
						<div class="card-header-left">
							<h5 class="card-title">코드 그룹 목록</h5>
						</div>
					</div>

					<div class="card-body">
						<div id="groupGrid"></div>
					</div>
				</div>
			</div>

			<!-- 코드 Grid 카드 -->
			<div class="col-md-6">
				<div class="card mb-3">

					<!-- 헤더: 공통 코드 목록 -->
					<div class="card-header">
						<div class="card-header-left">
							<h5 class="card-title">공통 코드 목록</h5>
						</div>
						<div class="card-header-right">
							<button type="button" class="btn btn-outline-dark">등록</button>
						</div>
					</div>

					<div class="card-body">
						<div id="codeGrid"></div>
					</div>
				</div>
			</div>
		</div>

	</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {

    // Toast Grid 로딩 확인
    if (!window.tui || !tui.Grid) {
      return;
    }

    // ==========================
    // 1. Grid 공통 옵션
    // ==========================
    const commonGridOptions = {
      bodyHeight: 320,
      scrollX: false,
      scrollY: true,
      rowHeaders: [],
      columnOptions: {
        minWidth: 80,
        resizable: true
      }
    };

    // ==========================
    // 2. Grid 생성 (초기 데이터는 빈 배열)
    // ==========================
    const groupGrid = new tui.Grid({
      el: document.getElementById('groupGrid'),
      data: [],                       // ★ 처음엔 빈 상태
      ...commonGridOptions,
      columns: [
        { header: '그룹 ID',      name: 'groupId' },
        { header: '코드 그룹 명', name: 'groupName' },
        { header: '설명',         name: 'description' }
      ]
    });

    const codeGrid = new tui.Grid({
      el: document.getElementById('codeGrid'),
      data: [],
      ...commonGridOptions,
      columns: [
        { header: '코드 ID',   name: 'codeId' },
        { header: '코드 명',   name: 'codeName', editor: 'text' },
        {
          header: '사용 여부',
          name: 'useYn',
          editor: {
            type: 'select',
            options: {
              listItems: [
                { text: '사용',   value: 'Y' },
                { text: '미사용', value: 'N' }
              ]
            }
          },
          formatter: function ({ value }) {
            if (value === 'Y') return '사용';
            if (value === 'N') return '미사용';
            return value;
          }
        }
      ]
    });

    // 필수 컬럼 헤더(*) 표시 (공통 유틸 사용)
    if (window.TeamCommon && TeamCommon.grid && typeof TeamCommon.grid.applyRequiredHeaders === 'function') {
      TeamCommon.grid.applyRequiredHeaders([
        { gridId: 'codeGrid', columns: ['codeName', 'useYn'] }
      ]);
    }

    // ==========================
    // 3. 초기화 버튼
    // ==========================
    const $btnReset = document.getElementById('btnReset');
    const $codeGroupName = document.getElementById('codeGroupName');

    if ($btnReset && $codeGroupName) {
      $btnReset.addEventListener('click', function () {
        $codeGroupName.value = '';

        // 필요하면 그리드도 초기화
        groupGrid.resetData([]);
        // codeGrid.resetData([]); // 코드 그리드도 비우고 싶으면 주석 해제
      });
    }

    // ==========================
    // 4. 코드 그룹명 자동완성 (공통 유틸 사용)
    // ==========================
    if (window.TeamCommon && TeamCommon.autocomplete && typeof TeamCommon.autocomplete.init === 'function') {

      TeamCommon.autocomplete.init({
        inputSelector: '#codeGroupName',
        listSelector: '#codeGroupSuggest',
        url: '/code/auto', // TODO: 실제 API 주소로 맞춰야 함
        paramName: 'keyword',
        minLength: 1,
        delay: 300,
        mapResponse: function (item) {
          return {
            id: item.groupId,
            label: item.grpNm,
            value: item.grpNm
          };
        },
        onSelect: function (item) {
          document.getElementById('codeGroupName').value = item.value;
          // hidden groupId 세팅 등 추가 로직 가능
        }
      });

    } else {
      console.warn('TeamCommon.autocomplete.init 을 찾을 수 없습니다. teamUtil.js / autocomplete 유틸 로딩 확인');
    }

     /* ==========================
     기능 구현 중 (조회 grp)
     ========================== */
   
    const btnClick = document.getElementById('btnSearch');

    if (btnClick) {
    	btnClick.addEventListener('click', function () {
        const keyword = $codeGroupName.value.trim();  
        getList(keyword);
      });
    }

     function getList(grpNm) {
    	  const body = { grpNm: grpNm }; 

    	  fetch("/code/grpNm", {
    	    method: "POST",
    	    headers: {
    	      "Content-Type": "application/json"
    	    },
    	    body: JSON.stringify(body)
    	  })
    	    .then(res => {
    	      if (!res.ok) {
    	        throw new Error("서버 오류: " + res.status);
    	      }
    	      return res.json();
    	    })
    	    .then(result => {
    	      console.log("서버 응답(result):", result);

    	      const mapped = result.map(row => ({
    	        groupId: row.grpId,
    	        groupName: row.grpNm,
    	        description: row.dc,
    	        useYn: row.useYn
    	      }));

    	      groupGrid.resetData(mapped);
    	    })
    	    .catch(err => {
    	      console.error("코드 그룹 조회 중 오류", err);
    	    });
    	} // end function getList
    	
     groupGrid.on('click', function (ev) {

    	  // 헤더 클릭 등은 무시 (원하면 빼도 되지만 안전하게)
    	  if (ev.targetType !== 'cell') {
    	    return;
    	  }

    	  const row = groupGrid.getRow(ev.rowKey);
    	  if (!row) return;

    	  const grpId = row.groupId;
    	  console.log('선택된 grpId:', grpId);

    	  fetch('/code/codeId', {
    	    method: 'POST',
    	    headers: {
    	      'Content-Type': 'application/json'
    	    },
    	    body: JSON.stringify({ grpId: grpId })
    	  })
    	    .then(function (res) {
    	      if (!res.ok) {
    	        throw new Error('서버 오류: ' + res.status);
    	      }
    	      return res.json();
    	    })
    	    .then(function (result) {
    	      console.log('코드 리스트 응답:', result);

    	      const mapped = result.map(function (row) {
    	        return {
    	          codeId: row.codeId,
    	          codeName: row.codeNm,  
    	          useYn: row.yn
    	        };
    	      });

    	      codeGrid.resetData(mapped);
    	    })
    	    .catch(function (err) {
    	      console.error('코드 목록 조회 중 오류', err);
    	    });
    	});
    	
    	
  });
</script>


</body>
</html>
