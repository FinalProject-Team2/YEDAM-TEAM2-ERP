<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <meta charset="UTF-8">
    <title>역할 권한 설정</title>

    <!-- Toast UI Grid -->
    <link rel="stylesheet"
          href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
    <script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>

    <style>
        .form-select {
            color: #000 !important;
        }

        .role-auth-wrapper #roleGrid,
        .role-auth-wrapper #authGridHr,
        .role-auth-wrapper #authGridSales,
        .role-auth-wrapper #authGridCommon {
            width: 100%;
            margin-top: 6px;
        }

        .role-auth-wrapper .card-title {
            font-weight: 600;
        }

        .role-auth-wrapper .section-title {
            font-size: 15px;
            font-weight: 600;
        }

        /* 카드 헤더(제목 + 버튼) 공통 스타일 */
        .role-auth-wrapper .card-header.with-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .role-auth-wrapper .card-header-left {
            display: flex;
            align-items: center;
        }

        .role-auth-wrapper .card-header-left .card-title {
            margin-bottom: 0;
        }

        .role-auth-wrapper .card-header-right .btn {
            margin-left: .25rem;
        }

        /* 아코디언 헤더 줄 정렬용 */
        .accordion-header-inner {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        .accordion-header-inner .accordion-button {
            flex-grow: 1;
        }

        /* 빠른 설정 드롭다운을 셀렉트처럼 보이게 */
        .quick-setting-dropdown .dropdown-toggle {
            border-radius: .25rem;
            border: 1px solid #ced4da;
            background-color: #fff;
            color: #495057;
            font-size: .875rem;
            padding: .25rem .5rem;
        }

        .quick-setting-dropdown .dropdown-toggle::after {
            margin-left: .5rem;
        }

        /* 빠른 설정 드롭다운 안에서 체크박스가 밖으로 나가는 문제 수정 */
        .quick-setting-dropdown .dropdown-menu {
            min-width: 180px;
            padding: 8px 12px;
        }

        .quick-setting-dropdown .dropdown-menu .form-check {
            padding-left: 0;
            margin-bottom: 4px;
        }

        .quick-setting-dropdown .dropdown-menu .form-check-input {
            position: static;
            margin-left: 0;
            margin-right: 6px;
        }
    </style>
</head>

<body layout:fragment="content">
<div class="role-auth-wrapper">

    <!-- 역할 조회 카드 -->
    <div class="row">
        <div class="col-md-12 mb-3">
            <div class="card">

                <!-- 카드 헤더: 제목 + 초기화/조회 버튼 -->
                <div class="card-header with-actions">
                    <div class="card-header-left">
                        <h5 class="card-title">역할 조회</h5>
                    </div>
                    <div class="card-header-right">
                        <button class="btn btn-dark">초기화</button>
                        <button class="btn btn-outline-dark">조회</button>
                    </div>
                </div>

                <div class="card-body">
                    <div class="row mb-2">
                        <div class="col-md-4">
                            <label for="roleName">역할 명</label>
                            <input id="roleName"
                                   type="text"
                                   class="form-control"
                                   placeholder="인사담당">
                        </div>
                        <div class="col-md-4">
                            <label for="roleType">역할 유형</label>
                            <select id="roleType" class="form-select">
                                <option>전체</option>
                                <option>인사/급여</option>
                                <option>영업/매입</option>
                                <option>공통</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="useYn">사용 여부</label>
                            <select id="useYn" class="form-select">
                                <option value="">전체</option>
                                <option value="Y">사용</option>
                                <option value="N">미사용</option>
                            </select>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- 역할 목록 / 권한 설정 카드 -->
    <div class="row">
        <!-- 역할 목록 Grid 카드 -->
        <div class="col-md-6">
            <div class="card mb-3">

                <!-- 카드 헤더: 제목 + 저장 버튼 -->
                <div class="card-header">
                    <div class="card-header-left">
                        <h5 class="card-title">역할 목록</h5>
                    </div>
                    <div class="card-header-right">
                        <button type="button" class="btn btn-outline-dark">저장</button>
                    </div>
                </div>

                <div class="card-body">
                    <div id="roleGrid"></div>
                </div>
            </div>
        </div>

        <!-- 권한 설정 카드 -->
        <div class="col-md-6">
            <div class="card mb-3">

                <!-- 카드 헤더: 제목 + 저장 버튼 -->
                <div class="card-header">
                    <div class="card-header-left">
                        <h5 class="card-title">권한 설정</h5>
                    </div>
                    <div class="card-header-right">
                        <button type="button" class="btn btn-outline-dark">저장</button>
                    </div>
                </div>

                <div class="card-body">
                    <div class="accordion" id="authAccordion">

                        <!-- 인사/급여 -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingHr">
                                <div class="accordion-header-inner">
                                    <!-- 아코디언 토글 버튼 -->
                                    <button class="accordion-button"
                                            type="button"
                                            data-bs-toggle="collapse"
                                            data-bs-target="#collapseHr"
                                            aria-expanded="true"
                                            aria-controls="collapseHr">
                                        인사/급여
                                    </button>

                                    <!-- 빠른 설정 드롭다운 (체크박스) -->
                                    <div class="dropdown quick-setting-dropdown">
                                        <button class="btn dropdown-toggle btn-sm"
                                                type="button"
                                                data-bs-toggle="dropdown"
                                                aria-expanded="false">
                                            빠른 설정
                                        </button>
                                        <div class="dropdown-menu dropdown-menu-end p-2">
                                            <div class="form-check">
                                                <input class="form-check-input quick-bulk-check"
                                                       type="checkbox"
                                                       value="readAll"
                                                       id="qs-hr-read"
                                                       data-grid="hr">
                                                <label class="form-check-label" for="qs-hr-read">
                                                    조회 일괄 적용
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input quick-bulk-check"
                                                       type="checkbox"
                                                       value="saveAll"
                                                       id="qs-hr-save"
                                                       data-grid="hr">
                                                <label class="form-check-label" for="qs-hr-save">
                                                    저장/수정 일괄 적용
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input quick-bulk-check"
                                                       type="checkbox"
                                                       value="deleteAll"
                                                       id="qs-hr-delete"
                                                       data-grid="hr">
                                                <label class="form-check-label" for="qs-hr-delete">
                                                    삭제 일괄 적용
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </h2>
                            <div id="collapseHr"
                                 class="accordion-collapse collapse show"
                                 aria-labelledby="headingHr"
                                 data-bs-parent="#authAccordion">
                                <div class="accordion-body">
                                    <div id="authGridHr"></div>
                                </div>
                            </div>
                        </div>

                        <!-- 영업 -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingSales">
                                <div class="accordion-header-inner">
                                    <button class="accordion-button collapsed"
                                            type="button"
                                            data-bs-toggle="collapse"
                                            data-bs-target="#collapseSales"
                                            aria-expanded="false"
                                            aria-controls="collapseSales">
                                        영업
                                    </button>

                                    <div class="dropdown quick-setting-dropdown">
                                        <button class="btn dropdown-toggle btn-sm"
                                                type="button"
                                                data-bs-toggle="dropdown"
                                                aria-expanded="false">
                                            빠른 설정
                                        </button>
                                        <div class="dropdown-menu dropdown-menu-end p-2">
                                            <div class="form-check">
                                                <input class="form-check-input quick-bulk-check"
                                                       type="checkbox"
                                                       value="readAll"
                                                       id="qs-sales-read"
                                                       data-grid="sales">
                                                <label class="form-check-label" for="qs-sales-read">
                                                    조회 일괄 적용
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input quick-bulk-check"
                                                       type="checkbox"
                                                       value="saveAll"
                                                       id="qs-sales-save"
                                                       data-grid="sales">
                                                <label class="form-check-label" for="qs-sales-save">
                                                    저장/수정 일괄 적용
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input quick-bulk-check"
                                                       type="checkbox"
                                                       value="deleteAll"
                                                       id="qs-sales-delete"
                                                       data-grid="sales">
                                                <label class="form-check-label" for="qs-sales-delete">
                                                    삭제 일괄 적용
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </h2>
                            <div id="collapseSales"
                                 class="accordion-collapse collapse"
                                 aria-labelledby="headingSales"
                                 data-bs-parent="#authAccordion">
                                <div class="accordion-body">
                                    <div id="authGridSales"></div>
                                </div>
                            </div>
                        </div>

                        <!-- 공통 -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingCommon">
                                <div class="accordion-header-inner">
                                    <button class="accordion-button collapsed"
                                            type="button"
                                            data-bs-toggle="collapse"
                                            data-bs-target="#collapseCommon"
                                            aria-expanded="false"
                                            aria-controls="collapseCommon">
                                        공통
                                    </button>

                                    <div class="dropdown quick-setting-dropdown">
                                        <button class="btn dropdown-toggle btn-sm"
                                                type="button"
                                                data-bs-toggle="dropdown"
                                                aria-expanded="false">
                                            빠른 설정
                                        </button>
                                        <div class="dropdown-menu dropdown-menu-end p-2">
                                            <div class="form-check">
                                                <input class="form-check-input quick-bulk-check"
                                                       type="checkbox"
                                                       value="readAll"
                                                       id="qs-common-read"
                                                       data-grid="common">
                                                <label class="form-check-label" for="qs-common-read">
                                                    조회 일괄 적용
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input quick-bulk-check"
                                                       type="checkbox"
                                                       value="saveAll"
                                                       id="qs-common-save"
                                                       data-grid="common">
                                                <label class="form-check-label" for="qs-common-save">
                                                    저장/수정 일괄 적용
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input quick-bulk-check"
                                                       type="checkbox"
                                                       value="deleteAll"
                                                       id="qs-common-delete"
                                                       data-grid="common">
                                                <label class="form-check-label" for="qs-common-delete">
                                                    삭제 일괄 적용
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </h2>
                            <div id="collapseCommon"
                                 class="accordion-collapse collapse"
                                 aria-labelledby="headingCommon"
                                 data-bs-parent="#authAccordion">
                                <div class="accordion-body">
                                    <div id="authGridCommon"></div>
                                </div>
                            </div>
                        </div>

                    </div> <!-- /accordion -->
                </div> <!-- /card-body -->

            </div>
        </div>
    </div>

</div>

<script>
    // 1. Grid 테마
    tui.Grid.applyTheme('default', {
        cell: {
            normal: {
                border: '#dedede',
                background: '#ffffff',
                showVerticalBorder: true
            },
            header: {
                border: '#dedede',
                background: '#f5f5f5',
                showVerticalBorder: true
            },
            editable: {
                background: '#FFFDF0',
                text: '#000'
            },
            selectedHeader: {
                background: '#f5f5f5'
            },
            selected: {
                background: '#ffffff'
            }
        }
    });

    // 2. 화면용 더미 데이터
    const roleData = [
        { roleName: '인사 담당',     roleType: '인사/급여', useYn: '사용' },
        { roleName: '영업 담당',     roleType: '영업/매입', useYn: '사용' },
        { roleName: '시스템 관리자', roleType: '공통',     useYn: '사용' },
        { roleName: '인사 담당',     roleType: '인사/급여', useYn: '사용' },
        { roleName: '인사 담당',     roleType: '인사/급여', useYn: '사용' },
        { roleName: '인사 담당',     roleType: '인사/급여', useYn: '사용' },
        { roleName: '인사 담당',     roleType: '인사/급여', useYn: '사용' },
        { roleName: '인사 담당',     roleType: '인사/급여', useYn: '사용' },
        { roleName: '인사 담당',     roleType: '인사/급여', useYn: '사용' },
        { roleName: '인사 담당',     roleType: '인사/급여', useYn: '사용' },
        { roleName: '인사 담당',     roleType: '인사/급여', useYn: '사용' },
        { roleName: '인사 담당',     roleType: '인사/급여', useYn: '사용' },
        { roleName: '인사 담당',     roleType: '인사/급여', useYn: '사용' },
        { roleName: '인사 담당',     roleType: '인사/급여', useYn: '사용' },
        { roleName: '인사 담당',     roleType: '인사/급여', useYn: '사용' },
        { roleName: '인사 담당',     roleType: '인사/급여', useYn: '사용' },
        { roleName: '인사 담당',     roleType: '인사/급여', useYn: '사용' },
        { roleName: '인사 담당',     roleType: '인사/급여', useYn: '사용' }
    ];

    const authDataHr = [
        { menuName: '사원 목록', canRead: true,  canSave: true,  canDelete: false },
        { menuName: '사원 등록', canRead: true,  canSave: true,  canDelete: true  },
        { menuName: '급여 계산', canRead: true,  canSave: false, canDelete: false }
    ];

    const authDataSales = [
        { menuName: '주문 등록', canRead: true,  canSave: true,  canDelete: false },
        { menuName: '매출 조회', canRead: true,  canSave: false, canDelete: false },
        { menuName: '출고 관리', canRead: true,  canSave: true,  canDelete: true  }
    ];

    const authDataCommon = [
        { menuName: '공통 코드 관리', canRead: true, canSave: true,  canDelete: true  },
        { menuName: '메뉴 관리',     canRead: true, canSave: true,  canDelete: false },
        { menuName: '로그 조회',     canRead: true, canSave: false, canDelete: false }
    ];

    const commonGridOptions = {
        bodyHeight: 240,
        scrollX: false,
        scrollY: true,
        rowHeaders: [],
        columnOptions: {
            minWidth: 80,
            resizable: true
        }
    };

    // 3. 역할 목록 Grid
    const roleGrid = new tui.Grid({
        el: document.getElementById('roleGrid'),
        data: roleData,
        ...commonGridOptions,
        columns: [
            { header: '역할 명',   name: 'roleName' },
            { header: '역할 유형', name: 'roleType' },
            { header: '사용 여부', name: 'useYn', align: 'center' }
        ]
    });

    // 4. 권한 설정 Grid들 (각 아코디언 섹션별)
    function createAuthGrid(elId, data) {
        return new tui.Grid({
            el: document.getElementById(elId),
            data: data,
            ...commonGridOptions,
            columns: [
                { header: '메뉴 / 화면', name: 'menuName', minWidth: 200 },
                {
                    header: '조회',
                    name: 'canRead',
                    align: 'center',
                    formatter: ({ value }) =>
                        `<input type="checkbox" ${value ? 'checked' : ''} />`
                },
                {
                    header: '저장 / 수정',
                    name: 'canSave',
                    align: 'center',
                    formatter: ({ value }) =>
                        `<input type="checkbox" ${value ? 'checked' : ''} />`
                },
                {
                    header: '삭제',
                    name: 'canDelete',
                    align: 'center',
                    formatter: ({ value }) =>
                        `<input type="checkbox" ${value ? 'checked' : ''} />`
                }
            ]
        });
    }

    const authGridHr     = createAuthGrid('authGridHr', authDataHr);
    const authGridSales  = createAuthGrid('authGridSales', authDataSales);
    const authGridCommon = createAuthGrid('authGridCommon', authDataCommon);

    // 5. Grid 키별 객체 반환
    function getGridByKey(key) {
        if (key === 'hr') return authGridHr;
        if (key === 'sales') return authGridSales;
        if (key === 'common') return authGridCommon;
        return null;
    }

    // 6. 빠른 설정 체크박스를 그리드 데이터 기준으로 동기화
    function syncQuickCheckboxes(grid, gridKey) {
        if (!grid) return;
        const rows = grid.getData();

        const allRead   = rows.length > 0 && rows.every(r => !!r.canRead);
        const allSave   = rows.length > 0 && rows.every(r => !!r.canSave);
        const allDelete = rows.length > 0 && rows.every(r => !!r.canDelete);

        const qsRead   = document.querySelector(`#qs-${gridKey}-read`);
        const qsSave   = document.querySelector(`#qs-${gridKey}-save`);
        const qsDelete = document.querySelector(`#qs-${gridKey}-delete`);

        if (qsRead)   qsRead.checked   = allRead;
        if (qsSave)   qsSave.checked   = allSave;
        if (qsDelete) qsDelete.checked = allDelete;
    }

    // 7. 빠른 설정 체크박스로 일괄 적용
    function applyBulkSetting(grid, action, checked) {
        if (!grid) return;
        const rows = grid.getData().map(row => {
            if (action === 'readAll')   row.canRead   = checked;
            if (action === 'saveAll')   row.canSave   = checked;
            if (action === 'deleteAll') row.canDelete = checked;
            return row;
        });
        grid.resetData(rows);
    }

    document.querySelectorAll('.quick-bulk-check').forEach(cb => {
        cb.addEventListener('change', e => {
            const gridKey = e.target.dataset.grid;  // hr / sales / common
            const action  = e.target.value;         // readAll / saveAll / deleteAll
            const checked = e.target.checked;

            const grid = getGridByKey(gridKey);
            applyBulkSetting(grid, action, checked);   // 일괄 적용 또는 해제
            syncQuickCheckboxes(grid, gridKey);        // 데이터 기준으로 상태 다시 맞추기
        });
    });

    // 8. 그리드 셀 클릭 시 → 값 토글 + 빠른 설정 체크박스 동기화
    function setupGridClickSync(grid, gridKey) {
        grid.on('click', ev => {
            const col = ev.columnName;
            const rowKey = ev.rowKey;

            if (rowKey == null) return;
            if (!['canRead', 'canSave', 'canDelete'].includes(col)) return;

            const current = grid.getValue(rowKey, col);
            grid.setValue(rowKey, col, !current, false);

            // 일부만 해제되면 빠른 설정 체크박스 자동 해제
            syncQuickCheckboxes(grid, gridKey);
        });
    }

    setupGridClickSync(authGridHr, 'hr');
    setupGridClickSync(authGridSales, 'sales');
    setupGridClickSync(authGridCommon, 'common');
    
    // 그리드 레이아웃 새로고침 (스크롤바 벗어남 해결책)
    window.addEventListener('load', function() {
        subscriptionGrid.refreshLayout();
    });
</script>

</body>
</html>
