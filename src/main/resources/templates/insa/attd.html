<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <meta charset="UTF-8">

    <!-- Toast UI Grid -->
    <link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
    <script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>

    <title>attd</title>

    <style>
        #attGrid { width: 100%; }
    </style>
</head>
<body layout:fragment="content">
<div class="row">

    <!-- ================= ê²€ìƒ‰ì¡°ê±´ ================= -->
    <div class="col-md-12">
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="card-title mb-0">ê·¼íƒœí˜„í™© ì¡°íšŒ</h5>
                <div class="card-header-right">
                    <button type="button" id="btnSearchAttd" class="btn btn-outline-dark">
                        ì¡°íšŒ
                    </button>
                </div>
            </div>

            <div class="card-body">
                <div class="row">

                    <!-- ë¶€ì„œëª… : HR ê´€ë¦¬ìë§Œ ë…¸ì¶œ -->
                    <div class="col-md-3"
                         th:if="${session.LOGIN_EMP != null and session.LOGIN_EMP.roleId == 'ROLE_HR_ADMIN'}">
                        <label class="form-label">ë¶€ì„œëª…</label>
                        <select class="form-select" id="deptSelect">
                            <option value="">ì „ì²´</option>
                        </select>
                    </div>

                    <!-- ì‚¬ì›ëª… : HR ê´€ë¦¬ìë§Œ ê²€ìƒ‰ìš© ì¸í’‹ ë…¸ì¶œ -->
                    <div class="col-md-3"
                         th:if="${session.LOGIN_EMP != null and session.LOGIN_EMP.roleId == 'ROLE_HR_ADMIN'}">
                        <label class="form-label">ì‚¬ì›ëª…</label>
                        <input type="text" id="empNmCond" class="form-control" placeholder="ì‚¬ì›ëª… ì…ë ¥">
                    </div>

                    <!-- ê·¼ë¬´ì¼ì -->
                    <div class="col-md-6">
                        <label class="form-label">ê·¼ë¬´ì¼ì</label>
                        <div class="d-flex align-items-center js-date-range">

                            <!-- ì‹œì‘ì¼ -->
                            <div class="input-group date me-2">
                                <input type="text"
                                       class="form-control js-date-range-start"
                                       id="workDtStart"
                                       placeholder="ë‚ ì§œ ì„ íƒ">
                                <span class="input-group-text js-date-range-icon-start">
                                    <i class="bi bi-calendar"></i>
                                </span>
                            </div>

                            <span class="mx-1 fw-bold fs-5">~</span>

                            <!-- ì¢…ë£Œì¼ -->
                            <div class="input-group date ms-2">
                                <input type="text"
                                       class="form-control js-date-range-end"
                                       id="workDtEnd"
                                       placeholder="ë‚ ì§œ ì„ íƒ">
                                <span class="input-group-text js-date-range-icon-end">
                                    <i class="bi bi-calendar"></i>
                                </span>
                            </div>

                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- ================= ëª©ë¡ ================= -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">ê·¼íƒœ ëª©ë¡</h5>
            </div>
            <div class="card-body">
                <div id="attGrid" class="mt-3"></div>
            </div>
        </div>
    </div>

</div>

<script type="text/javascript">
    /***********************
     * Grid ìƒì„± (ì´ˆê¸° ë¹ˆ ë°ì´í„°)
     ***********************/
    const attGrid = new tui.Grid({
        el: document.getElementById("attGrid"),
        data: [],
        bodyHeight: 431,
        scrollX: false,
        scrollY: true,
        rowHeaders: [],
        columns: [
            { header: "ê·¼ë¬´ì¼ì", name: "wkDt",    align: "center" },
            { header: "ë¶€ì„œëª…",   name: "deptNm",  align: "center" },
            { header: "ì§ê¸‰",     name: "roleNm",  align: "center" },
            { header: "ì‚¬ì›ID",   name: "empId",   align: "center" },
            { header: "ì‚¬ì›ëª…",   name: "empNm",   align: "center" },
            { header: "ê·¼íƒœì¢…ë¥˜", name: "attdTy",  align: "center" },
            { header: "ì¶œê·¼ì‹œê°„", name: "attdIn",  align: "center" },
            { header: "í‡´ê·¼ì‹œê°„", name: "attdOut", align: "center" }
        ]
    });

    /***********************
     * ë¶€ì„œ ì…€ë ‰íŠ¸ ë°•ìŠ¤ ë¡œë”©
     *  - HR ê´€ë¦¬ì í™”ë©´ì—ì„œë§Œ ì¡´ì¬í•¨
     ***********************/
    function loadDeptOptionsForAttd() {
        const deptSelect = document.getElementById("deptSelect");
        if (!deptSelect) return;   // ì¼ë°˜ ì‚¬ìš©ìë©´ ê·¸ëƒ¥ íŒ¨ìŠ¤

        deptSelect.innerHTML = '<option value="">ì „ì²´</option>';

        fetch('/insa/edc/inputOption')
            .then(res => res.json())
            .then(data => {
                const deptList = data.dept || [];
                deptList.forEach(dept => {
                    const opt = document.createElement('option');
                    opt.value = dept.deptId;
                    opt.textContent = dept.deptNm;
                    deptSelect.appendChild(opt);
                });
            })
            .catch(() => {
                alert('ë¶€ì„œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
    }

    /***********************
     * ê³µí†µ ì¡°íšŒ í•¨ìˆ˜
     *  - ì—¬ê¸°ì„œ ê·¼ë¬´ì¼ì ìµœì‹ ìˆœ ì •ë ¬
     ***********************/
    function loadAttdList() {
        const deptSelect = document.getElementById("deptSelect");   // HR ê´€ë¦¬ìë§Œ ì¡´ì¬
        const empNmInput = document.getElementById("empNmCond");    // HR ê´€ë¦¬ìë§Œ ì¡´ì¬

        const param = {
            deptId   : deptSelect ? deptSelect.value : "",
            empNmCond: empNmInput ? empNmInput.value : "",
            startDt  : document.getElementById("workDtStart").value,
            endDt    : document.getElementById("workDtEnd").value
        };

        fetch("/attd/list", {
            method : "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body   : JSON.stringify(param)
        })
        .then(res => res.json())
        .then(data => {
            // ğŸ”¥ ê·¼ë¬´ì¼ì(wkDt, 'YYYY.MM.DD' í˜•ì‹)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìµœì‹ ìˆœ ì •ë ¬
            const sorted = (data || []).slice().sort((a, b) => {
                const da = a.wkDt || '';
                const db = b.wkDt || '';
                // ë¬¸ìì—´ì´ 'YYYY.MM.DD' í˜•íƒœë¼ì„œ ì—­ìˆœ ë¹„êµë§Œ í•´ë„ ìµœì‹ ìˆœ ë¨
                return db.localeCompare(da);
            });
            attGrid.resetData(sorted);
        })
        .catch(err => {
            console.error("ê·¼íƒœ ì¡°íšŒ ì˜¤ë¥˜", err);
            alert("ê·¼íƒœ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        });
    }

    /***********************
     * ì¡°íšŒ ë²„íŠ¼ í´ë¦­
     ***********************/
    document.getElementById("btnSearchAttd").addEventListener("click", function () {
        loadAttdList();
    });

    /***********************
     * ì—”í„°í‚¤ ê²€ìƒ‰ (ì‚¬ì›ëª… ì¸í’‹)
     ***********************/
    document.addEventListener("DOMContentLoaded", function () {
        const empNmInput = document.getElementById("empNmCond");
        if (empNmInput) {
            empNmInput.addEventListener("keydown", function (e) {
                if (e.key === "Enter") {
                    loadAttdList();
                }
            });
        }

        const deptSelect = document.getElementById("deptSelect");
        if (deptSelect) {
            deptSelect.addEventListener("change", function () {
                loadAttdList();
            });
        }
    });

    /***********************
     * í˜ì´ì§€ ë¡œë“œ ì‹œ 1íšŒ ì „ì²´ ì¡°íšŒ + ë¶€ì„œ ëª©ë¡ ë¡œë”©
     ***********************/
    document.addEventListener("DOMContentLoaded", function () {
        loadDeptOptionsForAttd();  // HR ê´€ë¦¬ìë©´ ë¶€ì„œ ì…€ë ‰íŠ¸ ì±„ì›€
        loadAttdList();            // ê·¸ë¦¬ë“œ ì²« í™”ë©´ ë¡œë”©
    });
</script>
</body>
</html>
