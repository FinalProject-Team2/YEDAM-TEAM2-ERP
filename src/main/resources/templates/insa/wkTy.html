<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
  <meta charset="UTF-8">
  <title>wkTy</title>

  <!-- ✅ Toast UI 공통 유틸 -->
  <script src="https://uicdn.toast.com/tui-code-snippet/latest/tui-code-snippet.js"></script>

  <!-- ✅ Date / Time Picker -->
  <link rel="stylesheet"
        href="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.css">
  <link rel="stylesheet"
        href="https://uicdn.toast.com/tui.time-picker/latest/tui-time-picker.css">

  <script src="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.js"></script>
  <script src="https://uicdn.toast.com/tui.time-picker/latest/tui-time-picker.js"></script>

  <!-- ✅ Grid -->
  <link rel="stylesheet"
        href="https://uicdn.toast.com/grid/latest/tui-grid.css">
  <script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>

  <style>
    .wk-panel {
      border: 1px solid #dedede;
      border-radius: 18px;
      padding: 24px 26px;
      background-color: #fff;
    }
    .wk-panel .form-label {
      font-weight: 500;
    }
    .wk-time-range .form-control {
      height: 36px;
      padding-top: 4px;
      padding-bottom: 4px;
    }
    .wk-time-range .input-group-text {
      font-size: 0.85rem;
      cursor: pointer;
    }
    .wk-dot {
      display: inline-block;
      margin: 0 8px;
      font-size: 18px;
      line-height: 36px;
    }
    .wk-day-buttons .btn {
      min-width: 38px;
      padding: 4px 0;
      font-size: 0.85rem;
      border-radius: 0;
    }
    .wk-day-buttons .btn:first-child {
      border-radius: 10px 0 0 10px;
    }
    .wk-day-buttons .btn:last-child {
      border-radius: 0 10px 10px 0;
    }
    .wk-day-buttons .btn.selected {
      background-color: #0d6efd;
      color: #fff;
      border-color: #0d6efd;
    }
    .wk-radio-group {
      display: flex;
      align-items: center;
      gap: 24px;
      margin-top: 4px;
    }
    .wk-radio {
      display: flex;
      align-items: center;
      gap: 6px;
      margin: 0;
    }
    .wk-radio input[type="radio"] {
      margin: 0;
    }

    /* ✅ time 인풋 내부 기본 시계 아이콘 제거 (크롬/엣지 등) */
    input[type="time"]::-webkit-calendar-picker-indicator {
      display: none;
    }
    input[type="time"]::-webkit-inner-spin-button,
    input[type="time"]::-webkit-clear-button {
      display: none;
    }
  </style>
</head>
<body layout:fragment="content">
<div class="row">

  <!-- ================== 휴일 기준 관리 ================== -->
  <div class="col-md-6">
    <div class="card mb-3">
      <div class="card-header">
        <h5 class="card-title">휴일 기준 관리</h5>
        <div class="card-header-right">
          <button class="btn btn-danger" id="btnHldyDel">삭제</button>
          <button class="btn btn-outline-dark" id="btnHldyAdd">행추가</button>
          <button class="btn btn-outline-dark" id="btnHldySave">저장</button>
        </div>
      </div>
      <div class="card-body">
        <div id="gridHldy" class="mt-3"></div>
      </div>
    </div>
  </div>

  <!-- ================== 근무형태 기준 관리 ================== -->
  <div class="col-md-6">
    <div class="card mb-3">
      <div class="card-header mb-3">
        <h5 class="card-title">근무형태 기준 관리</h5>
        <div class="card-header-right">
          <button class="btn btn-dark">초기화</button>
          <button class="btn btn-danger">삭제</button>
          <button class="btn btn-outline-dark">저장</button>
          <button class="btn btn-outline-dark" id="openGuideModal">조회</button>
        </div>
      </div>

      <div class="card-body">
        <div class="wk-panel">
          <!-- 기준명 / 부서명 -->
          <div class="row mb-3">
            <div class="col-6">
              <label for="stdNm" class="form-label">기준명</label>
              <input type="text" id="stdNm" class="form-control" />
            </div>
            <div class="col-6">
              <label for="deptNm" class="form-label">부서명</label>
              <select id="deptNm" class="form-select">
                <option value="">선택</option>
              </select>
            </div>
          </div>

          <!-- 출근시간 / 퇴근시간 -->
          <div class="row mb-4 wk-time-range">
            <div class="col-5">
              <label for="startTime" class="form-label">출근시간</label>
              <div class="input-group">
                <input type="time" id="startTime" class="form-control">
                <span class="input-group-text" id="startTimeIcon">⏱</span>
              </div>
            </div>
            <div class="col-2 d-flex align-items-end justify-content-center">
              <span class="wk-dot">~</span>
            </div>
            <div class="col-5">
              <label for="endTime" class="form-label">퇴근시간</label>
              <div class="input-group">
                <input type="time" id="endTime" class="form-control">
                <span class="input-group-text" id="endTimeIcon">⏱</span>
              </div>
            </div>
          </div>

          <!-- 근무유형 (요일 / 주기) -->
          <div class="mb-2">
            <label class="form-label d-block">근무유형</label>
            <div class="wk-radio-group">
              <label class="wk-radio">
                <input type="radio" name="wkType" id="wkTypeDay" value="DAY" checked>
                <span>요일</span>
              </label>
              <label class="wk-radio">
                <input type="radio" name="wkType" id="wkTypeCycle" value="CYCLE">
                <span>주기</span>
              </label>
            </div>
          </div>

          <!-- 요일 버튼 영역 -->
          <div id="weekdaySection" class="wk-day-buttons mb-4">
            <div class="btn-group" role="group" aria-label="weekday">
              <button type="button" class="btn btn-outline-primary btn-sm" data-day="MON">월</button>
              <button type="button" class="btn btn-outline-primary btn-sm" data-day="TUE">화</button>
              <button type="button" class="btn btn-outline-primary btn-sm" data-day="WED">수</button>
              <button type="button" class="btn btn-outline-primary btn-sm" data-day="THU">목</button>
              <button type="button" class="btn btn-outline-primary btn-sm" data-day="FRI">금</button>
              <button type="button" class="btn btn-outline-primary btn-sm" data-day="SAT">토</button>
              <button type="button" class="btn btn-outline-primary btn-sm" data-day="SUN">일</button>
            </div>
          </div>

          <!-- 주기 영역 -->
          <div id="cycleSection" class="row g-3 mb-2 d-none">
            <div class="col-6">
              <label for="workDays" class="form-label">근무일</label>
              <div class="input-group">
                <input type="number" id="workDays" class="form-control" min="0">
                <span class="input-group-text">일</span>
              </div>
            </div>
            <div class="col-6">
              <label for="offDays" class="form-label">휴일</label>
              <div class="input-group">
                <input type="number" id="offDays" class="form-control" min="0">
                <span class="input-group-text">일</span>
              </div>
            </div>
          </div>

          <input type="hidden" id="selectedWeekdays" name="selectedWeekdays" value="">
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ✅ 근무형태 기준 조회 모달 -->
<div th:replace="~{insa/modal/wkTyModal :: wkTyModal}"></div>

<script>
  /* =====================================================
   * 1. Grid 공통 옵션
   * ===================================================== */
  const GridOptions = {
    bodyHeight: 600,
    scrollX: false,
    scrollY: false,
    rowHeaders: ['checkbox'],
    columnOptions: {
      minWidth: 80,
      resizable: true
    }
  };

  /* =====================================================
   * 2. 휴일 기준 Grid
   *    - DB: HldyVO(hldyNo, hldyNm, hldyMmdd, ynCode, ynNm)
   *    - 서버 hldyMmdd = "MM-DD"
   *    - 그리드에서는 datePicker 편하게 쓰려고 "2000-MM-DD" 로 변환
   * ===================================================== */
  const hldyGrid = new tui.Grid({
    el: document.getElementById('gridHldy'),
    data: [],
    ...GridOptions,
    editingType: 'cell',
    columns: [
      {
        header: '번호',
        name: 'hldyNo',
        hidden: true
      },
      {
        header: '월일',
        name: 'hldyMmdd',
        align: 'center',
        editor: {
          type: 'datePicker',
          options: {
            format: 'yyyy-MM-dd',
            language: 'ko'
          }
        },
        formatter: ({ value }) => {
          if (!value) return '';
          // value: '2000-01-01' → 화면엔 '01-01' 만 보여줌
          if (value.length === 10 && value.indexOf('-') === 4) {
            return value.slice(5); // 'MM-DD'
          }
          return value;
        }
      },
      {
        header: '휴일명',
        name: 'hldyNm',
        editor: 'text'
      },
      {
    	  header: '사용여부',
    	  name: 'ynCode',   // 서버랑 주고받는 값 (e1 / e2)
    	  editor: {
    	    type: 'select',
    	    options: {
    	      listItems: [
    	        { text: '사용',   value: 'e1' },  // code_id e1
    	        { text: '미사용', value: 'e2' }   // code_id e2
    	      ]
    	    }
    	  },
    	  formatter: ({ value }) => {
    	    if (value === 'e1') return '사용';    // e1 -> 사용
    	    if (value === 'e2') return '미사용';  // e2 -> 미사용
    	    return '';
    	  }
    	}
    ]
  });

  /* =====================================================
   * 3. 휴일 기준 목록 조회 (페이지 로드 시)
   *     GET /api/hldy/list  → List<HldyVO>
   * ===================================================== */
   function loadHldyList() {
	   fetch('/api/hldy/list')
	     .then(res => {
	       if (!res.ok) throw new Error('조회 실패');
	       return res.json();
	     })
	     .then(list => {
	       // 서버: hldyMmdd = 'MM-DD', ynCode = 'e1'/'e2'
	       const gridData = list.map(row => ({
	         hldyNo:  row.hldyNo,
	         hldyNm:  row.hldyNm,
	         hldyMmdd: row.hldyMmdd ? '2000-' + row.hldyMmdd : '',
	         ynCode:  row.ynCode || 'e1'   // 기본값: 사용
	       }));
	       hldyGrid.resetData(gridData);
	     })
	     .catch(err => {
	       console.error(err);
	       alert('휴일 기준 조회 중 오류가 발생했습니다.');
	     });
	 }

  document.addEventListener('DOMContentLoaded', loadHldyList);

  /* =====================================================
   * 4. 휴일 기준 행추가/삭제/저장
   *    - 저장: getModifiedRows() → created / updated / deleted
   *    - POST /api/hldy/save
   * ===================================================== */

  // 행추가
  document.getElementById('btnHldyAdd').addEventListener('click', () => {
    hldyGrid.prependRow(
      {
        hldyNo: null,
        hldyMmdd: '',
        hldyNm: '',
        ynCode: 'e1',   // 기본값: 사용
        ynNm: '사용'
      },
      { focus: true }
    );
  });

  // 삭제(체크된 행 삭제)
  document.getElementById('btnHldyDel').addEventListener('click', () => {
    const checked = hldyGrid.getCheckedRowKeys();
    hldyGrid.removeRows(checked);
  });

  // ✅ 저장
  document.getElementById('btnHldySave').addEventListener('click', () => {
    // 1) 편집 중인 셀 커밋
    hldyGrid.finishEditing();

    // 2) 변경 내역 가져오기
    const modified = hldyGrid.getModifiedRows();
    console.log('변경 데이터', modified);

    // 공통 변환 함수: 그리드 row → 서버 HldyVO 형식
function normalizeRows(rows) {
  return (rows || []).map(row => {
    let mmdd = row.hldyMmdd;
    if (mmdd && typeof mmdd === 'string') {
      if (mmdd.length === 10 && mmdd.indexOf('-') === 4) {
        mmdd = mmdd.slice(5); // 'MM-DD'
      }
    }

    return {
      hldyNo: row.hldyNo || null,
      hldyNm: row.hldyNm ? row.hldyNm.trim() : '',
      hldyMmdd: mmdd,
      ynCode: row.ynCode || 'e1'   // ✅ 여기서 e1/e2 그대로 서버로 보냄
    };
  });
}

    const createdRows = normalizeRows(modified.createdRows);
    const updatedRows = normalizeRows(modified.updatedRows);
    const deletedRows = (modified.deletedRows || []).map(row => ({
      hldyNo: row.hldyNo
    }));

    // 프론트 유효성 체크
    const hasInvalid =
      createdRows.some(r => !r.hldyNm || !r.hldyMmdd) ||
      updatedRows.some(r => !r.hldyNm || !r.hldyMmdd);

    if (hasInvalid) {
      alert('월일과 휴일명을 모두 입력해야 저장할 수 있습니다.');
      return;
    }

    const payload = {
      createdRows,
      updatedRows,
      deletedRows
    };

    fetch('/api/hldy/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json;charset=UTF-8' },
      body: JSON.stringify(payload)
    })
      .then(res => {
        if (!res.ok) throw new Error('저장 실패');
        return res.json();
      })
      .then(() => {
        alert('저장되었습니다.');
        loadHldyList();
      })
      .catch(err => {
        console.error(err);
        alert('저장 중 오류가 발생했습니다.');
      });
  });

  /* =====================================================
   * 5. 근무형태 기준 조회 Grid (모달용) - 더미데이터
   * ===================================================== */
  const wkTyGridData = [
    {
      basiNm:  '인사팀 기준근무',
      deptNm:  '인사',
      atdcTm:  '09:00',
      afwkTm:  '18:00',
      hldyTy:  '요일제',
      hldyDesc:'토,일'
    },
    {
      basiNm:  '생산팀 교대근무',
      deptNm:  '생산',
      atdcTm:  '09:00',
      afwkTm:  '21:00',
      hldyTy:  '주기제',
      hldyDesc:'3일근무 3일휴일'
    }
  ];

  let wkTyGrid = null;

  function initWkTyGrid() {
    const gridEl = document.getElementById('gridWkTy');
    if (!gridEl || wkTyGrid) return;

    wkTyGrid = new tui.Grid({
      el: gridEl,
      data: wkTyGridData,
      bodyHeight: 260,
      scrollX: false,
      scrollY: true,
      rowHeaders: [],
      columns: [
        {
          header: '선택',
          name: 'select',
          width: 60,
          align: 'center',
          formatter: ({ rowKey }) =>
            `<input type="radio" name="wkTySelect" value="${rowKey}">`
        },
        { header: '기준명',   name: 'basiNm' },
        { header: '부서명',   name: 'deptNm',  width: 80, align: 'center' },
        { header: '출근시간', name: 'atdcTm',  width: 90, align: 'center' },
        { header: '퇴근시간', name: 'afwkTm',  width: 90, align: 'center' },
        { header: '휴일유형', name: 'hldyTy',  width: 90, align: 'center' },
        { header: '휴일설명', name: 'hldyDesc' }
      ]
    });
  }

  const openBtn = document.getElementById('openGuideModal');
  const modal   = document.getElementById('wkTyModal');
  const back    = document.getElementById('wkTyBackdrop');

  function openModal() {
    if (!modal || !back) return;

    modal.classList.add('show');
    modal.style.display = 'block';
    back.style.display = 'block';

    initWkTyGrid();
    if (wkTyGrid && wkTyGrid.refreshLayout) {
      wkTyGrid.refreshLayout();
    }
  }

  openBtn?.addEventListener('click', openModal);

  /* =====================================================
   * 6. 근무유형 라디오에 따라 영역 토글
   * ===================================================== */
  const rdDay        = document.getElementById('wkTypeDay');
  const rdCycle      = document.getElementById('wkTypeCycle');
  const weekdaySec   = document.getElementById('weekdaySection');
  const cycleSec     = document.getElementById('cycleSection');

  function updateWorkTypeView() {
    if (rdDay.checked) {
      weekdaySec.classList.remove('d-none');
      cycleSec.classList.add('d-none');
    } else {
      weekdaySec.classList.add('d-none');
      cycleSec.classList.remove('d-none');
    }
  }

  rdDay.addEventListener('change', updateWorkTypeView);
  rdCycle.addEventListener('change', updateWorkTypeView);
  updateWorkTypeView();

  /* =====================================================
   * 7. 요일 버튼 선택 토글 + hidden 값
   * ===================================================== */
  const dayButtons = document.querySelectorAll('#weekdaySection button');
  const hiddenWeekdays = document.getElementById('selectedWeekdays');

  function updateHiddenWeekdays() {
    const selectedDays = [];
    dayButtons.forEach(btn => {
      if (btn.classList.contains('selected')) {
        selectedDays.push(btn.dataset.day);
      }
    });
    hiddenWeekdays.value = selectedDays.join(',');
  }

  dayButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      btn.classList.toggle('selected');
      updateHiddenWeekdays();
    });
  });

  /* =====================================================
   * 8. 주기: 근무일 + 휴일 합 최대 7 제한
   * ===================================================== */
  const workDaysInput = document.getElementById('workDays');
  const offDaysInput  = document.getElementById('offDays');

  function applyCycleLimit(changed) {
    let work = parseInt(workDaysInput.value || 0, 10);
    let off  = parseInt(offDaysInput.value  || 0, 10);

    if (isNaN(work)) work = 0;
    if (isNaN(off))  off  = 0;
    if (work < 0) work = 0;
    if (off  < 0) off  = 0;

    let total = work + off;

    if (total > 7) {
      if (changed === 'work') {
        off = 7 - work;
        if (off < 0) {
          off = 0;
          work = 7;
        }
      } else {
        work = 7 - off;
        if (work < 0) {
          work = 0;
          off = 7;
        }
      }
    }

    workDaysInput.value = work;
    offDaysInput.value  = off;
  }

  workDaysInput.addEventListener('input', () => applyCycleLimit('work'));
  offDaysInput.addEventListener('input',  () => applyCycleLimit('off'));

  /* =====================================================
   * 9. 시간 아이콘 클릭 → 브라우저 시간 선택창 열기
   * ===================================================== */
  function bindTimeIcon(inputId, iconId) {
    const input = document.getElementById(inputId);
    const icon  = document.getElementById(iconId);
    if (!input || !icon) return;

    icon.addEventListener('click', () => {
      if (typeof input.showPicker === 'function') {
        input.showPicker();
      } else {
        input.focus();
      }
    });
  }

  bindTimeIcon('startTime', 'startTimeIcon');
  bindTimeIcon('endTime',   'endTimeIcon');
</script>

</body>
</html>
