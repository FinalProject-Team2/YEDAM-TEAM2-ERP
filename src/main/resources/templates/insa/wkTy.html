<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
  <meta charset="UTF-8">
  <title>wkTy</title>

  <!-- âœ… Toast UI ê³µí†µ ìœ í‹¸ -->
  <script src="https://uicdn.toast.com/tui-code-snippet/latest/tui-code-snippet.js"></script>

  <!-- âœ… Date / Time Picker -->
  <link rel="stylesheet"
        href="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.css">
  <link rel="stylesheet"
        href="https://uicdn.toast.com/tui.time-picker/latest/tui.time-picker.css">

  <script src="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.js"></script>
  <script src="https://uicdn.toast.com/tui.time-picker/latest/tui.time-picker.js"></script>

  <!-- âœ… Grid -->
  <link rel="stylesheet"
        href="https://uicdn.toast.com/grid/latest/tui-grid.css">
  <script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>

  <style>
    .wk-panel {
      border: 1px solid #dedede;
      border-radius: 18px;
      padding: 24px 26px;
      background-color: #fff;
    }
    .wk-panel .form-label {
      font-weight: 500;
    }
    .wk-time-range .form-control {
      height: 36px;
      padding-top: 4px;
      padding-bottom: 4px;
    }
    .wk-time-range .input-group-text {
      font-size: 0.85rem;
      cursor: pointer;
    }
    .wk-dot {
      display: inline-block;
      margin: 0 8px;
      font-size: 18px;
      line-height: 36px;
    }
    .wk-day-buttons .btn {
      min-width: 38px;
      padding: 4px 0;
      font-size: 0.85rem;
      border-radius: 0;
    }
    .wk-day-buttons .btn:first-child {
      border-radius: 10px 0 0 10px;
    }
    .wk-day-buttons .btn:last-child {
      border-radius: 0 10px 10px 0;
    }
    .wk-day-buttons .btn.selected {
      background-color: #0d6efd;
      color: #fff;
      border-color: #0d6efd;
    }
    .wk-radio-group {
      display: flex;
      align-items: center;
      gap: 24px;
      margin-top: 4px;
    }
    .wk-radio {
      display: flex;
      align-items: center;
      gap: 6px;
      margin: 0;
    }
    .wk-radio input[type="radio"] {
      margin: 0;
    }

    /* âœ… time ì¸í’‹ ë‚´ë¶€ ê¸°ë³¸ ì‹œê³„ ì•„ì´ì½˜ ì œê±° (í¬ë¡¬/ì—£ì§€ ë“±) */
    input[type="time"]::-webkit-calendar-picker-indicator {
      display: none;
    }
    input[type="time"]::-webkit-inner-spin-button,
    input[type="time"]::-webkit-clear-button {
      display: none;
    }
  </style>
</head>
<body layout:fragment="content">
<div class="row">

  <!-- ================== íœ´ì¼ ê¸°ì¤€ ê´€ë¦¬ ================== -->
  <div class="col-md-6">
    <div class="card mb-3">
      <div class="card-header">
        <h5 class="card-title">íœ´ì¼ ê¸°ì¤€ ê´€ë¦¬</h5>
        <div class="card-header-right">
          <button class="btn btn-danger" id="btnHldyDel">ì‚­ì œ</button>
          <button class="btn btn-outline-dark" id="btnHldyAdd">í–‰ì¶”ê°€</button>
          <button class="btn btn-outline-dark" id="btnHldySave">ì €ì¥</button>
        </div>
      </div>
      <div class="card-body">
        <div id="gridHldy" class="mt-3"></div>
      </div>
    </div>
  </div>

  <!-- ================== ê·¼ë¬´í˜•íƒœ ê¸°ì¤€ ê´€ë¦¬ ================== -->
  <div class="col-md-6">
    <div class="card mb-3">
      <div class="card-header mb-3">
        <h5 class="card-title">ê·¼ë¬´í˜•íƒœ ê¸°ì¤€ ê´€ë¦¬</h5>
        <div class="card-header-right">
          <button class="btn btn-dark">ì´ˆê¸°í™”</button>
          <button class="btn btn-danger">ì‚­ì œ</button>
          <button class="btn btn-outline-dark">ì €ì¥</button>
          <button class="btn btn-outline-dark" id="openGuideModal">ì¡°íšŒ</button>
        </div>
      </div>

      <div class="card-body">
        <div class="wk-panel">
          <!-- ê¸°ì¤€ëª… / ë¶€ì„œëª… -->
          <div class="row mb-3">
            <div class="col-6">
              <label for="stdNm" class="form-label">ê¸°ì¤€ëª…</label>
              <input type="text" id="stdNm" class="form-control" />
            </div>
            <div class="col-6">
              <label for="deptNm" class="form-label">ë¶€ì„œëª…</label>
              <select id="deptNm" class="form-select">
                <option value="">ì„ íƒ</option>
              </select>
            </div>
          </div>

          <!-- ì¶œê·¼ì‹œê°„ / í‡´ê·¼ì‹œê°„ -->
          <div class="row mb-4 wk-time-range">
            <div class="col-5">
              <label for="startTime" class="form-label">ì¶œê·¼ì‹œê°„</label>
              <div class="input-group">
                <input type="time" id="startTime" class="form-control">
                <span class="input-group-text" id="startTimeIcon">â±</span>
              </div>
            </div>
            <div class="col-2 d-flex align-items-end justify-content-center">
              <span class="wk-dot">~</span>
            </div>
            <div class="col-5">
              <label for="endTime" class="form-label">í‡´ê·¼ì‹œê°„</label>
              <div class="input-group">
                <input type="time" id="endTime" class="form-control">
                <span class="input-group-text" id="endTimeIcon">â±</span>
              </div>
            </div>
          </div>

          <!-- ê·¼ë¬´ìœ í˜• (ìš”ì¼ / ì£¼ê¸°) -->
          <div class="mb-2">
            <label class="form-label d-block">ê·¼ë¬´ìœ í˜•</label>
            <div class="wk-radio-group">
              <label class="wk-radio">
                <input type="radio" name="wkType" id="wkTypeDay" value="DAY" checked>
                <span>ìš”ì¼</span>
              </label>
              <label class="wk-radio">
                <input type="radio" name="wkType" id="wkTypeCycle" value="CYCLE">
                <span>ì£¼ê¸°</span>
              </label>
            </div>
          </div>

          <!-- ìš”ì¼ ë²„íŠ¼ ì˜ì—­ -->
          <div id="weekdaySection" class="wk-day-buttons mb-4">
            <div class="btn-group" role="group" aria-label="weekday">
              <button type="button" class="btn btn-outline-primary btn-sm" data-day="MON">ì›”</button>
              <button type="button" class="btn btn-outline-primary btn-sm" data-day="TUE">í™”</button>
              <button type="button" class="btn btn-outline-primary btn-sm" data-day="WED">ìˆ˜</button>
              <button type="button" class="btn btn-outline-primary btn-sm" data-day="THU">ëª©</button>
              <button type="button" class="btn btn-outline-primary btn-sm" data-day="FRI">ê¸ˆ</button>
              <button type="button" class="btn btn-outline-primary btn-sm" data-day="SAT">í† </button>
              <button type="button" class="btn btn-outline-primary btn-sm" data-day="SUN">ì¼</button>
            </div>
          </div>

          <!-- ì£¼ê¸° ì˜ì—­ -->
          <div id="cycleSection" class="row g-3 mb-2 d-none">
            <div class="col-6">
              <label for="workDays" class="form-label">ê·¼ë¬´ì¼</label>
              <div class="input-group">
                <input type="number" id="workDays" class="form-control" min="0">
                <span class="input-group-text">ì¼</span>
              </div>
            </div>
            <div class="col-6">
              <label for="offDays" class="form-label">íœ´ì¼</label>
              <div class="input-group">
                <input type="number" id="offDays" class="form-control" min="0">
                <span class="input-group-text">ì¼</span>
              </div>
            </div>
          </div>

          <input type="hidden" id="selectedWeekdays" name="selectedWeekdays" value="">
        </div>
      </div>
    </div>
  </div>
</div>

<!-- âœ… ê·¼ë¬´í˜•íƒœ ê¸°ì¤€ ì¡°íšŒ ëª¨ë‹¬ -->
<div th:replace="insa/modal/wkTyModal :: wkTyModal"></div>

<script>
  /* =====================================================
   * 1. Grid ê³µí†µ ì˜µì…˜
   * ===================================================== */
  const GridOptions = {
    bodyHeight: 600,
    scrollX: false,
    scrollY: false,
    rowHeaders: ['checkbox'],
    columnOptions: {
      minWidth: 80,
      resizable: true
    }
  };

  /* =====================================================
   * 2. íœ´ì¼ ë°ì´í„°
   * ===================================================== */
  const hldyGridData = [
    { hldyDt: '2025-01-01', hldyNm: 'ì‹ ì •',   yn: 'Y' },
    { hldyDt: '2025-02-10', hldyNm: 'ì„¤ë‚ ',   yn: 'Y' },
    { hldyDt: '2025-03-01', hldyNm: 'ì‚¼ì¼ì ˆ', yn: 'Y' },
    { hldyDt: '2025-05-05', hldyNm: 'ì–´ë¦°ì´ë‚ ', yn: 'Y' },
    { hldyDt: '2025-06-06', hldyNm: 'í˜„ì¶©ì¼', yn: 'Y' },
    { hldyDt: '2025-08-15', hldyNm: 'ê´‘ë³µì ˆ', yn: 'Y' },
    { hldyDt: '2025-09-17', hldyNm: 'ì¶”ì„',   yn: 'Y' },
    { hldyDt: '2025-10-03', hldyNm: 'ê°œì²œì ˆ', yn: 'Y' },
    { hldyDt: '2025-10-09', hldyNm: 'í•œê¸€ë‚ ', yn: 'Y' },
    { hldyDt: '2025-12-25', hldyNm: 'ì„±íƒ„ì ˆ', yn: 'N' }
  ];

  /* =====================================================
   * 3. íœ´ì¼ ê¸°ì¤€ Grid (yn â†’ ì‚¬ìš©/ë¯¸ì‚¬ìš© í‘œì‹œ)
   * ===================================================== */
  const hldyGrid = new tui.Grid({
    el: document.getElementById('gridHldy'),
    data: hldyGridData,
    ...GridOptions,
    editingType: 'cell',
    columns: [
      {
        header: 'ì›”ì¼',
        name: 'hldyDt',
        align: 'center',
        editor: {
          type: 'datePicker',
          options: {
            format: 'yyyy-MM-dd',
            language: 'ko'
          }
        },
        formatter: ({ value }) => {
          if (!value) return '';
          return value.slice(5);
        }
      },
      {
        header: 'íœ´ì¼ëª…',
        name: 'hldyNm',
        editor: 'text'
      },
      {
        header: 'ì‚¬ìš©ì—¬ë¶€',
        name: 'yn',
        editor: {
          type: 'select',
          options: {
            listItems: [
              { text: 'ì‚¬ìš©',   value: 'Y' },
              { text: 'ë¯¸ì‚¬ìš©', value: 'N' }
            ]
          }
        },
        formatter: ({ value }) => value === 'Y' ? 'ì‚¬ìš©' : 'ë¯¸ì‚¬ìš©'
      }
    ]
  });

  /* =====================================================
   * 4. íœ´ì¼ ê¸°ì¤€ í–‰ì¶”ê°€/ì‚­ì œ/ì €ì¥
   * ===================================================== */
  document.getElementById('btnHldyAdd').addEventListener('click', () => {
    hldyGrid.prependRow({
      hldyDt: '',
      hldyNm: '',
      yn: 'Y'
    }, { focus: true });
  });

  document.getElementById('btnHldyDel').addEventListener('click', () => {
    const checked = hldyGrid.getCheckedRowKeys();
    hldyGrid.removeRows(checked);
  });

  document.getElementById('btnHldySave').addEventListener('click', () => {
    const modified = hldyGrid.getModifiedRows();
    console.log('ë³€ê²½ ë°ì´í„°', modified);
  });
  /* =====================================================
   * 5. ê·¼ë¬´í˜•íƒœ ê¸°ì¤€ ì¡°íšŒ Grid ë°ì´í„° (ëª¨ë‹¬ìš©)
   *    ì»¬ëŸ¼ name ìˆœì„œ: basiNm, deptNm, atdcTm, afwkTm, hldyTy, hldyDesc
   * ===================================================== */
  const wkTyGridData = [
    {
      basiNm:  'ì¸ì‚¬íŒ€ ê¸°ì¤€ê·¼ë¬´',
      deptNm:  'ì¸ì‚¬',
      atdcTm:  '09:00',
      afwkTm:  '18:00',
      hldyTy:  'ìš”ì¼ì œ',
      hldyDesc:'í† ,ì¼'
    },
    {
      basiNm:  'ìƒì‚°íŒ€ êµëŒ€ê·¼ë¬´',
      deptNm:  'ìƒì‚°',
      atdcTm:  '09:00',
      afwkTm:  '21:00',
      hldyTy:  'ì£¼ê¸°ì œ',
      hldyDesc:'3ì¼ê·¼ë¬´ 3ì¼íœ´ì¼'
    }
  ];

  /* =====================================================
   * 6. ê·¼ë¬´í˜•íƒœ ê¸°ì¤€ ì¡°íšŒ Grid (ëª¨ë‹¬ ì•ˆ)
   *    ğŸ‘‰ ë„˜ë²„(rowHeaders) ì œê±° + ë¼ë””ì˜¤ ì»¬ëŸ¼ ë§¨ ì•
   * ===================================================== */
  let wkTyGrid = null;

  function initWkTyGrid() {
    const gridEl = document.getElementById('gridWkTy');
    if (!gridEl || wkTyGrid) return;

    wkTyGrid = new tui.Grid({
      el: gridEl,
      data: wkTyGridData,
      bodyHeight: 260,
      scrollX: false,
      scrollY: true,
      rowHeaders: [],          // âœ… ë„˜ë²„ ì œê±°
      columns: [
        {
          header: 'ì„ íƒ',      // âœ… ë¼ë””ì˜¤ ë²„íŠ¼ ë§¨ ì•
          name: 'select',
          width: 60,
          align: 'center',
          formatter: ({ rowKey }) =>
            `<input type="radio" name="wkTySelect" value="${rowKey}">`
        },
        { header: 'ê¸°ì¤€ëª…',   name: 'basiNm' },
        { header: 'ë¶€ì„œëª…',   name: 'deptNm',  width: 80, align: 'center' },
        { header: 'ì¶œê·¼ì‹œê°„', name: 'atdcTm',  width: 90, align: 'center' },
        { header: 'í‡´ê·¼ì‹œê°„', name: 'afwkTm',  width: 90, align: 'center' },
        { header: 'íœ´ì¼ìœ í˜•', name: 'hldyTy',  width: 90, align: 'center' },
        { header: 'íœ´ì¼ì„¤ëª…', name: 'hldyDesc' }  // ë‹ˆê°€ ì„ì˜ë¡œ ë„£ìœ¼ë¼ í–ˆë˜ ë§ˆì§€ë§‰ ì»¬ëŸ¼
      ]
    });
  }

  /* =====================================================
   * 7. ëª¨ë‹¬ ì˜¤í”ˆ (ê·¸ëŒ€ë¡œ ì‚¬ìš©)
   * ===================================================== */
  const openBtn = document.getElementById('openGuideModal');
  const modal   = document.getElementById('wkTyModal');
  const back    = document.getElementById('wkTyBackdrop');

  function openModal() {
    if (!modal || !back) return;

    modal.classList.add('show');
    modal.style.display = 'block';
    back.style.display = 'block';

    initWkTyGrid();
    if (wkTyGrid && wkTyGrid.refreshLayout) {
      wkTyGrid.refreshLayout();
    }
  }

  openBtn?.addEventListener('click', openModal);

  /* =====================================================
   * 8. ê·¼ë¬´ìœ í˜• ë¼ë””ì˜¤ì— ë”°ë¼ ì˜ì—­ í† ê¸€
   * ===================================================== */
  const rdDay        = document.getElementById('wkTypeDay');
  const rdCycle      = document.getElementById('wkTypeCycle');
  const weekdaySec   = document.getElementById('weekdaySection');
  const cycleSec     = document.getElementById('cycleSection');

  function updateWorkTypeView() {
    if (rdDay.checked) {
      weekdaySec.classList.remove('d-none');
      cycleSec.classList.add('d-none');
    } else {
      weekdaySec.classList.add('d-none');
      cycleSec.classList.remove('d-none');
    }
  }

  rdDay.addEventListener('change', updateWorkTypeView);
  rdCycle.addEventListener('change', updateWorkTypeView);
  updateWorkTypeView();

  /* =====================================================
   * 9. ìš”ì¼ ë²„íŠ¼ ì„ íƒ í† ê¸€ + hidden ê°’
   * ===================================================== */
  const dayButtons = document.querySelectorAll('#weekdaySection button');
  const hiddenWeekdays = document.getElementById('selectedWeekdays');

  function updateHiddenWeekdays() {
    const selectedDays = [];
    dayButtons.forEach(btn => {
      if (btn.classList.contains('selected')) {
        selectedDays.push(btn.dataset.day);
      }
    });
    hiddenWeekdays.value = selectedDays.join(',');
  }

  dayButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      btn.classList.toggle('selected');
      updateHiddenWeekdays();
    });
  });

  /* =====================================================
   * 10. ì£¼ê¸°: ê·¼ë¬´ì¼ + íœ´ì¼ í•© ìµœëŒ€ 7 ì œí•œ
   * ===================================================== */
  const workDaysInput = document.getElementById('workDays');
  const offDaysInput  = document.getElementById('offDays');

  function applyCycleLimit(changed) {
    let work = parseInt(workDaysInput.value || 0, 10);
    let off  = parseInt(offDaysInput.value  || 0, 10);

    if (isNaN(work)) work = 0;
    if (isNaN(off))  off  = 0;
    if (work < 0) work = 0;
    if (off  < 0) off  = 0;

    let total = work + off;

    if (total > 7) {
      if (changed === 'work') {
        off = 7 - work;
        if (off < 0) {
          off = 0;
          work = 7;
        }
      } else {
        work = 7 - off;
        if (work < 0) {
          work = 0;
          off = 7;
        }
      }
    }

    workDaysInput.value = work;
    offDaysInput.value  = off;
  }

  workDaysInput.addEventListener('input', () => applyCycleLimit('work'));
  offDaysInput.addEventListener('input',  () => applyCycleLimit('off'));

  /* =====================================================
   * 11. ì‹œê°„ ì•„ì´ì½˜ í´ë¦­ â†’ ë¸Œë¼ìš°ì € ì‹œê°„ ì„ íƒì°½ ì—´ê¸°
   * ===================================================== */
  function bindTimeIcon(inputId, iconId) {
    const input = document.getElementById(inputId);
    const icon  = document.getElementById(iconId);
    if (!input || !icon) return;

    icon.addEventListener('click', () => {
      if (typeof input.showPicker === 'function') {
        input.showPicker();
      } else {
        input.focus();
      }
    });
  }

  bindTimeIcon('startTime', 'startTimeIcon');
  bindTimeIcon('endTime',   'endTimeIcon');
</script>
</body>
</html>
