<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <meta charset="UTF-8">
    <title>allowDuc</title>
    <style>
        /* ===========================
         * 탭 스타일 (입체감 / 그림자 버전)
         * =========================== */
        .nav-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 0;
        }

        .nav-tabs .nav-item {
            margin-bottom: -1px;
        }

        .nav-tabs .nav-link {
            border-radius: 10px 10px 0 0;
            padding: 8px 20px;
            background-color: #f7f8fa;
            color: #a1a6ad;
            font-weight: 500;
            border: 1px solid #d1d5db;
            border-bottom-color: #d1d5db;
            box-shadow: inset 0 -2px 0 rgba(0,0,0,0.03);
            transition: background-color 0.15s ease,
                        color 0.15s ease,
                        box-shadow 0.15s ease;
        }

        .nav-tabs .nav-item + .nav-item .nav-link {
            margin-left: -1px;
        }

        .nav-tabs .nav-link:not(.active):hover {
            background-color: #eff1f4;
            color: #7a7f87;
        }

        .nav-tabs .nav-link.active {
            background-color: #ffffff;
            color: #111111;
            font-weight: 600;
            border-color: #d1d5db;
            border-bottom-color: #ffffff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.06);
            z-index: 2;
        }

        .tab-pane {
            display: none;
            margin-top: 0;
            padding-top: 0;
        }

        .tab-pane.active {
            display: block;
        }

        .card-body > .mt-3 {
            margin-top: 0 !important;
        }

        .nav-tabs {
            border-bottom: none !important;
        }
    </style>
</head>
<body layout:fragment="content">

<div class="row">
    <div class="col-md-12">
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="card-title">수당/공제 항목 관리</h5>
                <div class="card-header-right">
                    <button class="btn btn-danger" id="btnRowDel">삭제</button>
                    <button class="btn btn-outline-dark" id="btnRowAdd">행추가</button>
                    <button class="btn btn-outline-dark" id="openGuideModal">가이드</button>
                    <button class="btn btn-outline-dark" id="btnSave">저장</button>
                </div>
            </div>

            <div class="card-body">
                <!-- 탭 헤더 -->
                <ul class="nav nav-tabs" id="allowDucTab">
                    <li class="nav-item">
                        <button class="nav-link active" type="button" data-target="#tab-allow">
                            수당
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" type="button" data-target="#tab-duc">
                            공제
                        </button>
                    </li>
                </ul>

                <!-- 탭별 그리드 영역 -->
                <div class="mt-3">
                    <!-- 수당 탭 -->
                    <div id="tab-allow" class="tab-pane active">
                        <div id="gridAllow"></div>
                    </div>

                    <!-- 공제 탭 -->
                    <div id="tab-duc" class="tab-pane">
                        <div id="gridDuc"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div th:replace="insa/modal/guideModal :: guideModal"></div>

<script>
    /* =====================================================
     * 1. Grid 옵션
     * ===================================================== */
    const GridOptions = {
        bodyHeight: 580,
        scrollX: false,
        scrollY: false,
        rowHeaders: ['checkbox'],
        columnOptions: {
            minWidth: 80,
            resizable: true
        }
    };

    /* =====================================================
     * 2. 더미 데이터
     * ===================================================== */
    const allowGridData = [
        { allowId: 'ALW001', allowNm: '기본급',     dispNo: 1,  calFmlt: 'FIXED',          calMthd: '정액',     yn: 'Y' },
        { allowId: 'ALW002', allowNm: '직책수당',   dispNo: 2,  calFmlt: 'FIXED',          calMthd: '정액',     yn: 'Y' },
        { allowId: 'ALW003', allowNm: '연장수당',   dispNo: 3,  calFmlt: 'WORK_HOUR*1.5',  calMthd: '근태연동', yn: 'Y' },
        { allowId: 'ALW004', allowNm: '야간수당',   dispNo: 4,  calFmlt: 'WORK_HOUR*2',    calMthd: '근태연동', yn: 'Y' },
        { allowId: 'ALW005', allowNm: '휴일수당',   dispNo: 5,  calFmlt: 'WORK_HOUR*1.5',  calMthd: '근태연동', yn: 'Y' },
        { allowId: 'ALW006', allowNm: '성과급',     dispNo: 6,  calFmlt: 'BASIC_PAY*0.1',  calMthd: '비율',     yn: 'Y' },
        { allowId: 'ALW007', allowNm: '식대',       dispNo: 7,  calFmlt: 'FIXED',          calMthd: '정액',     yn: 'Y' },
        { allowId: 'ALW008', allowNm: '교통비',     dispNo: 8,  calFmlt: 'FIXED',          calMthd: '정액',     yn: 'N' },
        { allowId: 'ALW009', allowNm: '자격수당',   dispNo: 9,  calFmlt: 'FIXED',          calMthd: '정액',     yn: 'Y' },
        { allowId: 'ALW010', allowNm: '특별보너스', dispNo: 10, calFmlt: 'MANUAL',         calMthd: '수기입력', yn: 'Y' }
    ];

    const ducGridData = [
        { ducId: 'DUC001', ducNm: '소득세',     dispNo: 1,  calFmlt: 'INCOME*0.1',  calMthd: '비율',     yn: 'Y' },
        { ducId: 'DUC002', ducNm: '지방세',     dispNo: 2,  calFmlt: 'INCOME*0.02', calMthd: '비율',     yn: 'Y' },
        { ducId: 'DUC003', ducNm: '국민연금',   dispNo: 3,  calFmlt: 'PAY*0.045',   calMthd: '비율',     yn: 'Y' },
        { ducId: 'DUC004', ducNm: '건강보험',   dispNo: 4,  calFmlt: 'PAY*0.035',   calMthd: '비율',     yn: 'Y' },
        { ducId: 'DUC005', ducNm: '고용보험',   dispNo: 5,  calFmlt: 'PAY*0.009',   calMthd: '비율',     yn: 'Y' },
        { ducId: 'DUC006', ducNm: '노조비',     dispNo: 6,  calFmlt: 'FIXED',       calMthd: '정액',     yn: 'N' },
        { ducId: 'DUC007', ducNm: '상조회비',   dispNo: 7,  calFmlt: 'FIXED',       calMthd: '정액',     yn: 'Y' },
        { ducId: 'DUC008', ducNm: '대출상환금', dispNo: 8,  calFmlt: 'FIXED',       calMthd: '정액',     yn: 'Y' },
        { ducId: 'DUC009', ducNm: '식대공제',   dispNo: 9,  calFmlt: 'FIXED',       calMthd: '정액',     yn: 'N' },
        { ducId: 'DUC010', ducNm: '기타공제',   dispNo: 10, calFmlt: 'MANUAL',      calMthd: '수기입력', yn: 'Y' }
    ];

    /* =====================================================
     * 3. Grid 생성
     * ===================================================== */
    const allowGrid = new tui.Grid({
        el: document.getElementById('gridAllow'),
        data: allowGridData,
        ...GridOptions,
        editingType: 'cell',
        columns: [
            { header: '수당ID',   name: 'allowId' },
            { header: '수당명',   name: 'allowNm', editor: 'text' },
            { header: '표시번호', name: 'dispNo',  editor: 'text' },
            { header: '계산식',   name: 'calFmlt', editor: 'text' },
            { header: '산출방법', name: 'calMthd', editor: 'text' },
            {
                header: '사용여부',
                name: 'yn',
                editor: {
                    type: 'select',
                    options: {
                        listItems: [
                            { text: '사용', value: 'Y' },
                            { text: '미사용', value: 'N' }
                        ]
                    }
                }
            }
        ]
    });

    const ducGrid = new tui.Grid({
        el: document.getElementById('gridDuc'),
        data: ducGridData,
        ...GridOptions,
        editingType: 'cell',
        columns: [
            { header: '공제ID',   name: 'ducId' },
            { header: '공제명',   name: 'ducNm',  editor: 'text' },
            { header: '표시번호', name: 'dispNo', editor: 'text' },
            { header: '계산식',   name: 'calFmlt', editor: 'text' },
            { header: '산출방법', name: 'calMthd', editor: 'text' },
            {
                header: '사용여부',
                name: 'yn',
                editor: {
                    type: 'select',
                    options: {
                        listItems: [
                            { text: '사용', value: 'Y' },
                            { text: '미사용', value: 'N' }
                        ]
                    }
                }
            }
        ]
    });

    /* =====================================================
     * 4. 탭 전환
     * ===================================================== */
    const tabButtons = document.querySelectorAll('#allowDucTab .nav-link');
    const tabPanes = {
        '#tab-allow': document.getElementById('tab-allow'),
        '#tab-duc':   document.getElementById('tab-duc')
    };

    tabButtons.forEach(btn => {
        btn.addEventListener('click', function () {
            const target = this.getAttribute('data-target');

            tabButtons.forEach(b => b.classList.remove('active'));
            this.classList.add('active');

            Object.keys(tabPanes).forEach(key => {
                if (key === target) {
                    tabPanes[key].classList.add('active');
                } else {
                    tabPanes[key].classList.remove('active');
                }
            });

            if (target === '#tab-allow') {
                allowGrid.refreshLayout();
            } else if (target === '#tab-duc') {
                ducGrid.refreshLayout();
            }
        });
    });

    /* =====================================================
     * 5. 모달
     * ===================================================== */
    const openBtn = document.getElementById('openGuideModal');
    const modal   = document.getElementById('guideModal');
    const back    = document.getElementById('guideBackdrop');

    function openModal() {
        if (!modal || !back) return;
        modal.classList.add('show');
        modal.style.display = 'block';
        back.style.display = 'block';

        if (typeof grid2 !== 'undefined' && grid2 && grid2.refreshLayout) {
            grid2.refreshLayout();
        }
    }

    if (openBtn) {
        openBtn.addEventListener('click', openModal);
    }

    /* =====================================================
     * 6. 공통 유틸: 전체 행(rowKey/dispNo + 전체 row 데이터) 가져오기
     * ===================================================== */
    function getAllRowInfos(grid) {
        const count = grid.getRowCount();
        const infos = [];
        for (let i = 0; i < count; i++) {
            const row = grid.getRowAt(i);   // { rowKey, dispNo, ... }
            infos.push({
                rowKey: row.rowKey,
                dispNo: parseInt(row.dispNo, 10),
                rowData: row
            });
        }
        return infos;
    }

    /* =====================================================
     * 7. 활성 탭의 Grid
     * ===================================================== */
    function getActiveGrid() {
        const activeTabBtn = document.querySelector('#allowDucTab .nav-link.active');
        if (!activeTabBtn) return null;

        const target = activeTabBtn.getAttribute('data-target');
        if (target === '#tab-allow') return { grid: allowGrid, type: 'ALLOW' };
        if (target === '#tab-duc')   return { grid: ducGrid,   type: 'DUC' };
        return null;
    }

    /* =====================================================
     * 8. 다음 표시번호 (마지막 + 1)
     * ===================================================== */
    function getNextDispNo(grid) {
        const rows = getAllRowInfos(grid);
        if (rows.length === 0) return 1;

        let maxNo = 0;
        rows.forEach(r => {
            if (!isNaN(r.dispNo) && r.dispNo > maxNo) {
                maxNo = r.dispNo;
            }
        });
        return maxNo + 1;
    }

    /* =====================================================
     * 9. 표시번호 기준으로 전체 재정렬 + 1..N으로 재번호
     * ===================================================== */
    function rebuildByDispNo(grid) {
        const infos = getAllRowInfos(grid);

        // dispNo 기준 정렬
        infos.sort((a, b) => {
            const av = isNaN(a.dispNo) ? 9999 : a.dispNo;
            const bv = isNaN(b.dispNo) ? 9999 : b.dispNo;
            if (av === bv) return a.rowKey - b.rowKey;
            return av - bv;
        });

        // 정렬 순서대로 1..N 재부여
        const newData = infos.map((info, idx) => ({
            ...info.rowData,
            dispNo: idx + 1
        }));

        grid.resetData(newData);
    }

    /* =====================================================
     * 10. 행추가 (표시번호 자동 세팅 → 이후 전체 재정렬)
     * ===================================================== */
    const btnRowAdd = document.getElementById('btnRowAdd');

    if (btnRowAdd) {
        btnRowAdd.addEventListener('click', () => {
            const active = getActiveGrid();
            if (!active) return;

            const { grid, type } = active;
            const nextDispNo = getNextDispNo(grid);

            if (type === 'ALLOW') {
                grid.prependRow(
                    {
                        allowId: '',
                        allowNm: '',
                        dispNo: nextDispNo,
                        calFmlt: '',
                        calMthd: '',
                        yn: 'Y'
                    },
                    { focus: true }
                );
            } else if (type === 'DUC') {
                grid.prependRow(
                    {
                        ducId: '',
                        ducNm: '',
                        dispNo: nextDispNo,
                        calFmlt: '',
                        calMthd: '',
                        yn: 'Y'
                    },
                    { focus: true }
                );
            }

            rebuildByDispNo(grid);
        });
    }

    /* =====================================================
     * 11. 선택 삭제
     * ===================================================== */
    const btnRowDel = document.getElementById('btnRowDel');

    if (btnRowDel) {
        btnRowDel.addEventListener('click', () => {
            const active = getActiveGrid();
            if (!active) return;

            const { grid } = active;
            const count = grid.getRowCount();
            const toRemove = [];

            for (let i = 0; i < count; i++) {
                const row = grid.getRowAt(i);
                if (row._attributes && row._attributes.checked) {
                    toRemove.push(row.rowKey);
                }
            }
            grid.removeRows(toRemove);

            rebuildByDispNo(grid);
        });
    }

    /* =====================================================
     * 12. 저장 (콘솔)
     * ===================================================== */
    const btnSave = document.getElementById('btnSave');

    if (btnSave) {
        btnSave.addEventListener('click', () => {
            const allowModified = allowGrid.getModifiedRows();
            const ducModified   = ducGrid.getModifiedRows();

            console.log('수당 변경 데이터', allowModified);
            console.log('공제 변경 데이터', ducModified);
        });
    }

    /* =====================================================
     * 13. 표시번호 변경 시: 새 번호 위치에 끼워 넣고 전체 재정렬
     * ===================================================== */
    let isDispNoUpdating = false;

    function reorderDispNo(grid, changedRowKey, newDispNoRaw) {
        let newDispNo = parseInt(newDispNoRaw, 10);
        if (isNaN(newDispNo) || newDispNo <= 0) {
            return;
        }

        const infos = getAllRowInfos(grid);
        if (infos.length === 0) return;

        const targetInfo = infos.find(info => info.rowKey === changedRowKey);
        if (!targetInfo) return;

        const others = infos
            .filter(info => info.rowKey !== changedRowKey)
            .sort((a, b) => {
                const av = isNaN(a.dispNo) ? 9999 : a.dispNo;
                const bv = isNaN(b.dispNo) ? 9999 : b.dispNo;
                if (av === bv) return a.rowKey - b.rowKey;
                return av - bv;
            });

        let insertIndex = newDispNo - 1;
        if (insertIndex < 0) insertIndex = 0;
        if (insertIndex > others.length) insertIndex = others.length;

        const orderedInfos = [...others];
        orderedInfos.splice(insertIndex, 0, targetInfo);

        const newData = orderedInfos.map((info, idx) => ({
            ...info.rowData,
            dispNo: idx + 1
        }));

        isDispNoUpdating = true;
        grid.resetData(newData);
        isDispNoUpdating = false;
    }

    function attachDispNoHandler(grid) {
        grid.on('editingFinish', (ev) => {
            if (isDispNoUpdating) return;
            if (ev.columnName !== 'dispNo') return;

            const newVal = (ev.value !== undefined && ev.value !== null)
                ? ev.value
                : grid.getValue(ev.rowKey, 'dispNo');

            reorderDispNo(grid, ev.rowKey, newVal);
        });
    }

    attachDispNoHandler(allowGrid);
    attachDispNoHandler(ducGrid);

    /* =====================================================
     * 14. 초기에도 한 번 정렬
     * ===================================================== */
    rebuildByDispNo(allowGrid);
    rebuildByDispNo(ducGrid);
</script>
</body>
</html>
