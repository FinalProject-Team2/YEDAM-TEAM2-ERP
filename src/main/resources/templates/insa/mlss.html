<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout}">
<head>
<meta charset="UTF-8">
<title>mlss.html</title>

<style>
.form-select {
	color: #000 !important;
}
/* ì¶”ê°€ CSS */
.readonly-input[readonly] {
	background-color: #e9ecef; /* Bootstrap ê¸°ë³¸ disabled ìƒ‰ìƒ */
	cursor: not-allowed; /* ë§ˆìš°ìŠ¤ ì»¤ì„œë„ ì…ë ¥ ë¶ˆê°€ ëŠë‚Œ */
}

.stIsShow {
	display: none;
}

.menu-item {
	cursor: pointer; /* ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´ ì†ê°€ë½ ëª¨ì–‘ */
}
</style>
</head>
<body layout:fragment="content">
	<div class="row">
		<div class="col-md-12">
			<div class="card mb-3">
				<!-- ì¹´ë“œ í—¤ë” : ì œëª© + ì´ˆê¸°í™”/ì¡°íšŒ ë²„íŠ¼ -->
				<div class="card-header">
					<div class="card-header-left">
						<h5 class="card-title">í‰ê°€ ì§„í–‰ í˜„í™© ë°•ìŠ¤</h5>
					</div>					
				</div>
				<div class="card-body">

					<div class="row mb-2">
						<div class="col-md-2">
							<label class="form-label">ë³¸ì¸ í‰ê°€ ì™„ë£Œ ì—¬ë¶€</label> <input type="text"
								value="0 / 3" class="form-control" />
						</div>
						<div class="col-md-2">
							<label class="form-label">ìƒì‚¬ í‰ê°€ ì™„ë£Œ ì—¬ë¶€</label> <input type="text"
								value="0 / 2" class="form-control" />
						</div>
						<div class="col-md-2">
							<label class="form-label">ë™ë£Œ í‰ê°€ ì™„ë£Œ ì—¬ë¶€</label> <input type="text"
								value="0 / 5" class="form-control" />
						</div>
						<div class="col-md-6">
								<label for="userName" class="form-label">ê¸°ê°„</label>
								<div class="d-flex align-items-center js-date-range">

										<!-- ì‹œì‘ì¼ -->
										<div class="input-group date">
											<input type="text"
												class="form-control datepicker js-date-range-start"
												placeholder="ì‹œì‘ì¼"> <span
												class="input-group-text js-date-range-icon-start"> <i
												class="bi bi-calendar"></i>
											</span>
										</div>

										<span class="mx-1 fw-bold fs-5">~</span>

										<!-- ì¢…ë£Œì¼ -->
										<div class="input-group date ms-2">
											<input type="text"
												class="form-control datepicker js-date-range-end"
												placeholder="ì¢…ë£Œì¼"> <span
												class="input-group-text js-date-range-icon-end"> <i
												class="bi bi-calendar"></i>
											</span>
										</div>

									</div>
							</div>

					</div>
				</div>
			</div>
		</div>
	</div>


	<div class="row">
		<div class="col-md-2">
			<div class="card">
				<div class="menu-item" onclick="chTitle(this)">
					<i class="fa fa-edit"></i>ë³¸ì¸ í‰ê°€
				</div>
				<div class="menu-item" onclick="chTitle(this)">
					<i class="fa fa-edit"></i>ìƒì‚¬ í‰ê°€
				</div>
				<div class="menu-item" onclick="chTitle(this)">
					<i class="fa fa-edit"></i>ë™ë£Œ í‰ê°€
				</div>
				<div class="menu-item" onclick="chTitle(this)">
					<i class="fa fa-edit"></i>ê²°ê³¼ì§€ í™•ì¸
				</div>
			</div>
		</div>
		<!-- ê²€ìƒ‰ì¡°ê±´ -->
		<div class="col-md-10">
			<!-- ì‚¬ì›ëª©ë¡ -->
			<div id="mlssUser" class="card">
				<!-- ì¹´ë“œ í—¤ë” : ì œëª© + ì´ˆê¸°í™”/ì¡°íšŒ ë²„íŠ¼ -->
				<div class="card-header d-flex justify-content-between align-items-center">
					<div class="card-header-left d-flex align-items-center">
						<!-- collapse í† ê¸€ ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½ -->
						<h5 class="card-title mb-0 me-2" id="collapseToggle">ë³¸ì¸ í‰ê°€</h5>
						<select id="evaleRelate1" class="form-select form-select-sm w-auto">
								<th:block th:each="val : ${evaleRelateUpr}">
									<option class="clsf" th:value="${val.mlssEmpId}" th:text="${val.nm}"></option>									
								</th:block>																															
							</select>													
						<select id="evaleRelate2" class="form-select form-select-sm w-auto">								
								<th:block th:each="val : ${evaleRelateLwr}">
									<option class="clsf" th:value="${val.mlssEmpId}" th:text="${val.nm}"></option>																	
								</th:block>																								
							</select>													
					</div>
					<div class="card-header-right">
						<button type="button" class="btn btn-outline-dark">ì„ì‹œì €ì¥</button>
						<button id="mlssUserRegist" type="button" class="btn btn-outline-dark">ì œì¶œ</button>
					</div>
				</div>
				
					<div class="card-body">
						<div class="row mb-2">
							<div class="col-md-4">
								<label class="form-label">ì´ë¦„</label> <input type="text"
									value="ê¹€ì² ìˆ˜" class="form-control" />
							</div>
							<div class="col-md-4">
								<label class="form-label">ë¶€ì„œ</label> <input type="text"
									value="ì˜ì—…" class="form-control" />
							</div>
							<div class="col-md-4">
								<label class="form-label">ì§ê¸‰</label> <input type="text"
									value="ì‚¬ì›" class="form-control" />
							</div>
						</div>
						<div class="row mb-2">
							
							
						</div>
						<div style="height: 450px; overflow:auto;" >
						<h5 id="yeocRyangGrp" class="card-title">ì—­ëŸ‰ ê·¸ë£¹ë³„ í‰ê°€ í•­ëª©</h5>
						<p>ì§ë¬´ ì—­ëŸ‰</p>
						<div id="toastGrid" style="margin: 20px;"></div>
						<p>í˜‘ì—… ì—­ëŸ‰</p>
						<div id="toastGrid2" style="margin: 20px;"></div>
						<p>ìê¸°ê´€ë¦¬ ì—­ëŸ‰</p>
						<div id="toastGrid3" style="margin: 20px;"></div>
						</div>
					</div>
				
			</div>
			<div id="mlssResult" class="card stIsShow" style="height: 550px; overflow-y:auto; overflow-x:hidden;">
				<div class="row mb-2">
					<div class="col-md-6">
						<div id="radar" style="width: 400px; height: 400px;"></div>
					</div>
					<div class="col-md-6">
						<div id="pie" style="width: 400px; height: 400px;"></div>
					</div>
				</div>
				<div class="row mb-2">
				<div class="col-md-12">
				<div id="toastGrid4" style="margin: 20px;"></div>
				</div>
				</div>
				<div class="row mb-2">
				<div class="col-md-12">
				<div id="column" style="width: 900px; height: 400px;"></div>
				</div>
				</div>


			</div>
		</div>
	</div>
	<script th:inline="javascript">	
	$("#evaleRelate1").hide();
	$("#evaleRelate2").hide();
	let mlssEmpId ="";
function chTitle(el) {
	 // div ì•ˆì˜ í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸° (ì•„ì´ì½˜ ì œì™¸)
	const text = $(el).text().trim();
    if (text === "ê²°ê³¼ì§€ í™•ì¸") {
        $("#mlssUser").addClass("stIsShow");
        $("#mlssResult").removeClass("stIsShow");
    } else {
        $("#mlssUser").removeClass("stIsShow");
        $("#mlssResult").addClass("stIsShow");
    }    
    
    // a íƒœê·¸ì˜ í…ìŠ¤íŠ¸ ë³€ê²½    
    $("#collapseToggle").text(text);    
    if ($("#collapseToggle").text() == "ìƒì‚¬ í‰ê°€") {
        $("#evaleRelate1").show();        
        $("#evaleRelate2").hide();   
        mlssEmpId = $("#evaleRelate1").val();
    } else if($("#collapseToggle").text() == "ë™ë£Œ í‰ê°€"){
    	$("#evaleRelate1").hide();    	
    	$("#evaleRelate2").show();   
    	empId = $("#evaleRelate2").val();
    } else {
    	$("#evaleRelate1").hide();
    	$("#evaleRelate2").hide();
    	mlssEmpId = [[${mlssEmpId}]];    	
    }
    
    callMlssChkJohoe(mlssEmpId);
    
	// ğŸ“Œ divê°€ í™”ë©´ì— ë³´ì´ëŠ” ìˆœê°„ ì°¨íŠ¸ë¥¼ ìƒì„±
       if (!radarChart) {
           showRadarChart();
       } else {		        	
       	// ğŸ“Œ divê°€ ë³´ì´ëŠ” ìˆœê°„ ì°¨íŠ¸ ìƒì„±
           setTimeout(() => {
               showRadarChart();
           }, 50); // í™”ë©´ ê°±ì‹  í›„ ì‹¤í–‰
           // ğŸ“Œ ì´ë¯¸ ìƒì„±í•œ ì°¨íŠ¸ë¼ë©´ ê°±ì‹       
	
           radarChart.resize();   
           pieChart.resize();   
           columnChart.resize();   
       }
	
	
       
	
}

//select ë³€ê²½ ì´ë²¤íŠ¸ì—ë„ ì—°ê²°

$("#evaleRelate1, #evaleRelate2").on("change", function() {
    mlssEmpId = $(this).val();
    callMlssChkJohoe(mlssEmpId);
});





function callMlssChkJohoe(mlssEmpId) {
	//console.log("ëª¨ë‚˜ì˜¤ë‹ˆ"+mlssEmpId);
	//ë¼ë””ì˜¤ ë²„íŠ¼ ì¤‘ checked ë˜ì–´ ìˆëŠ” ê²ƒë§Œ ì„ íƒ
	$("input[type=radio]:checked").prop("checked", false);
	$.ajax({
	  url: "/selectMlssChkJohoe",                // ìš”ì²­ URL
	  type: "get",                     // GET ë°©ì‹ (fetch ì½”ë“œì™€ ë™ì¼)
	  data: {mlssEmpId : mlssEmpId,
	  	empId: [[${empId}]]}
	})
	.done((result) => {	
		console.log(result);   
		getdbData(result);
	})
	.fail((error) => {
	  console.error(error);
	  alert("ë°ì´í„° ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
	}); 
}

function makeRadarData(iemList, myWrterList, evaleRelate) {
	  // ê²°ê³¼ ë°°ì—´ (ì§ë¬´, í˜‘ì—…, ìê¸°ê´€ë¦¬ ìˆœì„œ)
	  const result = [];

	  // ê° ê·¸ë£¹ë³„ ì²˜ë¦¬
	  for (const groupName of ["ì§ë¬´ ì—­ëŸ‰", "í˜‘ì—… ì—­ëŸ‰", "ìê¸°ê´€ë¦¬ ì—­ëŸ‰"]) {
	    const items = iemList[groupName]; // í•´ë‹¹ ê·¸ë£¹ì˜ í•­ëª©ë“¤

	    // í•´ë‹¹ ê·¸ë£¹ì˜ ì ìˆ˜ ëª¨ìœ¼ê¸°
	    const scores = items.map(item => {
	      // myWrterListì—ì„œ ê°™ì€ mlssIemId + evaleRelateì¸ ì ìˆ˜ ì°¾ê¸°
	      const wrter = myWrterList.find(
	        w => w.mlssIemId === item.mlssIemId && w.evaleRelate === evaleRelate
	      );
	      return wrter ? wrter.score : null;
	    }).filter(s => s !== null);

	    // í‰ê·  ê³„ì‚°
	    const avg = scores.length > 0
	      ? scores.reduce((sum, s) => sum + s, 0) / scores.length
	      : 0;

	    result.push(avg);
	  }

	  return { name: evaleRelate, data: result };
	}


class ScoreRadioRenderer {
	  constructor(props) {
	    this.el = document.createElement('div');	    
	    const rowKey = props.rowKey;	   
	    const radioName = props.grid.store.data.filteredRawData[rowKey].mlssIemId;

	    this.el.innerHTML = [1,2,3,4,5].map(v =>
	      `<label><input type="radio" name="${radioName}" value="${v}">${v}</label>`
	    ).join(' ');

	    this.el.querySelectorAll('input[type="radio"]').forEach(input => {
	      input.addEventListener('change', (e) => {
	        const value = Number(e.target.value);
	        props.grid.setValue(rowKey, 'score', value);
	        //console.log('row', rowKey, 'score', value);
	      });
	    });
	  }

	  getElement() {
	    return this.el;
	  }
	}
			
let gridColums = [
    { header: 'ID', name: 'mlssIemId', hidden: true },
    { header: 'í‰ê°€ í•­ëª©', name: 'mlssIem', sortable: true },
    {
    	  header: 'ì ìˆ˜',
    	  name: 'score',
    	  align: 'center',
    	  renderer: { type: ScoreRadioRenderer }
    	}
];

			let grpTag = $("#yeocRyangGrp");
			let isRegist = 0;
			$("#mlssUserRegist").on("click", () => {				
				let payLoad = {};				
				let master = {};				
				let datas = [...grid.getData(), ...grid2.getData(), ...grid3.getData()];		
				for(let data of datas) {
					$(`input[name="${data.mlssIemId}"]`).each(function() {
						  if ($(this).prop("checked")) {
						    data["score"] = Number($(this).val());						    
						    data["empId"] = [[${empId}]];			    
						    if($("#collapseToggle").text() == "ë³¸ì¸ í‰ê°€") {
						    	data["evaleRelate"] = "ë³¸ì¸";
						    	data["mlssEmpId"] = [[${mlssEmpId}]];
						    }else if($("#collapseToggle").text() == "ìƒì‚¬ í‰ê°€"){
						    	data["evaleRelate"] = "ìƒì‚¬";
						    	data["mlssEmpId"] = $("option.clsf:selected").val();
						    }else{
						    	data["evaleRelate"] = "ë™ë£Œ";
						    	data["mlssEmpId"] = $("option.clsf:selected").val();
						    }
						  }
						});					
				}
				datas = datas.filter(data => data.score != null);
				if(datas.length != 9) {
					alert("í‰ê°€ë¥¼ ëª¨ë‘ ì‘ì„±í•œë’¤ ì œì¶œí•˜ì„¸ìš”");
					return
				}
				master["mlssEmpId"] = [[${mlssEmpId}]];
				master["mlssId"] = [[${mlssId}]];
				master["empId"] = [[${empId}]];
				
				payLoad["master"] = master;
				payLoad["datas"] = datas;
				console.log(payLoad);
				
				  $.ajax({
				    url: "/mlssUserRegist",                // ìš”ì²­ URL
				    type: "post",                     // GET ë°©ì‹ (fetch ì½”ë“œì™€ ë™ì¼)
				    contentType: "application/json",
				    data: JSON.stringify(payLoad),     // ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ìë™ ë³€í™˜			        
				})
				.done((result) => {
				    alert("ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");			    
				})
				.fail((error) => {
				    console.error(error);
				    alert("ë°ì´í„° ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
				});  
				
			});
			
			
			
			
			const iemList = [[${iemList}]];
			console.log(iemList);
			const gridData = [];

			// ì§ë¬´ ì—­ëŸ‰ ë°ì´í„°
		    const jobData = iemList['ì§ë¬´ ì—­ëŸ‰'].map(vo => ({
		    	mlssIemId: vo.mlssIemId,
		        ability: vo.ability,
		        mlssIem: vo.mlssIem
		    }));

		    // í˜‘ì—… ì—­ëŸ‰ ë°ì´í„°
		    const coopData = iemList['í˜‘ì—… ì—­ëŸ‰'].map(vo => ({
		    	mlssIemId: vo.mlssIemId,
		        ability: vo.ability,
		        mlssIem: vo.mlssIem
		    }));

		    // ìê¸°ê´€ë¦¬ ì—­ëŸ‰ ë°ì´í„°
		    const selfData = iemList['ìê¸°ê´€ë¦¬ ì—­ëŸ‰'].map(vo => ({
		    	mlssIemId: vo.mlssIemId,
		        ability: vo.ability,
		        mlssIem: vo.mlssIem
		    }));

			
			const grid = new tui.Grid(
					{
						el : document.getElementById('toastGrid'),
						data : jobData,						
						scrollX : false,
						scrollY : false,
						minBodyHeight : 0,
						autoWidth : true,
						columns : gridColums
					});

			// Grid ìƒì„±
			const grid2 = new tui.Grid(
					{
						el : document.getElementById('toastGrid2'),
						data : coopData,						
						scrollX : false,
						scrollY : false,
						minBodyHeight : 0,
						autoWidth : true,
						columns : gridColums
					});

			

			// Grid ìƒì„±
			const grid3 = new tui.Grid(
					{
						el : document.getElementById('toastGrid3'),
						data : selfData,						
						scrollX : false,
						scrollY : false,
						minBodyHeight : 0,
						autoWidth : true,
						columns : gridColums
					});
			//ê¸°ì¡´ì— í‰ê°€í–ˆë‹¤ë©´ ë‚´êº¼ëŠ” í˜ì´ì§€ ë¡œë“œì‹œ ì¶œë ¥ë˜ê²Œ í•˜ëŠ” ì½”ë“œ
			let myWrterList = [[${userWrterList}]]			
			getdbData(myWrterList);
			function getdbData(val) {				
				if(val.length == 9){						
					$("#mlssUserRegist").addClass("stIsShow");
					}else{$("#mlssUserRegist").removeClass("stIsShow")}
				for(let myWrter of val) {					
					$(`input[name="${myWrter.mlssIemId}"]`).each(function(el) {
						if($(this).val() == myWrter.score) {
							$(this).prop("checked", true);
						}
					});				
				};
				console.log(isRegist);
			}
			
			
			
			
			let radarChart;   // ì „ì—­ ë³€ìˆ˜ë¡œ ì„ ì–¸í•˜ì—¬ ì–´ë””ì„œë“  ì ‘ê·¼ ê°€ëŠ¥
			let pieChart;   // ì „ì—­ ë³€ìˆ˜ë¡œ ì„ ì–¸í•˜ì—¬ ì–´ë””ì„œë“  ì ‘ê·¼ ê°€ëŠ¥
			let columnChart;   // ì „ì—­ ë³€ìˆ˜ë¡œ ì„ ì–¸í•˜ì—¬ ì–´ë””ì„œë“  ì ‘ê·¼ ê°€ëŠ¥
			let resultGrid;   // ì „ì—­ ë³€ìˆ˜ë¡œ ì„ ì–¸í•˜ì—¬ ì–´ë””ì„œë“  ì ‘ê·¼ ê°€ëŠ¥

			function showRadarChart() {
				const radarEl = document.getElementById('radar');
			    const pieEl = document.getElementById('pie');
			    const columnEl = document.getElementById('column');
			    const gridEl = document.getElementById('toastGrid4');
				
			    if (radarChart) radarChart.destroy(); 
			    
			    if (pieChart) pieChart.destroy(); 
			    
			    if (resultGrid) resultGrid.destroy(); 
			    
			    if (columnChart) columnChart.destroy();
			    
			    radarChart = toastui.Chart.radarChart({
			        el: radarEl,
			        data: {
			            categories: ['ì§ë¬´ ì—­ëŸ‰', 'í˜‘ì—… ì—­ëŸ‰', 'ìê¸°ê´€ë¦¬ ì—­ëŸ‰'],
			            series: [
			            	makeRadarData(iemList, myWrterList, "ë³¸ì¸"),
			          	   { name: 'ìƒì‚¬', data: [4, 4, 4] },
			                 { name: 'ë¶€í•˜', data: [3, 3.7, 3.5] }, 
			            ]
			        },
			        options: {
			            series: { showArea: true },
			            chart: {
				            width: 600,   // ì›í•˜ëŠ” ë„ˆë¹„
				            height: 600   // ì›í•˜ëŠ” ë†’ì´
				          }
			        },		        
			    });			    
			    pieChart = toastui.Chart.pieChart({
			        el: pieEl,
			        data: {
			            series: [
			                { name: 'ì§ë¬´ ì—­ëŸ‰', data: 6 },
			                { name: 'í˜‘ì—… ì—­ëŸ‰', data: 5 },
			                { name: 'ìê¸°ê´€ë¦¬ ì—­ëŸ‰', data: 9 }
			            ]
			        },
			        options: {
			            chart: {
			                title: 'ë³¸ì¸ ì—­ëŸ‰ ë¹„ìœ¨'
			            }
			        }
			    });
			    
			    columnChart = toastui.Chart.columnChart({
			        el: columnEl,
			        data: {
			            categories: [
			              'ì—…ë¬´ ì´í•´ë„', 'ì „ë¬¸ì„±', 'ë¬¸ì œ í•´ê²° ëŠ¥ë ¥',
			              'ì˜ì‚¬ì†Œí†µëŠ¥ë ¥', 'í˜‘ë ¥ íƒœë„', 'ë¬¸ì œí•´ê²° ë° ê¸°ì—¬ë„',
			              'ì‹œê°„ ë° ì—…ë¬´ê´€ë¦¬', 'ìê¸°ê°œë°œ ë° í•™ìŠµíƒœë„', 'ì±…ì„ê° ë° ê·œìœ¨ ì¤€ìˆ˜'
			            ],
			            series: [
			              {
			                name: 'ë³¸ì¸',
			                data: [6, 8, 10, 10, 7, 5, 2, 9, 3]
			              },
			              {
			                name: 'ìƒì‚¬',
			                data: [7, 9, 9, 8, 8, 6, 3, 8, 4]
			              },
			              {
			                name: 'ë™ë£Œ',
			                data: [5, 7, 8, 9, 6, 5, 4, 7, 5]
			              }
			            ]
			          },
			        options: {
			            chart: { title: 'ì—­ëŸ‰ë³„ ì„¸ë¶€ í•­ëª© ì ìˆ˜' },
			            yAxis: { title: 'ì ìˆ˜' },
			            xAxis: { title: 'ì—­ëŸ‰ ê·¸ë£¹' },
			            width: 900,
			            height: 400
			        }			        
			    });
			    
			    const gridData = [ {
					id : 7,
					ability : "ì‹œê°„ ë°  ì—…ë¬´ê´€ë¦¬",
				},  ];

				// Grid ìƒì„±
				resultGrid = new tui.Grid(
						{
							el : gridEl,
							data : gridData,
							scrollX : false,
							scrollY : false,
							minBodyHeight : 0,
							autoWidth : true,
							columns : [{
										header : 'ë‹¤ë©´í‰ê°€ ì—­ëŸ‰ê·¸ë£¹',
										name : 'ability',
										sortable : true
										},
										{
											header : 'ë³¸ì¸',
											name : 'score1',
											align : 'left',												
										},{
											header : 'ìƒì‚¬',
											name : 'score1',
											align : 'left',												
										},{
											header : 'ë™ë£Œ',
											name : 'score1',
											align : 'left',												
										},{
											header : 'ì¡°ì§í‰ê· ',
											name : 'score1',
											align : 'left',												
										},{
											header : 'ì¡°ì§ëŒ€ë¹„',
											name : 'score1',
											align : 'left',												
										},]
						});


			}

		</script>

	


</body>

</html>