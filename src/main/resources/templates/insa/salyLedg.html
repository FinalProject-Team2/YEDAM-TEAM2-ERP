<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
  <meta charset="UTF-8">

  <!-- Toast UI Grid -->
  <link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
  <script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>

  <title>salyLedg</title>

  <style>
    /* =========================
     * wkTy ìŠ¤íƒ€ì¼ íƒ­ ê·¸ëŒ€ë¡œ ì ìš©
     * ========================= */
    .saly-tab-wrapper {
      margin-bottom: 0;
    }

    .saly-tab-wrapper .nav-tabs {
      display: flex;
      gap: 0;
      margin-bottom: 0;
      border-bottom: none !important;
    }

    .saly-tab-wrapper .nav-item {
      margin-bottom: -1px;
    }

    .saly-tab-wrapper .nav-link {
      border-radius: 10px 10px 0 0;
      padding: 8px 20px;
      background-color: #f7f8fa;
      color: #a1a6ad;
      font-weight: 500;
      border: 1px solid #d1d5db;
      border-bottom-color: #d1d5db;
      box-shadow: inset 0 -2px 0 rgba(0,0,0,0.03);
      transition: background-color 0.15s ease,
                  color 0.15s ease,
                  box-shadow 0.15s ease;
    }

    .saly-tab-wrapper .nav-item + .nav-item .nav-link {
      margin-left: -1px;
    }

    .saly-tab-wrapper .nav-link:not(.active):hover {
      background-color: #eff1f4;
      color: #7a7f87;
    }

    .saly-tab-wrapper .nav-link.active {
      background-color: #ffffff;
      color: #111111;
      font-weight: 600;
      border-color: #d1d5db;
      border-bottom-color: #ffffff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.06);
      z-index: 2;
    }

    .saly-card-body > .mt-2 {
      margin-top: 0 !important;
    }
  </style>
</head>
<body layout:fragment="content">
<div class="row">
  <!-- ê²€ìƒ‰ì¡°ê±´ -->
  <div class="col-md-12">
    <div class="card mb-3">
      <div class="card-header">
        <h5 class="card-title">ê²€ìƒ‰ì¡°ê±´</h5>
        <div class="card-header-right">
          <button class="btn btn-outline-dark" id="btnSearch">ì¡°íšŒ</button>
        </div>
      </div>
      <div class="card-body">
        <div class="row">
          <!-- 3 / 3 / 6 ë°°ì¹˜ -->
          <div class="col-md-3">
            <label class="form-label">ë¶€ì„œëª…</label>
            <select id="dept" class="form-select">
              <option value="">ì „ì²´</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">ê¸‰ì—¬ëŒ€ì¥ëª…ì¹­</label>
            <input type="text" id="srchSalyNm" class="form-control">
          </div>
          <div class="col-md-6">
            <label class="form-label">ì§€ê¸‰ì¼ì</label>
            <div class="d-flex align-items-center js-date-range">
              <div class="input-group date me-2">
                <input type="text"
                       class="form-control js-date-range-start"
                       id="payDtStart"
                       placeholder="ë‚ ì§œ ì„ íƒ">
                <span class="input-group-text js-date-range-icon-start">
                  <i class="bi bi-calendar"></i>
                </span>
              </div>
              <span class="mx-1 fw-bold fs-5">~</span>
              <div class="input-group date ms-2">
                <input type="text"
                       class="form-control js-date-range-end"
                       id="payDtEnd"
                       placeholder="ë‚ ì§œ ì„ íƒ">
                <span class="input-group-text js-date-range-icon-end">
                  <i class="bi bi-calendar"></i>
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ê¸‰ì—¬ëª©ë¡ -->
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">ê¸‰ì—¬ëª©ë¡</h5>
        <div class="card-header-right d-flex gap-2">
          <button class="btn btn-danger" id="btnSalyDelete">ì‚­ì œ</button>
          <button class="btn btn-outline-dark" id="btnSalyCalc">ê¸‰ì—¬ê³„ì‚°</button>
          <button class="btn btn-outline-dark" id="btnSalySpec">ëª…ì„¸ì„œ ì¡°íšŒ</button>
          <button class="btn btn-outline-dark" id="openSalyRegistModal">ë“±ë¡/ìˆ˜ì •</button>
          <button class="btn btn-outline-dark" id="btnToggleConfirm">í™•ì •/ì·¨ì†Œ</button>
        </div>
      </div>
      <div class="card-body saly-card-body">
        <div class="saly-tab-wrapper">
          <ul class="nav nav-tabs" id="salyStatusTabs">
            <li class="nav-item">
              <button class="nav-link active" type="button" data-status="BEFORE_PAY">
                ì§€ê¸‰ì „
              </button>
            </li>
            <li class="nav-item">
              <button class="nav-link" type="button" data-status="PAID">
                ì§€ê¸‰ì™„ë£Œ
              </button>
            </li>
          </ul>
        </div>

        <div id="grid" class="mt-2"></div>
      </div>
    </div>
  </div>
</div>

<!-- ğŸ”¹ ì‹¤ì œ ëª¨ë‹¬ include (HTMLì€ ë³„ë„ íŒŒì¼) -->
<div th:replace="insa/modal/salyRegistModal :: salyRegistModal"></div>

<script>
  /***********************
   * 0. ê³µí†µ: ë¶€ì„œ ì…€ë ‰íŠ¸ ë¡œë”©
   *  - /insa/edc/inputOption ì‚¬ìš© (vend_id í•„í„°ëŠ” ì„œë²„ì—ì„œ)
   ***********************/
  function loadDeptOptions() {
    const searchDept = document.getElementById("dept");      // ìƒë‹¨ ê²€ìƒ‰ìš©
    const modalDept  = document.getElementById("salyDept");  // ëª¨ë‹¬ìš©

    if (searchDept) {
      searchDept.innerHTML = '<option value="">ì „ì²´</option>';
    }
    if (modalDept) {
      modalDept.innerHTML = '<option value="">ì„ íƒ</option>';
    }

    fetch('/insa/edc/inputOption')
      .then(res => res.json())
      .then(data => {
        const deptList = data.dept || [];
        deptList.forEach(d => {
          if (searchDept) {
            const opt1 = document.createElement("option");
            opt1.value = d.deptId;
            opt1.textContent = d.deptNm;
            searchDept.appendChild(opt1);
          }
          if (modalDept) {
            const opt2 = document.createElement("option");
            opt2.value = d.deptId;
            opt2.textContent = d.deptNm;
            modalDept.appendChild(opt2);
          }
        });
      })
      .catch(() => {
        alert("ë¶€ì„œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      });
  }

  /***********************
   * 1. ë©”ì¸ ê·¸ë¦¬ë“œ ë°ì´í„° (ì‹¤ì œ DB)
   ***********************/
  let originalGridData = [];         // â† ë”ë¯¸ ì‚­ì œ, ì—¬ê¸° ì±„ì›€
  let currentTabStatus = "BEFORE_PAY";   // BEFORE_PAY / PAID
  let gridData = [];

  /***************************
   * 2. ë©”ì¸ ê¸‰ì—¬ëŒ€ì¥ TUI Grid
   ***************************/
  const grid = new tui.Grid({
    el: document.getElementById("grid"),
    data: gridData,
    bodyHeight: 408,
    scrollX: false,
    scrollY: true,
    rowHeaders: [],
    columns: [
      {
        header: "",
        name: "ì„ íƒ",
        width: 50,
        align: "center",
        formatter: ({ rowKey }) => {
          return `<input type="radio" name="salyLedgRadio" data-row-key="${rowKey}" />`;
        }
      },
      { header: "ê·€ì†ì—°ì›”",     name: "revsMmdd",  align: "center" },
      { header: "ì§€ê¸‰ì¼",       name: "payDt",     align: "center" },
      { header: "ê¸‰ì—¬ëŒ€ì¥ëª…ì¹­", name: "salyLedgNm" },
      { header: "ë¶€ì„œëª…",       name: "deptNm" },
      { header: "ì¸ì›ìˆ˜",       name: "rcnt",      align: "right" },
      {
        header: "ì§€ê¸‰ì´ì•¡",
        name: "ttPayAmt",
        align: "right",
        formatter: ({ value }) => {
          if (value == null || value === "") return "";
          return Number(value).toLocaleString("ko-KR", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          });
        }
      },
      {
        header: "ìƒíƒœ",
        name: "status",
        align: "center",
        formatter: ({ value }) => {
          if (value === "BEFORE_CONFIRM") return "ë¯¸í™•ì •";
          if (value === "CONFIRMED")      return "í™•ì •";
          if (value === "PAID")           return "ì§€ê¸‰ì™„ë£Œ";
          return value || "";
        }
      }
    ]
  });

  /************************
   * 3. DBì—ì„œ ê¸‰ì—¬ëŒ€ì¥ ëª©ë¡ ì¡°íšŒ
   *   GET /insa/saly/list
   ************************/
  function loadSalyList() {
    const deptSel = document.getElementById("dept");
    const salyNmInput = document.getElementById("srchSalyNm");
    const payDtStartInput = document.getElementById("payDtStart");
    const payDtEndInput   = document.getElementById("payDtEnd");

    const deptId   = deptSel ? (deptSel.value || "") : "";
    const salyNm   = salyNmInput ? salyNmInput.value.trim() : "";
    const payDtStart = payDtStartInput ? payDtStartInput.value.trim() : "";
    const payDtEnd   = payDtEndInput ? payDtEndInput.value.trim() : "";

    const params = new URLSearchParams();
    if (deptId)    params.append("deptId", deptId);
    if (salyNm)    params.append("salyLedgNm", salyNm);
    if (payDtStart) params.append("payDtStart", payDtStart);
    if (payDtEnd)   params.append("payDtEnd", payDtEnd);

    fetch("/insa/saly/list?" + params.toString())
      .then(res => res.json())
      .then(list => {
        // ë°±ì—”ë“œ VO ê¸°ì¤€: salyLedgId, salyLedgNm, deptNm, revsYm, payDt, rcnt, status, ttPayAmt ...
        originalGridData = (list || []).map(r => {
          // revsYm: "2025-07" â†’ "2025.07"
          let revsMmdd = "";
          if (r.revsYm) {
            revsMmdd = String(r.revsYm).replace(/-/g, ".");
          }

          // payDt: Date or String â†’ "yyyy.MM.dd"
          let payDtStr = "";
          if (r.payDt) {
            let raw = String(r.payDt);
            if (raw.includes("T")) {
              raw = raw.substring(0, 10);
            }
            payDtStr = raw.replace(/-/g, ".");
          }

          return {
            salyLedgId: r.salyLedgId,
            revsMmdd  : revsMmdd,
            payDt     : payDtStr,
            salyLedgNm: r.salyLedgNm,
            deptNm    : r.deptNm,
            rcnt      : r.rcnt,
            status    : r.status,
            ttPayAmt  : r.ttPayAmt
          };
        });

        applyTabFilter();
      })
      .catch(err => {
        console.error("ê¸‰ì—¬ëŒ€ì¥ ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜", err);
        alert("ê¸‰ì—¬ëŒ€ì¥ ëª©ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      });
  }

  document.getElementById("btnSearch")?.addEventListener("click", loadSalyList);

  /*************************
   * 4. ë¼ë””ì˜¤ ì„ íƒ í—¬í¼
   *************************/
  function getSelectedRow() {
    const checked = document.querySelector('input[name="salyLedgRadio"]:checked');
    if (!checked) return null;
    const rowKey = Number(checked.dataset.rowKey);
    return grid.getRow(rowKey);
  }

  /*************************
   * 5. íƒ­ìœ¼ë¡œ ì§€ê¸‰ì „ / ì§€ê¸‰ì™„ë£Œ ë¶„ë¦¬
   *************************/
  const statusTabs         = document.querySelectorAll("#salyStatusTabs .nav-link");
  const btnSalyDelete      = document.getElementById("btnSalyDelete");
  const btnSalyCalc        = document.getElementById("btnSalyCalc");
  const btnSalySpec        = document.getElementById("btnSalySpec");
  const btnToggleConfirm   = document.getElementById("btnToggleConfirm");
  const openSalyRegistBtn  = document.getElementById("openSalyRegistModal");

  function applyTabFilter() {
    if (currentTabStatus === "PAID") {
      gridData = originalGridData.filter(row => row.status === "PAID");
    } else {
      // ì§€ê¸‰ì „: PAID ì•„ë‹Œ ê²ƒë“¤ (ë¯¸í™•ì • + í™•ì •)
      gridData = originalGridData.filter(row => row.status !== "PAID");
    }
    grid.resetData(gridData);

    const isPaidTab = currentTabStatus === "PAID";

    // ì§€ê¸‰ì™„ë£Œ íƒ­ì—ì„œëŠ” ëª…ì„¸ì„œ ì¡°íšŒë§Œ ë³´ì´ê²Œ
    if (btnSalyDelete) {
      btnSalyDelete.style.display = isPaidTab ? "none" : "";
      btnSalyDelete.disabled      = isPaidTab;
    }
    if (btnSalyCalc) {
      btnSalyCalc.style.display   = isPaidTab ? "none" : "";
      btnSalyCalc.disabled        = isPaidTab;
    }
    if (btnToggleConfirm) {
      btnToggleConfirm.style.display = isPaidTab ? "none" : "";
      btnToggleConfirm.disabled      = isPaidTab;
    }
    if (openSalyRegistBtn) {
      openSalyRegistBtn.style.display = isPaidTab ? "none" : "";
      openSalyRegistBtn.disabled      = isPaidTab;
    }
    if (btnSalySpec) {
      btnSalySpec.style.display = "";
      btnSalySpec.disabled      = false;
    }

    updateConfirmButtonLabel();
  }

  statusTabs.forEach(tab => {
    tab.addEventListener("click", function () {
      statusTabs.forEach(t => t.classList.remove("active"));
      this.classList.add("active");
      currentTabStatus = this.dataset.status || "BEFORE_PAY";
      applyTabFilter();
    });
  });

  /*************************
   * 6. í™•ì •/í™•ì •ì·¨ì†Œ í† ê¸€ ë²„íŠ¼
   *************************/
  function updateConfirmButtonLabel() {
    if (!btnToggleConfirm) return;

    const row = getSelectedRow();
    if (!row) {
      btnToggleConfirm.textContent = "í™•ì •/ì·¨ì†Œ";
      return;
    }

    if (row.status === "BEFORE_CONFIRM") {
      btnToggleConfirm.textContent = "í™•ì •";
    } else if (row.status === "CONFIRMED") {
      btnToggleConfirm.textContent = "í™•ì •ì·¨ì†Œ";
    } else if (row.status === "PAID") {
      btnToggleConfirm.textContent = "í™•ì •";
    }
  }

  if (btnToggleConfirm) {
    btnToggleConfirm.addEventListener("click", () => {
      const row = getSelectedRow();
      if (!row) {
        alert("í™•ì •/ì·¨ì†Œí•  ê¸‰ì—¬ëŒ€ì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
      }

      if (row.status === "PAID") {
        alert("ì§€ê¸‰ì™„ë£Œëœ ê¸‰ì—¬ëŒ€ì¥ì€ í™•ì • ìƒíƒœë¥¼ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      // TODO: /insa/saly/confirm API ë¶™ì´ë©´ ì—¬ê¸°ì„œ í˜¸ì¶œ
      if (row.status === "BEFORE_CONFIRM") {
        grid.setValue(row.rowKey, "status", "CONFIRMED");
      } else if (row.status === "CONFIRMED") {
        grid.setValue(row.rowKey, "status", "BEFORE_CONFIRM");
      }
      updateConfirmButtonLabel();
    });
  }

  grid.on("click", ev => {
    const target = ev.target;
    if (target instanceof HTMLElement && target.matches('input[type="radio"][name="salyLedgRadio"]')) {
      updateConfirmButtonLabel();
    }
  });

  /*************************
   * 7. ì‚­ì œ ë²„íŠ¼ (ì§€ê¸ˆì€ í”„ë¡ íŠ¸ ë°°ì—´ ê¸°ì¤€)
   *************************/
  if (btnSalyDelete) {
    btnSalyDelete.addEventListener("click", () => {
      const row = getSelectedRow();
      if (!row) {
        alert("ì‚­ì œí•  ê¸‰ì—¬ëŒ€ì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
      }
      if (!confirm("ì„ íƒí•œ ê¸‰ì—¬ëŒ€ì¥ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        return;
      }

      // TODO: /insa/saly/delete API ë¶™ì´ë©´ ì—¬ê¸°ì„œ í˜¸ì¶œ
      const idx = originalGridData.findIndex(r =>
        r.salyLedgId === row.salyLedgId
      );
      if (idx > -1) {
        originalGridData.splice(idx, 1);
      }

      applyTabFilter();
      alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
    });
  }

  /*************************
   * 8. ê¸‰ì—¬ê³„ì‚° / ëª…ì„¸ì„œ ë²„íŠ¼ (ì¶”í›„ êµ¬í˜„)
   *************************/
  if (btnSalyCalc) {
    btnSalyCalc.addEventListener("click", () => {
      const row = getSelectedRow();
      if (!row) {
        console.log("ì‹ ê·œ ê¸‰ì—¬ê³„ì‚° ëª¨ë“œ");
      } else {
        console.log("ì„ íƒ ê¸‰ì—¬ëŒ€ì¥ ê¸°ì¤€ ê¸‰ì—¬ê³„ì‚°/ì¡°íšŒ:", row);
      }
    });
  }

  if (btnSalySpec) {
    btnSalySpec.addEventListener("click", () => {
      const row = getSelectedRow();
      if (!row) {
        alert("ëª…ì„¸ì„œë¥¼ ì¡°íšŒí•  ê¸‰ì—¬ëŒ€ì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
      }
      console.log("ëª…ì„¸ì„œ ì¡°íšŒ:", row);
    });
  }

  /***********************
   * 9. ëª¨ë‹¬ & ì‚¬ì› ê·¸ë¦¬ë“œ
   ***********************/
  const modal   = document.getElementById("salyRegistModal");
  const back    = document.getElementById("salyRegistBackdrop");
  const btnSalySave = document.getElementById("btnSalySave");
  const btnSalyEmpSearch = document.getElementById("btnSalyEmpSearch");
  const salyEmpNmCond = document.getElementById("salyEmpNmCond");
  const modalDept = document.getElementById("salyDept");

  const grid2El = document.getElementById("grid2");
  let grid2 = null;

  function initEmpGrid() {
    if (!grid2El || grid2) return;
    grid2 = new tui.Grid({
      el: grid2El,
      data: [],
      bodyHeight: 320,
      scrollX: false,
      scrollY: true,
      rowHeaders: ['checkbox'],
      columns: [
        { header: "ì‚¬ì›ë²ˆí˜¸", name: "empId" },
        { header: "ì‚¬ì›ëª…",   name: "nm" },
        { header: "ê³ ìš©í˜•íƒœ", name: "emplymTyNm" },
        { header: "ë¶€ì„œëª…",   name: "deptNm" }
      ]
    });
  }

  function loadEmpList() {
    if (!grid2) return;

    const deptId = modalDept ? (modalDept.value || "") : "";
    const empNm  = salyEmpNmCond ? salyEmpNmCond.value.trim() : "";

    const param = {
      deptId: deptId,
      empNm : empNm
    };

    fetch("/insa/saly/empList", {
      method : "POST",
      headers: { "Content-Type": "application/json" },
      body   : JSON.stringify(param)
    })
    .then(res => res.json())
    .then(list => {
      const data = (list || []).map(e => ({
        empId:      e.empId,
        nm:         e.nm,
        emplymTyNm: e.emplymTyNm || e.emplymTy || "",
        deptNm:     e.deptNm || ""
      }));
      grid2.resetData(data);
    })
    .catch(err => {
      console.error("ì‚¬ì› ì¡°íšŒ ì˜¤ë¥˜", err);
      alert("ì‚¬ì› ëª©ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    });
  }

  function openSalyModal() {
    if (!modal || !back) return;

    modal.classList.add("show");
    modal.style.display = "block";
    back.style.display  = "block";

    initEmpGrid();
    loadEmpList();

    if (grid2 && grid2.refreshLayout) {
      grid2.refreshLayout();
    }
  }

  function closeSalyRegistModal() {
    if (modal) {
      modal.classList.remove("show");
      modal.style.display = "none";
    }
    if (back) {
      back.style.display = "none";
    }
  }

  if (openSalyRegistBtn) {
    openSalyRegistBtn.addEventListener("click", () => {
      const row = getSelectedRow();
      if (!row) {
        console.log("ì‹ ê·œ ë“±ë¡ ëª¨ë“œ");
      } else {
        console.log("ì„ íƒ ê¸‰ì—¬ëŒ€ì¥ ìˆ˜ì • ëª¨ë“œ:", row);
        // ìˆ˜ì • ëª¨ë“œ ë°”ì¸ë”©ì€ ë‚˜ì¤‘ì—
      }
      openSalyModal();
    });
  }

  if (back) {
    back.addEventListener("click", closeSalyRegistModal);
  }
  if (modal) {
    modal.addEventListener("click", function (e) {
      if (!e.target.closest(".modal-content")) {
        closeSalyRegistModal();
      }
    });
  }
  document.addEventListener("keydown", function (e) {
    if (e.key === "Escape") {
      closeSalyRegistModal();
    }
  });

  // ì‚¬ì› ê²€ìƒ‰ ë²„íŠ¼ + ì—”í„° + ë¶€ì„œ ë³€ê²½
  btnSalyEmpSearch?.addEventListener("click", loadEmpList);
  salyEmpNmCond?.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      loadEmpList();
    }
  });
  modalDept?.addEventListener("change", loadEmpList);

  /***********************
   * 10. revs_ym / payDt ì—°ë™ (ê·€ì†ì—°ì›” ìº˜ë¦°ë”)
   ***********************/
  $(function () {
    const $revsYm = $("#revs_ym");
    const $payDt  = $("#payDt");

    if ($revsYm.length) {
      // ê·€ì†ì—°ì›”: ì—°Â·ì›”ë§Œ ì„ íƒ
      $revsYm.datepicker({
        format: "yyyy-mm",
        autoclose: true,
        minViewMode: 1,
        language: "ko"
      }).on("show", function () {
        const $self  = $(this);
        const $modal = $self.closest(".modal");
        if (!$modal.length) return;

        const modalZ = parseInt($modal.css("z-index"), 10) || 1055;
        setTimeout(function () {
          $(".datepicker-dropdown").each(function () {
            this.style.setProperty("z-index", String(modalZ + 10), "important");
          });
        }, 0);
      });
    }

    if ($payDt.length) {
      // ì§€ê¸‰ì¼ì: ì¼ë°˜ ì¼ì ì„ íƒ
      $payDt.datepicker({
        format: "yyyy-mm-dd",
        autoclose: true,
        language: "ko"
      }).on("show", function () {
        const $self  = $(this);
        const $modal = $self.closest(".modal");
        if (!$modal.length) return;

        const modalZ = parseInt($modal.css("z-index"), 10) || 1055;
        setTimeout(function () {
          $(".datepicker-dropdown").each(function () {
            this.style.setProperty("z-index", String(modalZ + 10), "important");
          });
        }, 0);
      });
    }

    function ymToFirstDay(ym) {
      if (!ym) return null;
      const m = /^(\d{4})-(\d{2})$/.exec(ym);
      if (!m) return null;
      const y  = parseInt(m[1], 10);
      const mo = parseInt(m[2], 10) - 1;
      const d  = new Date(y, mo, 1);
      if (d.getFullYear() !== y || d.getMonth() !== mo) return null;
      return d;
    }

    function dateToYm(date) {
      if (!date) return "";
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      return y + "-" + m;
    }

    function hasDatepicker($el) {
      return !!$el.data("datepicker");
    }

    function syncFromRevsYm() {
      if (!hasDatepicker($payDt)) return;

      const ymStr = $revsYm.val().trim();
      if (!ymStr) {
        $payDt.datepicker("setStartDate", null);
        return;
      }

      const startDate = ymToFirstDay(ymStr);
      if (!startDate) {
        $payDt.datepicker("setStartDate", null);
        return;
      }

      $payDt.datepicker("setStartDate", startDate);

      const curPay = $payDt.datepicker("getDate");
      if (curPay && curPay < startDate) {
        $payDt.datepicker("setDate", startDate);
      }
    }

    function syncFromPayDt() {
      if (!hasDatepicker($revsYm)) return;

      const payDate = $payDt.datepicker("getDate");
      if (!payDate) {
        $revsYm.datepicker("setEndDate", null);
        return;
      }

      const maxYmDate = new Date(payDate.getFullYear(), payDate.getMonth(), 1);
      $revsYm.datepicker("setEndDate", maxYmDate);

      const curYmStr  = $revsYm.val().trim();
      const curYmDate = ymToFirstDay(curYmStr);

      if (curYmDate && curYmDate > maxYmDate) {
        $revsYm.datepicker("setDate", maxYmDate);
        $revsYm.val(dateToYm(maxYmDate));
      }
    }

    $revsYm.on("changeDate", syncFromRevsYm);
    $revsYm.on("blur", syncFromRevsYm);
    $payDt.on("changeDate", syncFromPayDt);
    $payDt.on("blur", syncFromPayDt);
  });

  /***********************
   * 11. ê¸‰ì—¬ëŒ€ì¥ ì €ì¥ (ëª¨ë‹¬ ë“±ë¡/ìˆ˜ì •)
   *      â†’ /insa/saly/save
   ***********************/
  if (btnSalySave) {
    btnSalySave.addEventListener("click", () => {
      const salyNmInput = document.getElementById("salyNm");
      const deptSel     = document.getElementById("salyDept");
      const revsYmInput = document.getElementById("revs_ym");
      const payDtInput  = document.getElementById("payDt");

      const salyNm = salyNmInput ? salyNmInput.value.trim() : "";
      const deptId = deptSel ? (deptSel.value || "") : "";
      const revsYm = revsYmInput ? revsYmInput.value.trim() : "";
      const payDt  = payDtInput ? payDtInput.value.trim() : "";

      if (!salyNm) {
        alert("ê¸‰ì—¬ëŒ€ì¥ëª…ì¹­ì„ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }
      if (!deptId) {
        alert("ë¶€ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”.");
        return;
      }
      if (!revsYm) {
        alert("ê·€ì†ì—°ì›”ì„ ì„ íƒí•˜ì„¸ìš”.");
        return;
      }
      if (!payDt) {
        alert("ì§€ê¸‰ì¼ìë¥¼ ì„ íƒí•˜ì„¸ìš”.");
        return;
      }
      if (!grid2) {
        alert("ì‚¬ì› ëª©ë¡ ê·¸ë¦¬ë“œê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        return;
      }

      const checkedRows = grid2.getCheckedRows();
      if (!checkedRows || checkedRows.length === 0) {
        alert("ê¸‰ì—¬ëª…ì„¸ì„œë¥¼ ìƒì„±í•  ì‚¬ì›ì„ í•œ ëª… ì´ìƒ ì„ íƒí•˜ì„¸ìš”.");
        return;
      }

      const empIdList = checkedRows.map(r => r.empId);

      const payload = {
        salyLedgId : null,          // ì‹ ê·œ
        salyLedgNm : salyNm,
        deptId     : deptId,
        revsYm     : revsYm,
        payDt      : payDt,
        empIdList  : empIdList
      };

      fetch("/insa/saly/save", {
        method : "POST",
        headers: { "Content-Type": "application/json" },
        body   : JSON.stringify(payload)
      })
      .then(res => res.json())
      .then(body => {
        if (body.result !== "SUCCESS") {
          const msg = body.message || "ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
          alert(msg);
          return;
        }

        alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");

        // ì €ì¥ í›„ ë¦¬ìŠ¤íŠ¸ ë‹¤ì‹œ ì¡°íšŒ (DB ê¸°ì¤€)
        loadSalyList();
        closeSalyRegistModal();
      })
      .catch(err => {
        console.error("ê¸‰ì—¬ëŒ€ì¥ ì €ì¥ ì˜¤ë¥˜", err);
        alert("ê¸‰ì—¬ëŒ€ì¥ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      });
    });
  }

  /***********************
   * 12. í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°ì‘ì—…
   ***********************/
  document.addEventListener("DOMContentLoaded", () => {
    loadDeptOptions();   // ìƒë‹¨ ê²€ìƒ‰ + ëª¨ë‹¬ ë¶€ì„œ ì…€ë ‰íŠ¸ ì±„ìš°ê¸°
    loadSalyList();      // ì´ˆê¸° ê¸‰ì—¬ëŒ€ì¥ ëª©ë¡ ì¡°íšŒ
  });
</script>
</body>
</html>
