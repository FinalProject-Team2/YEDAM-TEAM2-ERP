<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
  <meta charset="UTF-8">

  <!-- Toast UI Grid -->
  <link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
  <script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>

  <title>salyLedg</title>

  <style>
    .saly-tab-wrapper {
      margin-bottom: 0;
    }

    .saly-tab-wrapper .nav-tabs {
      display: flex;
      gap: 0;
      margin-bottom: 0;
      border-bottom: none !important;
    }

    .saly-tab-wrapper .nav-item {
      margin-bottom: -1px;
    }

    .saly-tab-wrapper .nav-link {
      border-radius: 10px 10px 0 0;
      padding: 8px 20px;
      background-color: #f7f8fa;
      color: #a1a6ad;
      font-weight: 500;
      border: 1px solid #d1d5db;
      border-bottom-color: #d1d5db;
      box-shadow: inset 0 -2px 0 rgba(0,0,0,0.03);
      transition: background-color 0.15s ease,
                  color 0.15s ease,
                  box-shadow 0.15s ease;
    }

    .saly-tab-wrapper .nav-item + .nav-item .nav-link {
      margin-left: -1px;
    }

    .saly-tab-wrapper .nav-link:not(.active):hover {
      background-color: #eff1f4;
      color: #7a7f87;
    }

    .saly-tab-wrapper .nav-link.active {
      background-color: #ffffff;
      color: #111111;
      font-weight: 600;
      border-color: #d1d5db;
      border-bottom-color: #ffffff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.06);
      z-index: 2;
    }

    .saly-card-body > .mt-2 {
      margin-top: 0 !important;
    }
  </style>
</head>
<body layout:fragment="content">
<div class="row">
  <!-- ê²€ìƒ‰ì¡°ê±´ -->
  <div class="col-md-12">
    <div class="card mb-3">
      <div class="card-header">
        <h5 class="card-title">ê²€ìƒ‰ì¡°ê±´</h5>
        <div class="card-header-right">
          <button class="btn btn-outline-dark" id="btnSearch">ì¡°íšŒ</button>
        </div>
      </div>
      <div class="card-body">
        <div class="row">
          <!-- ê¸‰ì—¬ëŒ€ì¥ëª…ì¹­ -->
          <div class="col-md-2">
            <label class="form-label">ê¸‰ì—¬ëŒ€ì¥ëª…ì¹­</label>
            <input type="text" id="srchSalyNm" class="form-control">
          </div>
          <!-- ì§€ê¸‰ì¼ì ê¸°ê°„ -->
          <div class="col-md-4">
            <label class="form-label">ì§€ê¸‰ì¼ì</label>
            <div class="d-flex align-items-center js-date-range">
              <div class="input-group date me-2">
                <input type="text"
                       class="form-control js-date-range-start"
                       id="payDtStart"
                       placeholder="ë‚ ì§œ ì„ íƒ">
                <span class="input-group-text js-date-range-icon-start">
                  <i class="bi bi-calendar"></i>
                </span>
              </div>
              <span class="mx-1 fw-bold fs-5">~</span>
              <div class="input-group date ms-2">
                <input type="text"
                       class="form-control js-date-range-end"
                       id="payDtEnd"
                       placeholder="ë‚ ì§œ ì„ íƒ">
                <span class="input-group-text js-date-range-icon-end">
                  <i class="bi bi-calendar"></i>
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ê¸‰ì—¬ëª©ë¡ -->
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">ê¸‰ì—¬ëª©ë¡</h5>
        <div class="card-header-right d-flex gap-2">
          <!-- <button class="btn btn-outline-dark" id="btnSalyCalc">ê¸‰ì—¬ê³„ì‚°</button> -->
          <div th:replace="~{fragments/buttons :: calcButton('MENU_HR_008', 'btnSalyCalc')}"></div>
          <button class="btn btn-outline-dark" id="btnSalySpec">ëª…ì„¸ì„œ ì¡°íšŒ</button>
          <!-- <button class="btn btn-outline-dark" id="openSalyRegistModal">ë“±ë¡/ìˆ˜ì •</button> -->
          <div th:replace="~{fragments/buttons :: regButton('MENU_HR_008', 'openSalyRegistModal')}"></div>
          <!-- <button class="btn btn-outline-dark" id="btnToggleConfirm">í™•ì •/ì·¨ì†Œ</button> -->
          <div th:replace="~{fragments/buttons :: confirmButton('MENU_HR_008', 'btnToggleConfirm')}"></div>
          <!-- <button class="btn btn-danger" id="btnSalyDelete">ì‚­ì œ</button> -->
          <div th:replace="~{fragments/buttons :: deleteButton('MENU_HR_008', 'btnSalyDelete')}"></div>
        </div>
      </div>
      <div class="card-body saly-card-body">
        <div class="saly-tab-wrapper">
          <ul class="nav nav-tabs" id="salyStatusTabs">
            <li class="nav-item">
              <button class="nav-link active" type="button" data-status="BEFORE_PAY">
                ì§€ê¸‰ì „
              </button>
            </li>
            <li class="nav-item">
              <button class="nav-link" type="button" data-status="PAID">
                ì§€ê¸‰ì™„ë£Œ
              </button>
            </li>
          </ul>
        </div>

        <div id="grid" class="mt-2"></div>
      </div>
    </div>
  </div>
</div>

<!-- ëª¨ë‹¬ include -->
<div th:replace="insa/modal/salyRegistModal :: salyRegistModal"></div>

<script>
  /***********************
   * 0. ê³µí†µ: ë¶€ì„œ ì…€ë ‰íŠ¸ ë¡œë”© (ëª¨ë‹¬ìš©ë§Œ ì‚¬ìš©)
   ***********************/
  function loadDeptOptions() {
    const modalDept  = document.getElementById("salyDept");

    if (modalDept) {
      modalDept.innerHTML = '<option value="">ì „ì²´</option>';
    }

    fetch('/insa/edc/inputOption')
      .then(res => res.json())
      .then(data => {
        const deptList = data.dept || [];
        deptList.forEach(d => {
          if (modalDept) {
            const opt2 = document.createElement("option");
            opt2.value = d.deptId;
            opt2.textContent = d.deptNm;
            modalDept.appendChild(opt2);
          }
        });
      })
      .catch(() => {
        alert("ë¶€ì„œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      });
  }

  /***********************
   * 1. ë©”ì¸ ê·¸ë¦¬ë“œ ë°ì´í„°
   ***********************/
  let originalGridData = [];
  let currentTabStatus = "BEFORE_PAY"; // BEFORE_PAY / PAID
  let gridData = [];
  // âœ… í˜„ì¬ ì„ íƒëœ rowKey (ë¼ë””ì˜¤ ì„ íƒìš©)
  let selectedRowKey = null;

  /***************************
   * 2. ë©”ì¸ ê¸‰ì—¬ëŒ€ì¥ TUI Grid
   ***************************/
  const grid = new tui.Grid({
    el: document.getElementById("grid"),
    data: gridData,
    bodyHeight: 408,
    scrollX: false,
    scrollY: true,
    rowHeaders: [],
    columns: [
      {
        header: "",
        name: "ì„ íƒ",
        width: 50,
        align: "center",
        formatter: () => {
          // DOM ë¼ë””ì˜¤ ìì²´ëŠ” ë‹¨ìˆœ í‘œì‹œìš©, rowKeyëŠ” JS ë³€ìˆ˜ë¡œ ê´€ë¦¬
          return `<input type="radio" name="salyLedgRadio" />`;
        }
      },
      { header: "ê·€ì†ì—°ì›”",     name: "revsMmdd",   align: "center" },
      { header: "ì§€ê¸‰ì¼",       name: "payDt",      align: "center" },
      { header: "ê¸‰ì—¬ëŒ€ì¥ëª…ì¹­", name: "salyLedgNm" },
      { header: "ì¸ì›ìˆ˜",       name: "rcnt",       align: "right" },
      {
        header: "ì§€ê¸‰ì´ì•¡",
        name: "ttPayAmt",
        align: "right",
        formatter: ({ value }) => {
          if (value == null || value === "") return "";
          return Number(value).toLocaleString("ko-KR", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          });
        }
      },
      {
        header: "ìƒíƒœ",
        name: "salyLedgStNm",
        align: "center"
      }
    ]
  });

  /************************
   * 3. DBì—ì„œ ê¸‰ì—¬ëŒ€ì¥ ëª©ë¡ ì¡°íšŒ
   ************************/
  function loadSalyList() {
    const salyNmInput    = document.getElementById("srchSalyNm");
    const payDtStartInput = document.getElementById("payDtStart");
    const payDtEndInput   = document.getElementById("payDtEnd");

    const salyNm    = salyNmInput ? salyNmInput.value.trim() : "";
    const payDtStart = payDtStartInput ? payDtStartInput.value.trim() : "";
    const payDtEnd   = payDtEndInput ? payDtEndInput.value.trim() : "";

    const params = new URLSearchParams();
    if (salyNm)    params.append("salyLedgNm", salyNm);
    if (payDtStart) params.append("payDtStart", payDtStart);
    if (payDtEnd)   params.append("payDtEnd", payDtEnd);

    fetch("/insa/saly/list?" + params.toString())
      .then(res => {
        if (!res.ok) {
          throw new Error("ê¸‰ì—¬ëŒ€ì¥ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨ (HTTP " + res.status + ")");
        }
        return res.json();
      })
      .then(list => {
        originalGridData = (list || []).map(r => {
          let revsMmdd = "";
          if (r.revsYm) {
            revsMmdd = String(r.revsYm);
          }

          let payDtStr = "";
          if (r.payDt) {
            let raw = String(r.payDt);
            if (raw.includes("T")) {
              raw = raw.substring(0, 10);
            }
            payDtStr = raw;
          }

          return {
            salyLedgId : r.salyLedgId,
            revsMmdd   : revsMmdd,
            payDt      : payDtStr,
            salyLedgNm : r.salyLedgNm,
            rcnt       : r.rcnt,
            salyLedgSt : r.salyLedgSt,
            salyLedgStNm: r.salyLedgStNm || "",
            ttPayAmt   : r.ttPayAmt
          };
        });

        // ë¦¬ìŠ¤íŠ¸ ìƒˆë¡œ ë¶ˆëŸ¬ì˜¤ë©´ ì„ íƒ ì´ˆê¸°í™”
        selectedRowKey = null;
        applyTabFilter();
      })
      .catch(err => {
        console.error("ê¸‰ì—¬ëŒ€ì¥ ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜", err);
        alert("ê¸‰ì—¬ëŒ€ì¥ ëª©ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      });
  }

  document.getElementById("btnSearch")?.addEventListener("click", loadSalyList);

  // ğŸ” ê²€ìƒ‰ì¡°ê±´ ì—”í„°ë¡œë„ ì¡°íšŒ
  const srchSalyNmEl   = document.getElementById("srchSalyNm");
  const payDtStartEl   = document.getElementById("payDtStart");
  const payDtEndEl     = document.getElementById("payDtEnd");

  [srchSalyNmEl, payDtStartEl, payDtEndEl].forEach(el => {
    if (!el) return;
    el.addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        e.preventDefault();
        loadSalyList();
      }
    });
  });

  /*************************
   * 4. ë¼ë””ì˜¤ ì„ íƒ í—¬í¼
   *************************/
  function getSelectedRow() {
    if (selectedRowKey === null || selectedRowKey === undefined) {
      return null;
    }
    const row = grid.getRow(selectedRowKey);
    if (!row) return null;
    return { rowKey: selectedRowKey, row };
  }

  /*************************
   * 5. íƒ­ìœ¼ë¡œ ì§€ê¸‰ì „ / ì§€ê¸‰ì™„ë£Œ ë¶„ë¦¬
   *************************/
  const statusTabs         = document.querySelectorAll("#salyStatusTabs .nav-link");
  const btnSalyDelete      = document.getElementById("btnSalyDelete");
  const btnSalyCalc        = document.getElementById("btnSalyCalc");
  const btnSalySpec        = document.getElementById("btnSalySpec");
  const btnToggleConfirm   = document.getElementById("btnToggleConfirm");
  const openSalyRegistBtn  = document.getElementById("openSalyRegistModal");

  function applyTabFilter() {
    if (currentTabStatus === "PAID") {
      // sal3 = ì§€ê¸‰ì™„ë£Œ
      gridData = originalGridData.filter(row => row.salyLedgSt === "sal3");
    } else {
      // ì§€ê¸‰ì „: sal1(ë¯¸í™•ì •) + sal2(í™•ì •)
      gridData = originalGridData.filter(row => row.salyLedgSt !== "sal3");
    }
    grid.resetData(gridData);

    const isPaidTab = currentTabStatus === "PAID";

    if (btnSalyDelete) {
      btnSalyDelete.style.display = isPaidTab ? "none" : "";
      btnSalyDelete.disabled      = isPaidTab;
    }
    if (btnSalyCalc) {
      btnSalyCalc.style.display   = isPaidTab ? "none" : "";
      btnSalyCalc.disabled        = isPaidTab;
    }
    if (btnToggleConfirm) {
      btnToggleConfirm.style.display = isPaidTab ? "none" : "";
      btnToggleConfirm.disabled      = isPaidTab;
    }
    if (openSalyRegistBtn) {
      openSalyRegistBtn.style.display = isPaidTab ? "none" : "";
      openSalyRegistBtn.disabled      = isPaidTab;
    }
    if (btnSalySpec) {
      btnSalySpec.style.display = "";
      btnSalySpec.disabled      = false;
    }

    updateConfirmButtonLabel();
  }

  statusTabs.forEach(tab => {
    tab.addEventListener("click", function () {
      statusTabs.forEach(t => t.classList.remove("active"));
      this.classList.add("active");
      currentTabStatus = this.dataset.status || "BEFORE_PAY";
      // íƒ­ ë°”ê¾¸ë©´ ì„ íƒ ì´ˆê¸°í™”
      selectedRowKey = null;
      applyTabFilter();
    });
  });

  /*************************
   * 6. í™•ì •/í™•ì •ì·¨ì†Œ í† ê¸€ ë²„íŠ¼
   *************************/
  function updateConfirmButtonLabel() {
    if (!btnToggleConfirm) return;

    const selected = getSelectedRow();
    if (!selected) {
      btnToggleConfirm.textContent = "í™•ì •/ì·¨ì†Œ";
      return;
    }

    const { row } = selected;
    const code = row.salyLedgSt;

    if (code === "sal1") {
      btnToggleConfirm.textContent = "í™•ì •";
    } else if (code === "sal2") {
      btnToggleConfirm.textContent = "í™•ì •ì·¨ì†Œ";
    } else if (code === "sal3") {
      btnToggleConfirm.textContent = "í™•ì •";
    }
  }

  if (btnToggleConfirm) {
    btnToggleConfirm.addEventListener("click", () => {
      const selected = getSelectedRow();
      if (!selected) {
        alert("í™•ì •/ì·¨ì†Œí•  ê¸‰ì—¬ëŒ€ì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
      }

      const { rowKey, row } = selected;
      const code = row.salyLedgSt;

      if (code === "sal3") {
        alert("ì§€ê¸‰ì™„ë£Œëœ ê¸‰ì—¬ëŒ€ì¥ì€ í™•ì • ìƒíƒœë¥¼ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      // sal1(ë¯¸í™•ì •) <-> sal2(í™•ì •) í† ê¸€ (í”„ë¡ íŠ¸ í‘œí˜„ë§Œ)
      if (code === "sal1") {
        grid.setValue(rowKey, "salyLedgSt", "sal2");
        grid.setValue(rowKey, "salyLedgStNm", "í™•ì •");
      } else if (code === "sal2") {
        grid.setValue(rowKey, "salyLedgSt", "sal1");
        grid.setValue(rowKey, "salyLedgStNm", "ë¯¸í™•ì •");
      }

      updateConfirmButtonLabel();

      // TODO: ì‹¤ì œ DB ì—…ë°ì´íŠ¸ API(/insa/saly/confirm) ë¶™ì´ë©´ ì—¬ê¸°ì„œ í˜¸ì¶œ
    });
  }

  // âœ… ê·¸ë¦¬ë“œ í´ë¦­: ë¼ë””ì˜¤ ë²„íŠ¼ í´ë¦­ì¼ ë•Œë§Œ ì„ íƒ ë°˜ì˜
  grid.on("click", ev => {
    const { rowKey, nativeEvent } = ev;
    if (rowKey == null) return;

    const target = nativeEvent.target;

    // ë¼ë””ì˜¤ ë²„íŠ¼ì„ í´ë¦­í•œ ê²½ìš°ì—ë§Œ ì„ íƒ ìƒíƒœ/ë¼ë²¨ ì—…ë°ì´íŠ¸
    if (target instanceof HTMLElement && target.type === "radio") {
      selectedRowKey = rowKey;
      updateConfirmButtonLabel();
      // ë¼ë””ì˜¤ ì²´í¬ëŠ” name="salyLedgRadio" ê³µí†µì´ë¼ ë¸Œë¼ìš°ì € ê¸°ë³¸ ë™ì‘ì— ë§¡ê¹€
    }
    // ê·¸ ì™¸ ì…€ í´ë¦­ ì‹œì—ëŠ” ì•„ë¬´ ê²ƒë„ í•˜ì§€ ì•ŠìŒ
  });

  /*************************
   * 7. ì‚­ì œ ë²„íŠ¼ (API ì—°ë™)
   *************************/
  if (btnSalyDelete) {
    btnSalyDelete.addEventListener("click", () => {
      const selected = getSelectedRow();
      if (!selected) {
        alert("ì‚­ì œí•  ê¸‰ì—¬ëŒ€ì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
      }
      const { row } = selected;

      if (!confirm("ì„ íƒí•œ ê¸‰ì—¬ëŒ€ì¥ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        return;
      }

      fetch("/insa/saly/delete", {
        method : "POST",
        headers: { "Content-Type": "application/json" },
        body   : JSON.stringify({ salyLedgId: row.salyLedgId })
      })
      .then(res => res.json())
      .then(body => {
        if (!body || body.result !== "SUCCESS") {
          const msg = (body && body.message) || "ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
          alert(msg);
          return;
        }
        alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        loadSalyList();
      })
      .catch(err => {
        console.error("ê¸‰ì—¬ëŒ€ì¥ ì‚­ì œ ì˜¤ë¥˜", err);
        alert("ê¸‰ì—¬ëŒ€ì¥ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      });
    });
  }

  /***********************
   * 9. ëª¨ë‹¬ & ì‚¬ì› ê·¸ë¦¬ë“œ
   ***********************/
  const modal   = document.getElementById("salyRegistModal");
  const back    = document.getElementById("salyRegistBackdrop");
  const btnSalySave = document.getElementById("btnSalySave");
  const btnSalyEmpSearch = document.getElementById("btnSalyEmpSearch");
  const salyEmpNmCond = document.getElementById("salyEmpNmCond");
  const modalDept = document.getElementById("salyDept");

  const grid2El = document.getElementById("grid2");
  let grid2 = null;

  // ìˆ˜ì • ëª¨ë“œ í”Œë˜ê·¸
  let editMode = false;
  let editingSalyLedgId = null;
  // ìˆ˜ì • ì‹œ ì´ˆê¸° ì²´í¬í•  ì‚¬ì› ID ëª©ë¡
  let initialCheckedEmpIds = [];

  function initEmpGrid() {
    if (!grid2El || grid2) return;
    grid2 = new tui.Grid({
      el: grid2El,
      data: [],
      bodyHeight: 320,
      scrollX: false,
      scrollY: true,
      rowHeaders: ['checkbox'],
      columns: [
        { header: "ì‚¬ì›ë²ˆí˜¸", name: "empId" },
        { header: "ì‚¬ì›ëª…",   name: "nm" },
        { header: "ê³ ìš©í˜•íƒœ", name: "emplymTyNm" },
        { header: "ë¶€ì„œëª…",   name: "deptNm" }
      ]
    });
  }

  function applyCheckedEmpIdsToGrid2() {
    if (!grid2 || !initialCheckedEmpIds || initialCheckedEmpIds.length === 0) return;
    const rows = grid2.getData();
    rows.forEach(row => {
      if (initialCheckedEmpIds.includes(row.empId)) {
        grid2.check(row.rowKey);
      }
    });
  }

  function loadEmpList() {
    if (!grid2) return;

    const deptId = modalDept ? (modalDept.value || "") : "";
    const empNm  = salyEmpNmCond ? salyEmpNmCond.value.trim() : "";

    const param = {
      deptId: deptId,
      empNm : empNm
    };

    fetch("/insa/saly/empList", {
      method : "POST",
      headers: { "Content-Type": "application/json" },
      body   : JSON.stringify(param)
    })
    .then(res => res.json())
    .then(list => {
      const data = (list || []).map(e => ({
        empId:      e.empId,
        nm:         e.nm,
        emplymTyNm: e.emplymTyNm || e.emplymTy || "",
        deptNm:     e.deptNm || ""
      }));
      grid2.resetData(data);
      // ìˆ˜ì • ëª¨ë“œì¼ ë•Œ ê¸°ì¡´ ì‚¬ì› ì²´í¬
      applyCheckedEmpIdsToGrid2();
    })
    .catch(err => {
      console.error("ì‚¬ì› ì¡°íšŒ ì˜¤ë¥˜", err);
      alert("ì‚¬ì› ëª©ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    });
  }

  /***********************
   * 9-1. ê·€ì†ì—°ì›”/ì§€ê¸‰ì¼ì datepicker ì´ˆê¸°í™” í•¨ìˆ˜
   *      - ê·€ì†ì—°ì›”: ì§€ë‚œ ë‹¬ê¹Œì§€ ì„ íƒ ê°€ëŠ¥
   *      - ì§€ê¸‰ì¼ì: ì˜¤ëŠ˜ ì´ì „ ë‚ ì§œ ì„ íƒ ë¶ˆê°€
   ***********************/
  function initRevsYmPicker() {
    const $revsYm = $("#revs_ym");
    if (!$revsYm.length) return;

    if ($revsYm.data("datepicker")) {
      $revsYm.datepicker("destroy");
    }

    const today = new Date();
    // ì§€ë‚œ ë‹¬ì˜ ë§ˆì§€ë§‰ ë‚  (ì˜ˆ: ì˜¤ëŠ˜ì´ 12ì›”ì´ë©´ 11ì›” 30ì¼)
    const lastMonthLastDay = new Date(today.getFullYear(), today.getMonth(), 0);

    $revsYm
      .datepicker({
        format: "yyyy-mm",
        autoclose: true,
        minViewMode: 1,   // ì›” ë‹¨ìœ„
        language: "ko",
        endDate: lastMonthLastDay
      })
      .on("show", function () {
        const $self  = $(this);
        const $modal = $self.closest(".modal");
        if (!$modal.length) return;

        const modalZ = parseInt($modal.css("z-index"), 10) || 1055;
        setTimeout(function () {
          $(".datepicker-dropdown").each(function () {
            this.style.setProperty(
              "z-index",
              String(modalZ + 10),
              "important"
            );
          });
        }, 0);
      });
  }

  function initPayDtPicker() {
    const $payDt = $("#payDt");
    if (!$payDt.length) return;

    if ($payDt.data("datepicker")) {
      $payDt.datepicker("destroy");
    }

    const today = new Date();
    const todayZero = new Date(
      today.getFullYear(),
      today.getMonth(),
      today.getDate()
    );

    $payDt
      .datepicker({
        format: "yyyy-mm-dd",
        autoclose: true,
        language: "ko",
        startDate: todayZero,
        beforeShowDay: function (date) {
          const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
          if (d < todayZero) {
            return false;
          }
          return true;
        }
      })
      .on("show", function () {
        const $self  = $(this);
        const $modal = $self.closest(".modal");
        if (!$modal.length) return;

        const modalZ = parseInt($modal.css("z-index"), 10) || 1055;
        setTimeout(function () {
          $(".datepicker-dropdown").each(function () {
            this.style.setProperty(
              "z-index",
              String(modalZ + 10),
              "important"
            );
          });
        }, 0);
      });
  }

  function openSalyModal() {
    if (!modal || !back) return;

    modal.classList.add("show");
    modal.style.display = "block";
    back.style.display  = "block";

    // âœ… ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œë§ˆë‹¤ datepicker ì¬ì´ˆê¸°í™”
    initRevsYmPicker();
    initPayDtPicker();

    initEmpGrid();
    loadEmpList();

    if (grid2 && grid2.refreshLayout) {
      grid2.refreshLayout();
    }
  }

  function closeSalyRegistModal() {
    if (modal) {
      modal.classList.remove("show");
      modal.style.display = "none";
    }
    if (back) {
      back.style.display = "none";
    }
    editMode = false;
    editingSalyLedgId = null;
    initialCheckedEmpIds = [];
  }

  if (openSalyRegistBtn) {
    openSalyRegistBtn.addEventListener("click", () => {
      const selected = getSelectedRow();

      if (!selected) {
        // ì‹ ê·œ ëª¨ë“œ
        editMode = false;
        editingSalyLedgId = null;
        initialCheckedEmpIds = [];

        // ëª¨ë‹¬ í¼ ì´ˆê¸°í™”
        if (window.TeamCommon && TeamCommon.modal && typeof TeamCommon.modal.reset === "function") {
          TeamCommon.modal.reset(modal);
        }

        openSalyModal();
      } else {
        // ìˆ˜ì • ëª¨ë“œ
        const { row } = selected;
        editMode = true;
        editingSalyLedgId = row.salyLedgId;
        initialCheckedEmpIds = [];

        fetch("/insa/saly/detail?salyLedgId=" + encodeURIComponent(row.salyLedgId))
          .then(res => res.json())
          .then(vo => {
            if (!vo || !vo.salyLedgId) {
              alert("ê¸‰ì—¬ëŒ€ì¥ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
              return;
            }

            initialCheckedEmpIds = Array.isArray(vo.empIdList) ? vo.empIdList : [];

            // ëª¨ë‹¬ ì—´ê³  ê°’ ì„¸íŒ…
            openSalyModal();
            fillSalyModal(vo);

            // ì‚¬ì› ì²´í¬ ë°˜ì˜(ê·¸ë¦¬ë“œ ë°ì´í„° ë¡œë”© ì´í›„ì—ë„ í•œ ë²ˆ ë”)
            setTimeout(applyCheckedEmpIdsToGrid2, 0);
          })
          .catch(err => {
            console.error("ê¸‰ì—¬ëŒ€ì¥ ìƒì„¸ ì¡°íšŒ ì˜¤ë¥˜", err);
            alert("ê¸‰ì—¬ëŒ€ì¥ ìƒì„¸ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          });
      }
    });
  }

  function fillSalyModal(vo) {
    const salyNmInput = document.getElementById("salyNm");
    const revsYmInput = document.getElementById("revs_ym");
    const payDtInput  = document.getElementById("payDt");

    if (salyNmInput) salyNmInput.value = vo.salyLedgNm || "";
    if (revsYmInput) revsYmInput.value = vo.revsYm || "";
    if (payDtInput)  payDtInput.value  = vo.payDt || "";

    // datepicker ì‹¤ì œ ê°’ë„ ì—…ë°ì´íŠ¸
    const revsYm = vo.revsYm || null;
    const payDt  = vo.payDt || null;

    if (revsYm && $('#revs_ym').data('datepicker')) {
      $('#revs_ym').datepicker('update', revsYm);
    }
    if (payDt && $('#payDt').data('datepicker')) {
      $('#payDt').datepicker('update', payDt);
    }
  }

  if (back) {
    back.addEventListener("click", closeSalyRegistModal);
  }
  if (modal) {
    modal.addEventListener("click", function (e) {
      if (!e.target.closest(".modal-content")) {
        closeSalyRegistModal();
      }
    });
  }
  document.addEventListener("keydown", function (e) {
    if (e.key === "Escape") {
      closeSalyRegistModal();
    }
  });

  // ì‚¬ì› ê²€ìƒ‰ ë²„íŠ¼ + ì—”í„° + ë¶€ì„œ ë³€ê²½
  btnSalyEmpSearch?.addEventListener("click", loadEmpList);
  salyEmpNmCond?.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      loadEmpList();
    }
  });
  modalDept?.addEventListener("change", loadEmpList);

  /***********************
   * 11. ê¸‰ì—¬ëŒ€ì¥ ì €ì¥ (ì‹ ê·œ/ìˆ˜ì • ê³µí†µ)
   ***********************/
  const btnSalySaveEl = document.getElementById("btnSalySave");
  if (btnSalySaveEl) {
    btnSalySaveEl.addEventListener("click", () => {
      const salyNmInput = document.getElementById("salyNm");
      const revsYmInput = document.getElementById("revs_ym");
      const payDtInput  = document.getElementById("payDt");

      const salyNm = salyNmInput ? salyNmInput.value.trim() : "";
      const revsYm = revsYmInput ? revsYmInput.value.trim() : "";
      const payDt  = payDtInput ? payDtInput.value.trim() : "";

      if (!salyNm) {
        alert("ê¸‰ì—¬ëŒ€ì¥ëª…ì¹­ì„ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }
      if (!revsYm) {
        alert("ê·€ì†ì—°ì›”ì„ ì„ íƒí•˜ì„¸ìš”.");
        return;
      }
      if (!payDt) {
        alert("ì§€ê¸‰ì¼ìë¥¼ ì„ íƒí•˜ì„¸ìš”.");
        return;
      }
      if (!grid2) {
        alert("ì‚¬ì› ëª©ë¡ ê·¸ë¦¬ë“œê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        return;
      }

      const checkedRows = grid2.getCheckedRows();
      if (!checkedRows || checkedRows.length === 0) {
        alert("ê¸‰ì—¬ëª…ì„¸ì„œë¥¼ ìƒì„±í•  ì‚¬ì›ì„ í•œ ëª… ì´ìƒ ì„ íƒí•˜ì„¸ìš”.");
        return;
      }

      const empIdList = checkedRows.map(r => r.empId);
      const isEdit = editMode && editingSalyLedgId;

      const payload = {
        salyLedgId : isEdit ? editingSalyLedgId : null,
        salyLedgNm : salyNm,
        revsYm     : revsYm,
        payDt      : payDt,
        empIdList  : empIdList
      };

      fetch("/insa/saly/save", {
        method : "POST",
        headers: { "Content-Type": "application/json" },
        body   : JSON.stringify(payload)
      })
      .then(res => res.json())
      .then(body => {
        if (body.result !== "SUCCESS") {
          const msg = body.message || "ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
          alert(msg);
          return;
        }

        alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");

        loadSalyList();
        closeSalyRegistModal();
      })
      .catch(err => {
        console.error("ê¸‰ì—¬ëŒ€ì¥ ì €ì¥ ì˜¤ë¥˜", err);
        alert("ê¸‰ì—¬ëŒ€ì¥ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      });
    });
  }

  /***********************
   * 12. í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°ì‘ì—…
   ***********************/
  document.addEventListener("DOMContentLoaded", () => {
    loadDeptOptions();
    loadSalyList();
  });
</script>
</body>
</html>
