<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
    <script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>

    <title>salyLedg</title>
</head>
<body layout:fragment="content">
    <div class="row">
        <!-- ê²€ìƒ‰ì¡°ê±´ -->
        <div class="col-md-12">
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="card-title">ê²€ìƒ‰ì¡°ê±´</h5>
                    <div class="card-header-right">
                        <button class="btn btn-outline-dark">ì¡°íšŒ</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">ê¸‰ì—¬ëŒ€ì¥ëª…ì¹­</label>
                            <input type="text" class="form-control">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">ë¶€ì„œëª…</label>
                            <select id="dept" class="form-select">
                                <option>ì „ì²´</option>
                                <option>ì¸ì‚¬</option>
                                <option>ìì¬</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">ê¸‰ì—¬í™•ì •ì—¬ë¶€</label>
                            <select id="pay_yn" class="form-select">
                                <option>ì „ì²´</option>
                                <option>í™•ì •</option>
                                <option>ë¯¸í™•ì •</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">ì§€ê¸‰ì¼ì</label>
                            <div class="d-flex align-items-center js-date-range">
                                <!-- ì‹œì‘ì¼ -->
                                <div class="input-group date me-2">
                                    <input type="text"
                                           class="form-control js-date-range-start"
                                           id="payDtStart"
                                           placeholder="ë‚ ì§œ ì„ íƒ">
                                    <span class="input-group-text js-date-range-icon-start">
                                        <i class="bi bi-calendar"></i>
                                    </span>
                                </div>

                                <!-- ~ -->
                                <span class="mx-1 fw-bold fs-5">~</span>

                                <!-- ì¢…ë£Œì¼ -->
                                <div class="input-group date ms-2">
                                    <input type="text"
                                           class="form-control js-date-range-end"
                                           id="payDtEnd"
                                           placeholder="ë‚ ì§œ ì„ íƒ">
                                    <span class="input-group-text js-date-range-icon-end">
                                        <i class="bi bi-calendar"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì‚¬ì›ëª©ë¡ -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">ê¸‰ì—¬ëª©ë¡</h5>
                    <div class="card-header-right">
                        <button class="btn btn-outline-dark" id="openSalyRegistModal">ë“±ë¡</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="grid" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <div th:replace="insa/modal/salyRegistModal :: salyRegistModal"></div>

    <script>
        /* =====================================================
         * 1. Grid (ê·¸ë¦¬ë“œ ê·¸ëŒ€ë¡œ ìœ ì§€)
         * ===================================================== */
        const gridData = [
            {
                revsMmdd: "2025-01",
                payDt: "2025-01-25",
                salyLedgNm: "2025ë…„ 1ì›” ê¸‰ì—¬ëŒ€ì¥",
                deptNm: "ê°œë°œíŒ€",
                rcnt: 8,
                preWork: "ì™„ë£Œ",
                salyLedg: "ì‘ì„±ì™„ë£Œ",
                ttPayAmt: 3500000,
                salySpec: "ì¶œë ¥"
            },
            {
                revsMmdd: "2025-01",
                payDt: "2025-01-25",
                salyLedgNm: "2025ë…„ 1ì›” ê¸‰ì—¬ëŒ€ì¥",
                deptNm: "ì¸ì‚¬íŒ€",
                rcnt: 3,
                preWork: "ì™„ë£Œ",
                salyLedg: "í™•ì •",
                ttPayAmt: 2800000,
                salySpec: "ì¶œë ¥"
            },
            {
                revsMmdd: "2025-01",
                payDt: "2025-01-25",
                salyLedgNm: "2025ë…„ 1ì›” ê¸‰ì—¬ëŒ€ì¥",
                deptNm: "ì˜ì—…íŒ€",
                rcnt: 10,
                preWork: "ë¯¸ì™„ë£Œ",
                salyLedg: "ì‘ì„±ì¤‘",
                ttPayAmt: 4200000,
                salySpec: "ë¯¸ì¶œë ¥"
            },
            {
                revsMmdd: "2025-02",
                payDt: "2025-02-25",
                salyLedgNm: "2025ë…„ 2ì›” ê¸‰ì—¬ëŒ€ì¥",
                deptNm: "ê°œë°œíŒ€",
                rcnt: 9,
                preWork: "ì™„ë£Œ",
                salyLedg: "ì‘ì„±ì™„ë£Œ",
                ttPayAmt: 3600000,
                salySpec: "ì¶œë ¥"
            },
            {
                revsMmdd: "2025-02",
                payDt: "2025-02-25",
                salyLedgNm: "2025ë…„ 2ì›” ê¸‰ì—¬ëŒ€ì¥",
                deptNm: "ì¸ì‚¬íŒ€",
                rcnt: 3,
                preWork: "ì™„ë£Œ",
                salyLedg: "í™•ì •",
                ttPayAmt: 2750000,
                salySpec: "ì¶œë ¥"
            },
            {
                revsMmdd: "2025-02",
                payDt: "2025-02-25",
                salyLedgNm: "2025ë…„ 2ì›” ê¸‰ì—¬ëŒ€ì¥",
                deptNm: "ì˜ì—…íŒ€",
                rcnt: 11,
                preWork: "ì™„ë£Œ",
                salyLedg: "ì‘ì„±ì™„ë£Œ",
                ttPayAmt: 4300000,
                salySpec: "ì¶œë ¥"
            },
            {
                revsMmdd: "2025-03",
                payDt: "2025-03-25",
                salyLedgNm: "2025ë…„ 3ì›” ê¸‰ì—¬ëŒ€ì¥",
                deptNm: "ì´ë¬´íŒ€",
                rcnt: 4,
                preWork: "ì™„ë£Œ",
                salyLedg: "í™•ì •",
                ttPayAmt: 3000000,
                salySpec: "ì¶œë ¥"
            }
        ];

        const gridData2 = [
            {
                empId: "EMP001",
                nm: "ê¹€ì² ìˆ˜",
                emplymTy: "ì •ê·œì§",
                deptNm: "ê°œë°œíŒ€"
            },
            {
                empId: "EMP002",
                nm: "ì´ì˜í¬",
                emplymTy: "ì •ê·œì§",
                deptNm: "ì¸ì‚¬íŒ€"
            },
            {
                empId: "EMP003",
                nm: "ë°•ë¯¼ìˆ˜",
                emplymTy: "ê³„ì•½ì§",
                deptNm: "ì˜ì—…íŒ€"
            },
            {
                empId: "EMP004",
                nm: "ìµœì§€ì—°",
                emplymTy: "ì •ê·œì§",
                deptNm: "ì´ë¬´íŒ€"
            },
            {
                empId: "EMP005",
                nm: "ì •ìš°ì„±",
                emplymTy: "ì•Œë°”",
                deptNm: "ë¬¼ë¥˜íŒ€"
            },
            {
                empId: "EMP006",
                nm: "í•œì§€ë¯¼",
                emplymTy: "ì •ê·œì§",
                deptNm: "ì¬ë¬´íŒ€"
            },
            {
                empId: "EMP007",
                nm: "ì˜¤ìƒì§„",
                emplymTy: "ê³„ì•½ì§",
                deptNm: "ê°œë°œíŒ€"
            },
            {
                empId: "EMP008",
                nm: "ìœ ì†Œë¼",
                emplymTy: "ì •ê·œì§",
                deptNm: "ë§ˆì¼€íŒ…íŒ€"
            }
        ];

        const GridOptions = {
            bodyHeight: 320,
            scrollX: false,
            scrollY: false,
            rowHeaders: ["checkbox"], // ì¢Œì¸¡ ì²´í¬ë°•ìŠ¤
            columnOptions: {
                minWidth: 80,
                resizable: true
            }
        };

        const grid = new tui.Grid({
            el: document.getElementById("grid"),
            data: gridData,
            scrollX: true,
            scrollY: true,
            minBodyHeight: 0,
            autoWidth: true,
            columns: [
                { header: "ê·€ì†ì—°ì›”",   name: "revsMmdd",  align: "center" },
                { header: "ì§€ê¸‰ì¼",     name: "payDt",     align: "center" },
                { header: "ê¸‰ì—¬ëŒ€ì¥ëª…ì¹­", name: "salyLedgNm" },
                { header: "ë¶€ì„œëª…",     name: "deptNm" },
                { header: "ì¸ì›ìˆ˜",     name: "rcnt",      align: "right" },
                { header: "ì‚¬ì „ì‘ì—…",   name: "preWork" },
                { header: "ê¸‰ì—¬ëŒ€ì¥",   name: "salyLedg" },
                { header: "ì´ì§€ê¸‰ì•¡",   name: "ttPayAmt",  align: "right" },
                { header: "ëª…ì„¸ì„œ",     name: "salySpec" }
            ]
        });

        const grid2 = new tui.Grid({
            el: document.getElementById("grid2"),
            data: gridData2,
            ...GridOptions,
            scrollX: true,
            scrollY: true,
            minBodyHeight: 0,
            autoWidth: true,
            columns: [
                { header: "ì‚¬ì›ë²ˆí˜¸", name: "empId" },
                { header: "ì‚¬ì›ëª…",   name: "nm" },
                { header: "ê³ ìš©í˜•íƒœ", name: "emplymTy" },
                { header: "ë¶€ì„œëª…",   name: "deptNm" }
            ]
        });

        /* =====================================================
         * 2. ëª¨ë‹¬ ì—´ê³ /ë‹«ê¸°
         * ===================================================== */
        const openBtn = document.getElementById("openSalyRegistModal");
        const modal   = document.getElementById("salyRegistModal");
        const back    = document.getElementById("salyRegistBackdrop");

        function openModal() {
            if (!modal || !back) return;
            modal.classList.add("show");
            modal.style.display = "block";
            back.style.display = "block";
            grid2.refreshLayout();
        }

        if (openBtn) {
            openBtn.addEventListener("click", openModal);
        }

        /* =====================================================
         * 3. ê·€ì†ì—°ì›”(revs_ym) â†” ì§€ê¸‰ì¼(payDt) ì—°ê³„ ë¡œì§
         *    - teamUtil.jsëŠ” ê±´ë“œë¦¬ì§€ ì•Šê³ , ì´ í™”ë©´ì—ì„œë§Œ ì²˜ë¦¬
         *    - payDt ìª½ì€ datepickerë¥¼ ìƒˆë¡œ ë§Œë“¤ì§€ ì•ŠëŠ”ë‹¤!!!
         * ===================================================== */
        $(function () {
            const $revsYm = $("#revs_ym"); // ê·€ì†ì—°ì›” input (.js-ym-input)
            const $payDt  = $("#payDt");   // ì§€ê¸‰ì¼ input (.js-date-input, teamUtilì—ì„œ datepicker ë¶™ìŒ)

            if (!$revsYm.length || !$payDt.length) return;

            // ğŸ”¹ ì•„ì´ì½˜ ìš”ì†Œ ì°¾ê¸°
            const $ymGroup = $revsYm.closest(".js-ym-single");
            const $ymIcon  = $ymGroup.find(".js-ym-icon");

            // ğŸ”¹ ì•„ì´ì½˜ í´ë¦­ ì‹œ input focus â†’ datepicker ì—´ë¦¼
            if ($ymIcon.length) {
                $ymIcon.on("click", function () {
                    $revsYm.focus();
                });
            }

            // 3-1. ê·€ì†ì—°ì›” datepicker ì´ˆê¸°í™” (ì›” ë‹¨ìœ„) + ëª¨ë‹¬ ìœ„ë¡œ z-index ë³´ì •
            $revsYm
                .datepicker({
                    format: "yyyy-mm",
                    autoclose: true,
                    minViewMode: 1, // ì›” ë‹¨ìœ„
                    language: "ko"
                })
                .on("show", function () {
                    // ëª¨ë‹¬ ë’¤ì— ê°€ë ¤ì§€ëŠ” ë¬¸ì œ ë°©ì§€
                    const $self  = $(this);
                    const $modal = $self.closest(".modal");

                    if (!$modal.length) return;

                    const modalZ = parseInt($modal.css("z-index"), 10) || 1055;

                    setTimeout(function () {
                        $(".datepicker-dropdown").each(function () {
                            this.style.setProperty("z-index", String(modalZ + 10), "important");
                        });
                    }, 0);
                });

            // yyyy-mm â†’ í•´ë‹¹ ì›” 1ì¼ Date
            function ymToFirstDay(ym) {
                if (!ym) return null;
                const m = /^(\d{4})-(\d{2})$/.exec(ym);
                if (!m) return null;

                const y  = parseInt(m[1], 10);
                const mo = parseInt(m[2], 10) - 1;
                const d  = new Date(y, mo, 1);

                if (d.getFullYear() !== y || d.getMonth() !== mo) return null;
                return d;
            }

            // Date â†’ yyyy-mm
            function dateToYm(date) {
                if (!date) return "";
                const y = date.getFullYear();
                const m = String(date.getMonth() + 1).padStart(2, "0");
                return y + "-" + m;
            }

            // í˜„ì¬ inputì— datepicker ì¸ìŠ¤í„´ìŠ¤ê°€ ìˆëŠ”ì§€ ì²´í¬
            function hasDatepicker($el) {
                return !!$el.data("datepicker");
            }

            // 3-2. ê·€ì†ì—°ì›” ë³€ê²½ â†’ ì§€ê¸‰ì¼ ìµœì†Œì¼(startDate) ê°±ì‹ 
            function syncFromRevsYm() {
                if (!hasDatepicker($payDt)) return; // ì•„ì§ teamUtilì—ì„œ ì•ˆ ë¶™ì—ˆìœ¼ë©´ ì¡°ìš©íˆ ë¬´ì‹œ

                const ymStr = $revsYm.val().trim();

                if (!ymStr) {
                    // ê·€ì†ì—°ì›”ì´ ë¹„ë©´ ì§€ê¸‰ì¼ í•˜í•œ í•´ì œ
                    $payDt.datepicker("setStartDate", null);
                    return;
                }

                const startDate = ymToFirstDay(ymStr);
                if (!startDate) {
                    $payDt.datepicker("setStartDate", null);
                    return;
                }

                // ì§€ê¸‰ì¼ì€ ê·€ì†ì—°ì›” 1ì¼ ì´í›„ë§Œ ì„ íƒ ê°€ëŠ¥
                $payDt.datepicker("setStartDate", startDate);

                const curPay = $payDt.datepicker("getDate");
                if (curPay && curPay < startDate) {
                    $payDt.datepicker("setDate", startDate);
                }
            }

            // 3-3. ì§€ê¸‰ì¼ ë³€ê²½ â†’ ê·€ì†ì—°ì›” ìµœëŒ€ì›”(endDate) ê°±ì‹ 
            function syncFromPayDt() {
                if (!hasDatepicker($revsYm)) return; // í˜¹ì‹œ ëª¨ë¥¼ ì•ˆì „ì¥ì¹˜

                const payDate = $payDt.datepicker("getDate");
                if (!payDate) {
                    // ì§€ê¸‰ì¼ì´ ë¹„ë©´ ê·€ì†ì—°ì›” ìƒí•œ í•´ì œ
                    $revsYm.datepicker("setEndDate", null);
                    return;
                }

                // ì§€ê¸‰ì¼ì´ ì†í•œ yyyy-mmê¹Œì§€ë§Œ ì„ íƒ ê°€ëŠ¥
                const maxYmDate = new Date(payDate.getFullYear(), payDate.getMonth(), 1);
                $revsYm.datepicker("setEndDate", maxYmDate);

                const curYmStr  = $revsYm.val().trim();
                const curYmDate = ymToFirstDay(curYmStr);

                if (curYmDate && curYmDate > maxYmDate) {
                    $revsYm.datepicker("setDate", maxYmDate);
                    $revsYm.val(dateToYm(maxYmDate));
                }
            }

            // 3-4. ì´ë²¤íŠ¸ ì—°ê²°
            // ê·€ì†ì—°ì›” ì„ íƒ / ì§ì ‘ ì…ë ¥ í›„ í¬ì»¤ìŠ¤ ì•„ì›ƒ
            $revsYm.on("changeDate", function () {
                syncFromRevsYm();
            });
            $revsYm.on("blur", function () {
                syncFromRevsYm();
            });

            // ì§€ê¸‰ì¼ ì„ íƒ / ì§ì ‘ ì…ë ¥ í›„ í¬ì»¤ìŠ¤ ì•„ì›ƒ
            $payDt.on("changeDate", function () {
                syncFromPayDt();
            });
            $payDt.on("blur", function () {
                syncFromPayDt();
            });

            // â— ì—¬ê¸°ì„œëŠ” ë” ì´ìƒ ì²˜ìŒì— syncFromRevsYm(), syncFromPayDt()ë¥¼ ê°•ì œë¡œ í˜¸ì¶œí•˜ì§€ ì•ŠëŠ”ë‹¤.
            //    (ì´ˆê¸° ì„œë²„ê°’ì´ ìˆë‹¤ë©´, ì²« ë³€ê²½ ì‹œì ë¶€í„° ì œì•½ì´ ê±¸ë¦¬ë„ë¡ ë™ì‘)
        });
    </script>
</body>
</html>
