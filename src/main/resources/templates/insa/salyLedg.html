<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <meta charset="UTF-8">

    <!-- Toast UI Grid -->
    <link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
    <script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>

    <title>salyLedg</title>

    <style>
        /* ê·¸ë¦¬ë“œ/í…Œì´ë¸” ì•ˆ ì‘ì€ ë²„íŠ¼ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .grid-btn {
            padding: 4px 10px;
            border: 1px solid #bbb;
            background-color: #fff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .grid-btn:hover {
            background-color: #eee;
        }
        .grid-btn:disabled {
            opacity: .5;
            cursor: not-allowed;
        }
        .grid-btn:focus {
            outline: none !important;
            box-shadow: none !important;
        }

        /* í•œ ì…€ ì•ˆ ë²„íŠ¼ ì„¸ë¡œ ì •ë ¬ + ì¤‘ì•™ì •ë ¬ */
        .grid-btn-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: center;
            justify-content: center;
            width: 100%;
        }

        #grid {
            width: 100%;
        }
    </style>
</head>
<body layout:fragment="content">
<div class="row">
    <!-- ê²€ìƒ‰ì¡°ê±´ -->
    <div class="col-md-12">
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="card-title">ê²€ìƒ‰ì¡°ê±´</h5>
                <div class="card-header-right">
                    <button class="btn btn-outline-dark" id="btnSearch">ì¡°íšŒ</button>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">ê¸‰ì—¬ëŒ€ì¥ëª…ì¹­</label>
                        <input type="text" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">ë¶€ì„œëª…</label>
                        <select id="dept" class="form-select">
                            <option>ì „ì²´</option>
                            <option>ì¸ì‚¬</option>
                            <option>ìì¬</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ê¸‰ì—¬í™•ì •ì—¬ë¶€</label>
                        <select id="pay_yn" class="form-select">
                            <option>ì „ì²´</option>
                            <option>í™•ì •</option>
                            <option>ë¯¸í™•ì •</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">ì§€ê¸‰ì¼ì</label>
                        <div class="d-flex align-items-center js-date-range">
                            <!-- ì‹œì‘ì¼ -->
                            <div class="input-group date me-2">
                                <input type="text"
                                       class="form-control js-date-range-start"
                                       id="payDtStart"
                                       placeholder="ë‚ ì§œ ì„ íƒ">
                                <span class="input-group-text js-date-range-icon-start">
                                    <i class="bi bi-calendar"></i>
                                </span>
                            </div>

                            <!-- ~ -->
                            <span class="mx-1 fw-bold fs-5">~</span>

                            <!-- ì¢…ë£Œì¼ -->
                            <div class="input-group date ms-2">
                                <input type="text"
                                       class="form-control js-date-range-end"
                                       id="payDtEnd"
                                       placeholder="ë‚ ì§œ ì„ íƒ">
                                <span class="input-group-text js-date-range-icon-end">
                                    <i class="bi bi-calendar"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ê¸‰ì—¬ëª©ë¡ -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">ê¸‰ì—¬ëª©ë¡</h5>
                <div class="card-header-right">
                    <button class="btn btn-outline-dark" id="openSalyRegistModal">ë“±ë¡</button>
                </div>
            </div>
            <div class="card-body">
                <div id="grid" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- ë“±ë¡ ëª¨ë‹¬ (ì•ˆì— grid2 ìˆìŒ) -->
<div th:replace="insa/modal/salyRegistModal :: salyRegistModal"></div>

<script>
    /***********************
     * 1. ë©”ì¸ ê·¸ë¦¬ë“œ ë°ì´í„°
     ***********************/
    const gridData = [
        {
            revsMmdd: "2025.07",
            payDt: "2025.08.15",
            salyLedgNm: "ì¸ì‚¬ 7ì›” ê¸‰ì—¬ëŒ€ì¥",
            deptNm: "ì¸ì‚¬",
            rcnt: 2.00,
            status: "BEFORE_CONFIRM",
            ttPayAmt: 133830.00
        },
        {
            revsMmdd: "2025.07",
            payDt: "2025.08.15",
            salyLedgNm: "ìƒì‚° 7ì›” ê¸‰ì—¬ëŒ€ì¥",
            deptNm: "ìƒì‚°",
            rcnt: 30.00,
            status: "CONFIRMED",
            ttPayAmt: 123133830.00
        },
        {
            revsMmdd: "2025.05",
            payDt: "2025.06.15",
            salyLedgNm: "ì´ë¬´ 5ì›” ê¸‰ì—¬ëŒ€ì¥",
            deptNm: "ì´ë¬´",
            rcnt: 15.00,
            status: "PAID",
            ttPayAmt: 43133830.00
        }
    ];

    /***************************
     * 2. ë©”ì¸ ê¸‰ì—¬ëŒ€ì¥ TUI Grid
     ***************************/
    const grid = new tui.Grid({
        el: document.getElementById("grid"),
        data: gridData,
        bodyHeight: 320,     // ğŸ”¥ ê·¸ë¦¬ë“œ ì•ˆì—ì„œë§Œ ìŠ¤í¬ë¡¤, 320px ê³ ì •
        scrollX: false,
        scrollY: true,
        rowHeaders: [],      // ğŸ”¥ ì²´í¬ë°•ìŠ¤ ì™„ì „ ì œê±°
        columns: [
            { header: "ê·€ì†ì—°ì›”",     name: "revsMmdd",  align: "center" },
            { header: "ì§€ê¸‰ì¼",       name: "payDt",     align: "center" },
            { header: "ê¸‰ì—¬ëŒ€ì¥ëª…ì¹­", name: "salyLedgNm" },
            { header: "ë¶€ì„œëª…",       name: "deptNm" },
            { header: "ì¸ì›ìˆ˜",       name: "rcnt",      align: "right" },

            {
                header: "ì‚¬ì „ì‘ì—…",
                name: "preWork",
                align: "center",
                formatter: ({ row }) => {
                    const label = (row.status === "BEFORE_CONFIRM")
                        ? "ê¸‰ì—¬ê³„ì‚°"
                        : "ê¸‰ì—¬ê³„ì‚°ì¡°íšŒ";
                    return `<button class="grid-btn btn-prework" data-action="prework">${label}</button>`;
                }
            },

            {
                header: "ê¸‰ì—¬ëŒ€ì¥",
                name: "salyLedg",
                align: "center",
                formatter: ({ row }) => {
                    let buttons = [];

                    if (row.status === "BEFORE_CONFIRM") {
                        buttons.push(`<button class="grid-btn btn-saly" data-action="view">ê¸‰ì—¬ëŒ€ì¥ ì¡°íšŒ</button>`);
                        buttons.push(`<button class="grid-btn btn-saly" data-action="edit">ê¸‰ì—¬ëŒ€ì¥ ìˆ˜ì •</button>`);
                        buttons.push(`<button class="grid-btn btn-saly" data-action="delete">ê¸‰ì—¬ëŒ€ì¥ ì‚­ì œ</button>`);
                        buttons.push(`<button class="grid-btn btn-saly" data-action="confirm">ê¸‰ì—¬ëŒ€ì¥ í™•ì •</button>`);
                    } else if (row.status === "CONFIRMED") {
                        buttons.push(`<button class="grid-btn btn-saly" data-action="view">ê¸‰ì—¬ëŒ€ì¥ ì¡°íšŒ</button>`);
                        buttons.push(`<button class="grid-btn btn-saly" data-action="cancel-confirm">ê¸‰ì—¬ëŒ€ì¥ í™•ì •ì·¨ì†Œ</button>`);
                    } else if (row.status === "PAID") {
                        buttons.push(`<button class="grid-btn btn-saly" data-action="view">ê¸‰ì—¬ëŒ€ì¥ ì¡°íšŒ</button>`);
                    }

                    return `<div class="grid-btn-group">${buttons.join("")}</div>`;
                }
            },

            {
                header: "ì§€ê¸‰ì´ì•¡",
                name: "ttPayAmt",
                align: "right",
                formatter: ({ value }) => {
                    if (value == null || value === "") return "";
                    return Number(value).toLocaleString("ko-KR", {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                }
            },

            {
                header: "ëª…ì„¸ì„œ",
                name: "salySpec",
                align: "center",
                formatter: () =>
                    `<button class="grid-btn btn-spec" data-action="spec">ëª…ì„¸ì„œ ì¡°íšŒ</button>`
            }
        ]
    });

    /************************
     * 3. ìƒíƒœ ë³€ê²½ ê´€ë ¨ í•¨ìˆ˜
     ************************/
    function setSalyStatus(rowKey, status) {
        grid.setValue(rowKey, "status", status, false);
        grid.refreshLayout();  // ì—¬ê¸°ì„œë§Œ ë ˆì´ì•„ì›ƒ ê°±ì‹ 
    }

    function confirmSaly(rowKey) {
        setSalyStatus(rowKey, "CONFIRMED");
    }

    function cancelConfirm(rowKey) {
        setSalyStatus(rowKey, "BEFORE_CONFIRM");
    }

    function completePay(rowKey) {
        setSalyStatus(rowKey, "PAID");
    }

    function autoUpdatePaidStatus() {
        const today = new Date();

        grid.getData().forEach(row => {
            const raw = row.payDt;
            if (!raw) return;
            const payStr  = raw.replace(/\./g, "-");
            const payDate = new Date(payStr);

            if (row.status === "CONFIRMED" && !isNaN(payDate) && payDate <= today) {
                grid.setValue(row.rowKey, "status", "PAID", false);
            }
        });

        grid.refreshLayout();
    }

    document.getElementById("btnSearch")?.addEventListener("click", () => {
        autoUpdatePaidStatus();
    });

    /*************************
     * 4. ë©”ì¸ ê·¸ë¦¬ë“œ ë²„íŠ¼ í´ë¦­
     *************************/
    grid.on("click", ev => {
        if (ev.rowKey === null || ev.rowKey === undefined) return;
        const row = grid.getRow(ev.rowKey);
        if (!row) return;

        const target = ev.target;
        if (!(target instanceof HTMLElement)) return;

        const action = target.dataset.action;
        if (!action) return;

        console.log("clicked action:", action, "row:", row);

        if (action === "confirm") {
            confirmSaly(ev.rowKey);
        } else if (action === "cancel-confirm") {
            cancelConfirm(ev.rowKey);
        } else if (action === "prework") {
            // ê¸‰ì—¬ê³„ì‚° / ê¸‰ì—¬ê³„ì‚°ì¡°íšŒ
        } else if (action === "view") {
            // ê¸‰ì—¬ëŒ€ì¥ ì¡°íšŒ
        } else if (action === "edit") {
            // ê¸‰ì—¬ëŒ€ì¥ ìˆ˜ì •
        } else if (action === "delete") {
            // ê¸‰ì—¬ëŒ€ì¥ ì‚­ì œ
        } else if (action === "spec") {
            // ëª…ì„¸ì„œ ì¡°íšŒ
        }
    });

    /***********************
     * 5. ëª¨ë‹¬ ì•ˆ grid2
     ***********************/
    const gridData2 = [
        { empId: "EMP001", nm: "ê¹€ì² ìˆ˜", emplymTy: "ì •ê·œì§", deptNm: "ê°œë°œíŒ€" },
        { empId: "EMP002", nm: "ì´ì˜í¬", emplymTy: "ì •ê·œì§", deptNm: "ì¸ì‚¬íŒ€" },
        { empId: "EMP003", nm: "ë°•ë¯¼ìˆ˜", emplymTy: "ê³„ì•½ì§", deptNm: "ì˜ì—…íŒ€" },
        { empId: "EMP004", nm: "ìµœì§€ì—°", emplymTy: "ì •ê·œì§", deptNm: "ì´ë¬´íŒ€" },
        { empId: "EMP005", nm: "ì •ìš°ì„±", emplymTy: "ì•Œë°”",   deptNm: "ë¬¼ë¥˜íŒ€" },
        { empId: "EMP006", nm: "í•œì§€ë¯¼", emplymTy: "ì •ê·œì§", deptNm: "ì¬ë¬´íŒ€" },
        { empId: "EMP007", nm: "ì˜¤ìƒì§„", emplymTy: "ê³„ì•½ì§", deptNm: "ê°œë°œíŒ€" },
        { empId: "EMP008", nm: "ìœ ì†Œë¼", emplymTy: "ì •ê·œì§", deptNm: "ë§ˆì¼€íŒ…íŒ€" }
    ];

    const grid2 = new tui.Grid({
        el: document.getElementById("grid2"),
        data: gridData2,
        bodyHeight: 320,
        scrollX: false,
        scrollY: true,
        rowHeaders: [],
        columns: [
            { header: "ì‚¬ì›ë²ˆí˜¸", name: "empId" },
            { header: "ì‚¬ì›ëª…",   name: "nm" },
            { header: "ê³ ìš©í˜•íƒœ", name: "emplymTy" },
            { header: "ë¶€ì„œëª…",   name: "deptNm" }
        ]
    });

    /***********************
     * 6. ëª¨ë‹¬ ì—´ê¸°
     ***********************/
    const openBtn = document.getElementById("openSalyRegistModal");
    const modal   = document.getElementById("salyRegistModal");
    const back    = document.getElementById("salyRegistBackdrop");

    function openModal() {
        if (!modal || !back) return;
        modal.classList.add("show");
        modal.style.display = "block";
        back.style.display = "block";
        grid2.refreshLayout();
    }

    if (openBtn) {
        openBtn.addEventListener("click", openModal);
    }

    /***********************
     * 7. revs_ym / payDt ì—°ë™ (ê¸°ì¡´)
     ***********************/
    $(function () {
        const $revsYm = $("#revs_ym");
        const $payDt  = $("#payDt");

        if (!$revsYm.length || !$payDt.length) return;

        const $ymGroup = $revsYm.closest(".js-ym-single");
        const $ymIcon  = $ymGroup.find(".js-ym-icon");

        if ($ymIcon.length) {
            $ymIcon.on("click", function () {
                $revsYm.focus();
            });
        }

        $revsYm
            .datepicker({
                format: "yyyy-mm",
                autoclose: true,
                minViewMode: 1,
                language: "ko"
            })
            .on("show", function () {
                const $self  = $(this);
                const $modal = $self.closest(".modal");
                if (!$modal.length) return;

                const modalZ = parseInt($modal.css("z-index"), 10) || 1055;
                setTimeout(function () {
                    $(".datepicker-dropdown").each(function () {
                        this.style.setProperty("z-index", String(modalZ + 10), "important");
                    });
                }, 0);
            });

        function ymToFirstDay(ym) {
            if (!ym) return null;
            const m = /^(\d{4})-(\d{2})$/.exec(ym);
            if (!m) return null;
            const y  = parseInt(m[1], 10);
            const mo = parseInt(m[2], 10) - 1;
            const d  = new Date(y, mo, 1);
            if (d.getFullYear() !== y || d.getMonth() !== mo) return null;
            return d;
        }

        function dateToYm(date) {
            if (!date) return "";
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, "0");
            return y + "-" + m;
        }

        function hasDatepicker($el) {
            return !!$el.data("datepicker");
        }

        function syncFromRevsYm() {
            if (!hasDatepicker($payDt)) return;

            const ymStr = $revsYm.val().trim();
            if (!ymStr) {
                $payDt.datepicker("setStartDate", null);
                return;
            }

            const startDate = ymToFirstDay(ymStr);
            if (!startDate) {
                $payDt.datepicker("setStartDate", null);
                return;
            }

            $payDt.datepicker("setStartDate", startDate);

            const curPay = $payDt.datepicker("getDate");
            if (curPay && curPay < startDate) {
                $payDt.datepicker("setDate", startDate);
            }
        }

        function syncFromPayDt() {
            if (!hasDatepicker($revsYm)) return;

            const payDate = $payDt.datepicker("getDate");
            if (!payDate) {
                $revsYm.datepicker("setEndDate", null);
                return;
            }

            const maxYmDate = new Date(payDate.getFullYear(), payDate.getMonth(), 1);
            $revsYm.datepicker("setEndDate", maxYmDate);

            const curYmStr  = $revsYm.val().trim();
            const curYmDate = ymToFirstDay(curYmStr);

            if (curYmDate && curYmDate > maxYmDate) {
                $revsYm.datepicker("setDate", maxYmDate);
                $revsYm.val(dateToYm(maxYmDate));
            }
        }

        $revsYm.on("changeDate", function () {
            syncFromRevsYm();
        });
        $revsYm.on("blur", function () {
            syncFromRevsYm();
        });

        $payDt.on("changeDate", function () {
            syncFromPayDt();
        });
        $payDt.on("blur", function () {
            syncFromPayDt();
        });
    });
</script>
</body>
</html>
	