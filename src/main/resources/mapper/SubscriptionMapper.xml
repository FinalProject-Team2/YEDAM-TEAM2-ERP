<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="store.yd2team.common.mapper.SubscriptionMapper">
	<!-- Insert subscription plan -->
	<insert id="insertPlan" parameterType="store.yd2team.common.service.subscriptionPlanVO">
		INSERT INTO tb_subsp_plan
		(
			subsp_plan_id,
			plan_nm,
			acct_issu_cnt,
			api_issu_cnt,
			amt,
			sttl_perd,
			applc_dt,
			yn
		)
		VALUES
		(
			#{subspPlanId},
			#{planNm},
			#{acctIssuCnt},
			#{apiIssuCnt},
			#{amt},
			#{sttlPerd},
			#{applcDt},
			#{yn}
		)
	</insert>
	
	<!-- Update subscription plan -->
	<update id="updatePlan" parameterType="store.yd2team.common.service.subscriptionPlanVO">
		UPDATE tb_subsp_plan
		SET
			plan_nm = #{planNm},
			acct_issu_cnt = #{acctIssuCnt},
			api_issu_cnt = #{apiIssuCnt},
			amt = #{amt},
			sttl_perd = #{sttlPerd},
			applc_dt = NVL(#{applcDt}, applc_dt),
			yn = #{yn},
			updt_dt = SYSDATE
		WHERE
			subsp_plan_id = #{subspPlanId}
	</update>
	
	<!-- Get max sequence for current year-month prefix, e.g. 'plan202511' -->
	<select id="getMaxPlanSeqOfMonth" parameterType="string" resultType="string">
		SELECT MAX(SUBSTR(subsp_plan_id, LENGTH(#{prefix}) + 1))
		FROM tb_subsp_plan
		WHERE subsp_plan_id LIKE CONCAT(#{prefix}, '%')
	</select>
	
	<!-- Select list of subscription plans -->
	<select id="selectSubscriptionPlans" resultType="store.yd2team.common.service.subscriptionPlanVO">
		SELECT
			subsp_plan_id AS subspPlanId,
			plan_nm AS planNm,
			acct_issu_cnt AS acctIssuCnt,
			api_issu_cnt AS apiIssuCnt,
			amt,
			sttl_perd AS sttlPerd,
			applc_dt AS applcDt,
			yn,
			crea_dt AS creaDt,
			crea_by AS creaBy,
			updt_dt AS updtDt,
			updt_by AS updtBy
		FROM tb_subsp_plan
		ORDER BY subsp_plan_id DESC
	</select>
	
	<!-- 결제용: 플랜명 + 결제주기로 단일 플랜 조회 (Oracle 호환) -->
	<select id="selectPlanForPayment" resultType="store.yd2team.common.service.subscriptionPlanVO">
		SELECT *
		FROM (
			SELECT
				subsp_plan_id AS subspPlanId,
				plan_nm       AS planNm,
				acct_issu_cnt AS acctIssuCnt,
				api_issu_cnt  AS apiIssuCnt,
				amt,
				sttl_perd     AS sttlPerd,
				applc_dt      AS applcDt,
				yn,
				crea_dt       AS creaDt,
				crea_by       AS creaBy,
				updt_dt       AS updtDt,
				updt_by       AS updtBy
			FROM tb_subsp_plan
			WHERE plan_nm = #{planNm}
			  AND (
					(#{sttlPerd} = 'MONTHLY' AND (sttl_perd = 'b1' OR sttl_perd = '월'))
				 OR (#{sttlPerd} = 'YEARLY'  AND (sttl_perd = 'b2' OR sttl_perd = '연'))
			  )
			ORDER BY applc_dt DESC
		)
		WHERE ROWNUM = 1
	</select>
	
	<!-- vendId(PK)로 tb_vend에서 상호명(vend_nm) 조회 -->
	<select id="selectVendNameById" parameterType="string" resultType="string">
		SELECT vend_nm
		FROM tb_vend
		WHERE vend_id = #{vendId}
	</select>

	<!-- 로그인 사용자의 vendId 기준 현재 구독 + 사용량 조회 -->
	<select id="selectSubscriptionUsageByVendId" parameterType="string" resultType="store.yd2team.common.dto.SubscriptionUsageDto">
		SELECT
			p.plan_nm        AS planNm,
			p.crea_dt        AS creaDt,
			p.sttl_perd      AS sttlPerd,
			p.acct_issu_cnt  AS acctIssuCnt,
			p.api_issu_cnt   AS apiIssuCnt,
			s.acct_use_cnt   AS acctUseCnt,
			s.api_use_cnt    AS apiUseCnt
		FROM tb_subsp s
		JOIN tb_subsp_plan p
		  ON s.subsp_plan_id = p.subsp_plan_id
		WHERE s.vend_id = #{vendId}
	</select>
	
</mapper>