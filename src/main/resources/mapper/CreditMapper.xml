<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="store.yd2team.business.mapper.CreditMapper">
<!-- 신규견적서 모달 고객사 auto complete -->
	<!-- 고객코드 검색 -->
  <select id="searchCustcomId" parameterType="string" resultType="store.yd2team.business.service.CreditVO">
	    SELECT
	        custcom_id AS custcomId,
	        custcom_name AS custcomName,
	        vend_id AS vendId
	    FROM tb_custcom
	    WHERE custcom_id LIKE '%' || #{keyword} || '%'
	    ORDER BY custcom_id
	</select>
  <!-- 고객사명 검색 -->
  <select id="searchCustcomName" parameterType="string" resultType="store.yd2team.business.service.CreditVO">
	    SELECT
	        custcom_id AS custcomId,
	        custcom_name AS custcomName,
	        vend_id AS vendId
	    FROM tb_custcom
	    WHERE custcom_name LIKE '%' || #{keyword} || '%'
	    ORDER BY custcom_name
	</select>
	
<!-- 여신한도 목록 조회 -->
<select id="searchCredit"
       parameterType="store.yd2team.business.service.CreditVO"
       resultType="store.yd2team.business.service.CreditVO">
   SELECT
       cdt.cdtln_no,
       cdt.custcom_id,
       cust.custcom_name,
       cdt.credit_grad,
       cdt.cdtln_check,
       cdt.mrtgg_lmt,
       cdt.credit_lmt,
       cdt.cdtln_lmt,
       cdt.lmtover_check,
       cdt.yn,
       cdt.applc_begin_dt,
       cdt.applc_end_dt,
       /* 필요하면 설계해서 추가할 컬럼들 (없으면 빼고 사용) */
       cdt.credit_mm,
       cdt.bad_credit_yn,
       cdt.ship_hold_yn,
       NVL(cdt.turnover_days, 0) AS turnover_days,
       /* 미수/연체 현황 */
       NVL(r.remain_amt, 0)     AS remain_amt,
       NVL(r.max_overdue_mm, 0) AS max_overdue_mm
   FROM tb_cdtln_lmt cdt
   LEFT JOIN tb_custcom cust
          ON cdt.custcom_id = cust.custcom_id
   /* tb_atmpt + tb_atmpt_detail 집계 서브쿼리 */
   LEFT JOIN (
       SELECT
           a.custcom_id,
           SUM(NVL(a.atmpt_blce, 0)) AS remain_amt,
           MAX(
               CASE
                   WHEN d.rpay_at IS NULL
                    AND d.recpt_expc_dt IS NOT NULL
                    AND d.recpt_expc_dt <![CDATA[ < ]]> TRUNC(SYSDATE)
                   THEN TRUNC( (TRUNC(SYSDATE) - d.recpt_expc_dt) / 30 )
                   ELSE 0
               END
           ) AS MAX_OVERDUE_MM
       FROM tb_atmpt a
       LEFT JOIN tb_atmpt_detail d
              ON a.CUSTCOM_ID = d.CUSTCOM_ID
       GROUP BY a.CUSTCOM_ID
   ) r
     ON cdt.CUSTCOM_ID = r.CUSTCOM_ID
   WHERE 1 = 1
   <if test="custcomId != null and custcomId != ''">
       AND cdt.CUSTCOM_ID = #{custcomId}
   </if>
   <if test="custcomName != null and custcomName != ''">
       AND cust.CUSTCOM_NAME LIKE '%' || #{custcomName} || '%'
   </if>
   ORDER BY cdt.CUSTCOM_ID
</select>
	
<!-- 업체정보 모달창 -->	
	 <select id="selectCustcomDetail"
           parameterType="string"
           resultType="store.yd2team.business.service.CustcomVO">
       SELECT
           custcom_id,
           biz_addr,
           biz_tel,
           biz_fax,
           psch,
           psch_tel,
           psch_email
       FROM tb_custcom
       WHERE custcom_id = #{custcomId}
   </select>
</mapper>