<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="store.yd2team.common.mapper.EmpLoginMapper">
	
    <select id="selectByLogin">
        SELECT  a.emp_acct_id,
                a.vend_id,
                a.emp_id,
                a.login_id,
                a.login_pwd,
                a.st,
                a.fail_cnt,
                a.lock_dttm,
                a.last_login,
                a.yn,
                a.crea_dt,
                a.crea_by,
                a.updt_dt,
                a.updt_by,
                a.temp_yn,
                a.mas_yn,
                e.nm        AS empNm,
                e.dept_id   AS deptId,
                d.dept_nm   AS deptNm,
                v.bizcnd,    
                v.addr,  
                e.cttpc,
                v.hp     
        FROM TB_EMP_ACCT a
        LEFT JOIN TB_EMP e
               ON a.EMP_ID = e.EMP_ID
              AND a.VEND_ID = e.VEND_ID
        LEFT JOIN TB_DEPT d
               ON e.DEPT_ID = d.DEPT_ID
              AND e.VEND_ID = d.VEND_ID
        LEFT JOIN TB_VEND v
               ON a.VEND_ID = v.VEND_ID
        WHERE a.VEND_ID  = #{vendId}
        AND a.LOGIN_ID = #{loginId}
        AND a.YN = 'e1'
    </select>
    
    <update id="updateLoginSuccess">
        UPDATE tb_emp_acct
           SET fail_cnt   = 0,
               last_login = SYSDATE,
               updt_dt    = SYSDATE,
               updt_by    = #{updtBy}
         WHERE emp_acct_id = #{empAcctId}
    </update>

    <update id="updateLoginFail">
        UPDATE tb_emp_acct
           SET fail_cnt = fail_cnt + 1,
               st       = CASE
                            WHEN fail_cnt + 1 >= #{maxFailCnt}
                            THEN 'r2'
                            ELSE st
                          END,
               lock_dttm = CASE
                             WHEN fail_cnt + 1 >= #{maxFailCnt}
                             THEN SYSDATE
                             ELSE lock_dttm
                           END,
               updt_dt   = SYSDATE,
               updt_by   = #{updtBy}
         WHERE emp_acct_id = #{empAcctId}
    </update>

    <update id="unlock">
        UPDATE tb_emp_acct
           SET st        = 'r1',
               fail_cnt  = 0,
               lock_dttm = NULL,
               updt_dt   = SYSDATE,
               updt_by   = #{updtBy}
         WHERE emp_acct_id = #{empAcctId}
    </update>
    	
</mapper>