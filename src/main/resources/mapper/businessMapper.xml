<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="store.yd2team.business.mapper.BusinessMapper">
	<!-- 휴면,이탈 기준조회 -->
	<select id="getChurnStdrList" parameterType="store.yd2team.business.service.ChurnStdrVO">
		SELECT 
		    churn_risk_id 		as churnRiskId,
		    cust_aggregate_no	as custAggregateNo,
		    vend_id 			as vendId,
		    TRIM(sales_change)	as salesChange,
		    ty					as TY,			
		    stdr_value			as stdrValue,
		    stdr_dc				as stdrDc,
		    yn					as YN,
		    crea_dt				as creaDt,
		    crea_by				as creaBy,
		    updt_dt				as updtDt,
		    updt_by				as updtBy
		FROM  
   			tb_churn_risk_stdr
   		ORDER BY CHURN_RISK_ID
	</select>
	
	<update id="updateChurnStdr" parameterType="store.yd2team.business.service.ChurnStdrVO">
	    UPDATE tb_churn_risk_stdr
	    SET
	        stdr_value = #{stdrValue},
	        stdr_dc    = #{stdrDc},
	        yn         = #{yn}
	    WHERE
	        churn_risk_id = #{churnRiskId}
	</update>
	
	<!-- 휴면,이탈고객 검색조회 -->
	<select id="getchurnRiskList" parameterType="store.yd2team.business.service.churnRiskVO">
	SELECT
		cust_aggregate_no as custAggregateNo,
		vend_id           as vendId,
		purc_stop_dt      as purcStopDt,
		avg_purc_cycle    as avgPurcCycle,
		sales_change      as salesChange,
		churn_risk_score  as churnRiskScore
	FROM
		tb_cust_aggregate
	 WHERE 1 = 1
	    <if test="custAggregateNo != null and custAggregateNo != ''">
	         AND salesChange &gt;= TO_DATE(#{salesChange}, 'YYYY-MM-DD')
	    </if>
	    <if test="vendId != null and vendId != ''">
	        AND vendId LIKE '%' || #{vendId} || '%'
	    </if>
	    <if test="avgPurcCycle != null and avgPurcCycle != ''">
	        AND avgPurcCycle LIKE '%' || #{avgPurcCycle} || '%'
	    </if>
	    <if test="salesChange != null and salesChange != ''">
	         AND salesChange LIKE '%' || #{salesChange} || '%'
	    </if>
	    <if test="churnRiskScore != null and churnRiskScore != ''">
	        AND churnRiskScore LIKE '%' || #{churnRiskScore} || '%'
	    </if>
	</select>
		
	<!-- 휴면, 이탈 조건별 점수화 -->
	<select id="getMonthlySalesChange"
      resultType="store.yd2team.business.service.MonthlySalesDTO">
			WITH MONTHLY_SALES AS (
			   SELECT
			       a.CUSTcom_ID CUSTOMER_ID,
			       TRUNC(a.SALE_DATE, 'MM') AS MONTH,
			       SUM(d.supply_price) AS TOTAL_AMOUNT
			   FROM tb_SALE a
			   JOIN tb_sale_detail d ON a.sale_slip_no = d.sale_slip_no
			   GROUP BY a.CUSTcom_ID, TRUNC(a.SALE_DATE, 'MM')
			),
			LATEST_6 AS (
			   SELECT CUSTOMER_ID, SUM(TOTAL_AMOUNT) AS AMT_6
			   FROM MONTHLY_SALES
			   WHERE MONTH &gt;= ADD_MONTHS(TRUNC(SYSDATE, 'MM'), -5)
			   GROUP BY CUSTOMER_ID
			),
			PREV_6 AS (
			   SELECT CUSTOMER_ID, SUM(TOTAL_AMOUNT) AS AMT_PREV_6
			   FROM MONTHLY_SALES
			   WHERE MONTH &lt; ADD_MONTHS(TRUNC(SYSDATE, 'MM'), -5)
			     AND MONTH &gt;= ADD_MONTHS(TRUNC(SYSDATE, 'MM'), -11)
			   GROUP BY CUSTOMER_ID
			),
			TREND AS (
			   SELECT
			       a.CUSTOMER_ID,
			       CASE
			           WHEN b.AMT_PREV_6 = 0 THEN 100
			           ELSE ((a.AMT_6 - b.AMT_PREV_6) / b.AMT_PREV_6) * 100
			       END AS GROWTH_RATE
			   FROM LATEST_6 a
			   LEFT JOIN PREV_6 b ON a.CUSTOMER_ID = b.CUSTOMER_ID
			),
			TREND_SCORE AS (
			   SELECT
			       CUSTOMER_ID,
			       CASE
			           WHEN GROWTH_RATE &gt;= 20 THEN 100
			           WHEN GROWTH_RATE BETWEEN 5 AND 19 THEN 80
			           WHEN GROWTH_RATE BETWEEN -5 AND 4 THEN 60
			           WHEN GROWTH_RATE BETWEEN -20 AND -6 THEN 40
			           ELSE 20
			       END AS TREND_SCORE
			   FROM TREND
			),
			LAST_PURCHASE AS (
			   SELECT
			       CUSTCOM_ID CUSTOMER_ID,
			       MAX(SALE_DATE) AS LAST_DATE,
			       TRUNC(SYSDATE - MAX(SALE_DATE)) AS DAYS_SINCE
			   FROM tb_sale
			   GROUP BY CUSTCOM_ID
			),
			RECENCY_SCORE AS (
			   SELECT
			       CUSTOMER_ID,
			       CASE
			           WHEN DAYS_SINCE &lt;= 30 THEN 100
			           WHEN DAYS_SINCE &lt;= 60 THEN 80
			           WHEN DAYS_SINCE &lt;= 90 THEN 60
			           WHEN DAYS_SINCE &lt;= 180 THEN 30
			           ELSE 10
			       END AS REC_SCORE
			   FROM LAST_PURCHASE
			),
			FREQ AS (
			   SELECT
			       CUSTCOM_ID CUSTOMER_ID,
			       SUM(CASE WHEN SALE_DATE &gt;= ADD_MONTHS(SYSDATE, -3) THEN 1 END) AS FREQ_3,
			       SUM(CASE WHEN SALE_DATE &gt;= ADD_MONTHS(SYSDATE, -12) THEN 1 END) AS FREQ_12
			   FROM TB_SALE
			   GROUP BY CUSTCOM_ID
			),
			FREQ_SCORE AS (
			   SELECT
			       CUSTOMER_ID,
			       CASE
			           WHEN FREQ_12 = 0 THEN 20
			           WHEN (FREQ_3 / (FREQ_12/12*3)) &gt;= 1.5 THEN 90
			           WHEN (FREQ_3 / (FREQ_12/12*3)) &gt;= 0.8 THEN 60
			           ELSE 30
			       END AS FREQ_SCORE
			   FROM FREQ
			)
			SELECT
			   t.CUSTOMER_ID AS customerId,
			   t.TREND_SCORE AS trendScore,
			   r.REC_SCORE  AS recScore,
			   f.FREQ_SCORE AS freqScore,
			   (t.TREND_SCORE * 0.4) + (r.REC_SCORE * 0.4) + (f.FREQ_SCORE * 0.2) AS finalScore,
			   CASE
			       WHEN (t.TREND_SCORE * 0.4 + r.REC_SCORE * 0.4 + f.FREQ_SCORE * 0.2) &gt;= 80 THEN '이탈위험 고객'
			       WHEN (t.TREND_SCORE * 0.4 + r.REC_SCORE * 0.4 + f.FREQ_SCORE * 0.2) &gt;= 60 THEN '주의 고객'
			       WHEN (t.TREND_SCORE * 0.4 + r.REC_SCORE * 0.4 + f.FREQ_SCORE * 0.2) &gt;= 40 THEN '휴먼 고객'
			       ELSE '정상 고객'
			   END AS customerStatus
			FROM TREND_SCORE t
			JOIN RECENCY_SCORE r ON t.CUSTOMER_ID = r.CUSTOMER_ID
			JOIN FREQ_SCORE    f ON t.CUSTOMER_ID = f.CUSTOMER_ID
			WHERE 1 = 1
			   <!-- 업체명(고객ID) -->
			   <if test="customerId != null and customerId != ''">
			       AND t.CUSTOMER_ID LIKE '%' || #{customerId} || '%'
			   </if>
			   <!-- 휴면/이탈 상태 -->
			<if test="customerStatus != null and customerStatus != ''">
			   AND (
			       CASE
			           WHEN (t.TREND_SCORE * 0.4 + r.REC_SCORE * 0.4 + f.FREQ_SCORE * 0.2) >= 80 THEN '이탈위험 고객'
			           WHEN (t.TREND_SCORE * 0.4 + r.REC_SCORE * 0.4 + f.FREQ_SCORE * 0.2) >= 60 THEN '주의 고객'
			           WHEN (t.TREND_SCORE * 0.4 + r.REC_SCORE * 0.4 + f.FREQ_SCORE * 0.2) >= 40 THEN '휴먼 고객'
			           ELSE '정상 고객'
			       END
			       LIKE '%' || #{customerStatus} || '%'
			   )
			</if>
			   <!-- 점수 하한 -->
			   <if test="trendScore != null">
			       AND t.TREND_SCORE &gt;= #{trendScore}
			   </if>
			   <if test="recScore != null">
			       AND r.REC_SCORE &gt;= #{recScore}
			   </if>
			   <if test="freqScore != null">
			       AND f.FREQ_SCORE &gt;= #{freqScore}
			   </if>
			   <if test="finalScore != null">
			       AND (t.TREND_SCORE * 0.4 + r.REC_SCORE * 0.4 + f.FREQ_SCORE * 0.2) &gt;= #{finalScore}
			   </if>
			ORDER BY finalScore DESC
</select>
<!-- 잠재고객 전체조회 -->
  <select id="getList" resultType="store.yd2team.business.service.BusinessVO">
      SELECT
	            potential_info_no  as potentialInfoNo,
	            potential_cond_no  as potentialCondNo,
	            vend_id            as vendId,
	            rank               as rank,
	            vend_nm            as vendNm,
	            industry_type      as industryType,
	            company_size       as companySize,
	            region             as region,
	             establish_date AS establishDate
      FROM 	tb_potential_cust_list
     ORDER BY potential_info_no desc
  </select>
 
 	<!-- 잠재고객 기준상세목록 조회 -->
	<select id="getPotentialStdrDetailList"
				parameterType="store.yd2team.business.service.PotentialStdrVO"
				resultType="store.yd2team.business.service.PotentialStdrVO">
		SELECT
		        STDR_DETAIL_ID   AS stdrDetailId,
		        STDR_ID          AS stdrId,
		        VEND_ID          AS vendId,
		        STDR_ITEAM_INFO  AS stdrIteamInfo,
		        INFO_SCORE       AS infoScore
	    FROM 	TB_POTENTIAL_STDR_DETAIL
	    ORDER BY STDR_ID, STDR_DETAIL_ID
	</select>
	
	<!-- 잠재고객 조건상세목록 등록 -->
	<insert id="insertPotentialStdrDetail" parameterType="store.yd2team.business.service.PotentialStdrVO">
				  INSERT INTO TB_POTENTIAL_STDR_DETAIL (
		              STDR_DETAIL_ID
		            , STDR_ID
		            , STDR_ITEAM_INFO
		            , INFO_SCORE
		        ) VALUES (
		              #{stdrDetailId}    <!-- 실제 시퀀스명에 맞게 수정 -->
		            , #{stdrId}
		            , #{stdrIteamInfo}
		            , #{infoScore}
		        )
	</insert>
	<!-- 잠재고객조건 상세목록 수정 -->
	<update id="updatePotentialStdrDetail"  parameterType="store.yd2team.business.service.PotentialStdrVO">
	  UPDATE TB_POTENTIAL_STDR_DETAIL
        SET
        	 STDR_ITEAM_INFO = #{stdrIteamInfo},
            INFO_SCORE     = #{infoScore}
      WHERE STDR_DETAIL_ID  = #{stdrDetailId}
	</update>
	<!-- 잠재고객 기준상세목록 삭제 -->
	<delete id="deletePotentialStdr" parameterType="store.yd2team.business.service.PotentialStdrVO">
	    DELETE FROM TB_POTENTIAL_STDR_DETAIL
	    WHERE STDR_DETAIL_ID = #{stdrDetailId}
	</delete>
	
	<!-- 공공데이터 insert -->
	<insert id="insertPotential" parameterType="store.yd2team.business.service.BusinessVO">
	    INSERT INTO TB_POTENTIAL_CUST_LIST (
	        potential_info_no,
	        potential_cond_no,
	        vend_id,
	        rank,
	        vend_nm,
	        industry_type,
	        company_size,
	        region,
	        establish_date
	    ) VALUES (
	        #{potentialInfoNo},
	        seq_potential_cond_no.nextval,   <!-- ★ 여기 수정 -->
	       'CUST' || LPAD(seq_vend_id.NEXTVAL, 3, '0'),
	        seq_rank.nextval,
	        #{vendNm},
	        #{industryType},
	        #{companySize},
	        #{region},
	        to_date(#{establishDate}, 'yyyy-mm-dd')
	    )
	</insert>
	  
  <!-- 공공데이터 고객 건수 카운트 -->
  <select id="existsPotentialInfoNo">
	    SELECT COUNT(*)
	    FROM tb_potential_cust_list
	    WHERE potential_info_no = #{potentialInfoNo}
  </select>
 
  <!-- 잠재고객검색조회 -->
  <select id="getBusinessList" parameterType="store.yd2team.business.service.BusinessVO">
  	SELECT
	        potential_info_no,
	        potential_cond_no,
	        vend_id,
	        rank,
	        vend_nm,
	        industry_type,
	        company_size,
	        region,
	        establish_date,
	        crea_dt,
	        crea_by,
	        updt_dt,
	        updt_by
	FROM
    	  	tb_potential_cust_list
  WHERE 1 = 1
	    <if test="industryType != null and industryType != ''">
	        AND industry_type LIKE '%' || #{industryType} || '%'
	    </if>
	    <if test="companySize != null and companySize != ''">
	        AND company_size LIKE '%' || #{companySize} || '%'
	    </if>
	    <if test="region != null and region != ''">
	        AND region 			LIKE '%' || #{region} || '%'
	    </if>
	    <if test="startEstablishDate != null and startEstablishDate != ''">
	        AND establish_date &gt;= TO_DATE(#{startEstablishDate}, 'YYYY-MM-DD')
	    </if>
	    <if test="endEstablishDate != null and endEstablishDate != ''">
	        AND establish_date &lt;= TO_DATE(#{endEstablishDate}, 'YYYY-MM-DD')
	    </if>
  ORDER BY rank
	</select>
	
	
	<!-- 접촉사항조회-->
	<select id="getAction" parameterType="store.yd2team.business.service.ContactVO">
			SELECT  contact_no contactNo,
			        potential_info_no potentialInfoNo,
			        vend_id vendId,
			        contact_dt contactDt,
			        contact_manager contactManager,
			        contact_way contactWay,
			        contact_cntn contactCntn
			FROM    tb_contact
	</select>
	
	<!-- 리드분석조회 -->
	<select id="getLeadGenerar" parameterType="store.yd2team.business.service.ContactVO">
			SELECT  LEAD_NO,
			        VEND_ID,
			        LEAD_DT,
			        LEAD_MANAGER,
			        REQUIRED_DT,
			        COMPETITOR_YN,
			        BUDGET_AVAIL_YN
			FROM    tb_lead;
	</select>
	
	<!-- 잠재고개객 각 항목 선택-->
	<!-- 접촉사항조회 -->
	<select id="selectContactListByVend"
           parameterType="string"
           resultType="store.yd2team.business.service.ContactVO">
       SELECT
           CONTACT_NO        AS contactNo,
           POTENTIAL_INFO_NO AS potentialInfoNo,
           VEND_ID           AS vendId,
           TO_CHAR(CONTACT_DT, 'YYYY-MM-DD') AS contactDt,
           CONTACT_MANAGER   AS contactManager,
           CONTACT_WAY       AS contactWay,
           CONTACT_CNTN      AS contactCntn,
           CREA_DT           AS creaDt,
           CREA_BY           AS creaBy,
           UPDT_DT           AS updtDt,
           UPDT_BY           AS updtBy
       FROM TB_CONTACT
       WHERE VEND_ID = #{vendId}
       ORDER BY CONTACT_DT DESC
   </select>
  
   <!-- 접촉사항 등록 -->
   <insert id="insertContact"
           parameterType="store.yd2team.business.service.ContactVO">
       INSERT INTO TB_CONTACT
       (
           CONTACT_NO,
           POTENTIAL_INFO_NO,
           VEND_ID,
           CONTACT_DT,
           CONTACT_MANAGER,
           CONTACT_WAY,
           CONTACT_CNTN
       )
       VALUES
       (
           CONTACT_SEQ.NEXTVAL,
           #{potentialInfoNo},
           #{vendId},
           TO_DATE(#{contactDt}, 'YYYY-MM-DD'),
           #{contactManager},
           #{contactWay},
           #{contactCntn}
       )
   </insert>
  
	<!-- 접촉사항 수정 -->
	<update id="updateContact"
		        parameterType="store.yd2team.business.service.ContactVO">
		 UPDATE TB_CONTACT
		       SET  CONTACT_DT 		= #{contactDt},
					CONTACT_MANAGER = #{contactManager},
					CONTACT_WAY 	= #{contactWay},
					CONTACT_CNTN 	= #{contactCntn},
			        UPDT_DT      	= SYSDATE
		     WHERE CONTACT_NO  = #{contactNo}
		</update>
	
	
	<!-- 리드내역조회 -->
	<select id="getLeadListByVend"
           parameterType="string"
           resultType="store.yd2team.business.service.LeadVO">
       SELECT
           lead_no				as leadNo,
			vend_id				as vendId,
			lead_dt				as leadDt,
			lead_manager		as leadManager,
			required_dt			as requiredDt,
			competitor_yn		as competitorYn,
			budget_avail_yn		as budgetAvailYn
       FROM tb_lead
       WHERE VEND_ID = #{vendId}
       ORDER BY lead_dt DESC
   </select>
  
   <!-- 리드내역 등록 -->
   <insert id="insertLead"
           parameterType="store.yd2team.business.service.LeadVO">
       INSERT INTO TB_LEAD
       (
          LEAD_NO,
          POTENTIAL_INFO_NO,
          VEND_ID,
          LEAD_DT,
          LEAD_MANAGER,
          REQUIRED_DT,
          COMPETITOR_YN,
          BUDGET_AVAIL_YN
       )
       VALUES
       (
           SEQ_TB_LEAD_NO.NEXTVAL,
           #{potentialInfoNo},
           #{vendId},
           TO_DATE(#{leadDt}, 'YYYY-MM-DD'),
           #{leadManager},
           #{requiredDt},
           SUBSTR(#{competitorYn}, 1, 1),   <!-- ★ 여기서 1글자로 강제 -->
       	SUBSTR(#{budgetAvailYn}, 1, 1)   <!-- ★ 여기서 1글자로 강제 -->
       )
   </insert>
  
	<!-- 리드내역 수정 -->
	<update id="updateLead"
		        parameterType="store.yd2team.business.service.LeadVO">
		 UPDATE TB_LEAD
		       SET LEAD_MANAGER		= #{leadManager},
		           REQUIRED_DT		= #{requiredDt},
		           COMPETITOR_YN	= #{competitorYn},
		           BUDGET_AVAIL_YN	= #{budgetAvailYn},
			       UPDT_DT          = SYSDATE
		     WHERE LEAD_NO  = #{leadNo}
	</update>
	
	<!-- 데모내역조회 -->
	<select id="getDemoListByVend"
           parameterType="string"
           resultType="store.yd2team.business.service.DemoVO">
       SELECT
           DEMO_QUOTATIO_NO	as	demoQuotatioNo,
			POTENTIAL_INFO_NO	as	potentialInfoNo,
			VEND_ID				as	vendId,
			DEMO_QUOTATIO_DT	as	demoQuotatioDt,
			DEMO_MANAGER		as	demoManager,
			DEMO_DC				as	demoDc,
			CUST_REACTION		as	custReaction,
			SAMPLE_PRIVIDE		as	samplePrivide,
			CUST_QY				as	custQy,
			CUST_DISCOUNT		as	custDiscount,
			CUST_DELIVERY		as	custDelivery
       FROM TB_DEMO_QUOTATIO
       WHERE VEND_ID = #{vendId}
       ORDER BY DEMO_QUOTATIO_DT DESC
   </select>
  
   <!-- 데모내역 등록 -->
   <insert id="insertDemo"
           parameterType="store.yd2team.business.service.DemoVO">
       INSERT INTO TB_DEMO_QUOTATIO
       (
           DEMO_QUOTATIO_NO,
			POTENTIAL_INFO_NO,
			VEND_ID,
			DEMO_QUOTATIO_DT,
			DEMO_MANAGER,
			DEMO_DC,
			CUST_REACTION,
			SAMPLE_PRIVIDE,
			CUST_QY,
			CUST_DISCOUNT,
			CUST_DELIVERY
       )
       VALUES
       (
           SEQ_TB_DEMO_QUOTATIO_NO.NEXTVAL,
           #{potentialInfoNo},
           #{vendId},
           TO_DATE(#{demoQuotatioDt}, 'YYYY-MM-DD'),
           #{demoManager},
           #{demoDc},
           #{custReaction},
           #{samplePrivide},
           #{custQy},
           #{custDiscount},
           #{custDelivery}
       )
   </insert>
  
	<!-- 데모내역 수정 -->
	<update id="updateDemo"
		        parameterType="store.yd2team.business.service.DemoVO">
		 UPDATE TB_DEMO_QUOTATIO
		       SET  DEMO_MANAGER	= #{demoManager},
					DEMO_DC			= #{demoDc},
					CUST_REACTION	= #{custReaction},
					SAMPLE_PRIVIDE	= #{samplePrivide},
					CUST_QY			= #{custQy},
					CUST_DISCOUNT	= #{custDiscount},
					CUST_DELIVERY	= #{custDelivery}
		     WHERE DEMO_QUOTATIO_NO  = #{demoQuotatioNo}
		</update>
	
</mapper>

