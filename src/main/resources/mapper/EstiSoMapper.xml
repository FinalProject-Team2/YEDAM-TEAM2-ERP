<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="store.yd2team.business.mapper.EstiSoMapper">
<!-- 견적서 조회 -->
	  <select id="selectEsti" parameterType="store.yd2team.business.service.EstiSoVO"  resultType="store.yd2team.business.service.EstiSoVO">
		SELECT
	           x.esti_id AS estiId          <!-- 견적서 코드 -->
	         , x.version AS version         <!-- 버전 -->
	         , x.custcom_name AS custcomNameResult     <!-- 고객사명 -->
	         , x.cdtln_lmt AS cdtlnLmt         <!-- 여신한도 -->
	         , x.total_amount AS totalAmount     <!-- 금액합계(원) -->
	         , CASE                                       <!-- 대표상품명 + "외 n건" -->
	             WHEN x.item_cnt > 1 THEN
	                  x.main_product_name || ' 외 ' || (x.item_cnt - 1) || '건'
	             ELSE
	                  x.main_product_name
	           END                    AS productName
	         , x.due_dt               AS dueDt           <!-- 납기일 -->
	         , x.esti_st              AS estiSt          <!-- 상태코드 (승인/반려 버튼에서 사용) -->
	         , c.code_nm              AS estiStNm        <!-- 공통코드명(대기/승인/반려) -->
	         , x.recall_resn  AS recallResn
	    FROM (
	            SELECT
	                   e.esti_id                           AS esti_id
	                 , e.version                           AS version
	                 , e.custcom_name                      AS custcom_name
	                 , e.cdtln_lmt                          AS cdtln_lmt
	                 , SUM(d.supply_amt)                  AS total_amount      -- 상세 공급가 합계
	                 , COUNT(DISTINCT d.product_id)       AS item_cnt          -- 상품 종류 수
	                 , MIN(p.product_name)
	                     KEEP (DENSE_RANK FIRST ORDER BY d.esti_detail_no)
	                                                      AS main_product_name -- 대표 상품명(첫 라인 기준)
	                 , e.due_dt                            AS due_dt
	                 , e.esti_st                           AS esti_st          -- 상태 코드
	                 , e.recall_resn  AS recall_resn
	            FROM   tb_esti        e
	            JOIN   tb_esti_detail d
	                   ON d.esti_id = e.esti_id
	                  AND d.version = e.version
	            LEFT JOIN tb_product  p
	                   ON p.product_id = d.product_id
	            
	            <where>
	                <!-- 거래처 명(=고객사명) 검색 -->
	                <if test="custcomName != null and custcomName != ''">
	                    AND e.custcom_name LIKE '%' || #{custcomName} || '%'
	                </if>
	
	                <!-- 납기일 시작일 : EstiSoVO.dueStart (LocalDate) -->
	                <if test="dueStart != null">
	                    AND e.due_dt &gt;= #{dueStart}
	                </if>
	
	                <!-- 납기일 종료일 : EstiSoVO.dueEnd (LocalDate) -->
	                <if test="dueEnd != null">
	                    AND e.due_dt &lt;= #{dueEnd}
	                </if>
	            </where>
	            GROUP BY
	                   e.esti_id
	                 , e.version
	                 , e.custcom_name
	                 , e.cdtln_lmt
	                 , e.due_dt
	                 , e.esti_st
	                 , e.recall_resn
	         ) x
	         LEFT JOIN tb_code c
	           ON c.grp_id  = 'esti'
	          AND c.code_id = x.esti_st
	    ORDER BY
	           x.esti_id DESC,
	           x.version DESC
	</select>

<!-- 승인 반려 상태값 업데이트 -->
	<update id="updateStatus" parameterType="store.yd2team.business.service.EstiSoVO">
	    UPDATE tb_esti
	       SET esti_st     = #{estiSt}
	         , recall_resn = #{recallResn}
	         , updt_dt     = SYSDATE
	         , updt_by     = 'Admin'
	     WHERE esti_id = #{estiId}
	       AND version = #{version}
	</update>
	
<!-- 견적서 모달 상품 auto complete -->
    <!-- 상품명 자동완성 검색 -->
    <select id="searchProduct" resultType="store.yd2team.business.service.EstiSoVO">
        SELECT
               product_id AS productId,
               product_name AS productName,
               basis_sale_amt AS basisSaleAmt
          FROM tb_product
         WHERE product_name LIKE '%' || #{keyword} || '%'
         ORDER BY product_name
    </select>

    <!-- 상품 상세조회 (단가 가져오기) -->
    <select id="getProductDetail" resultType="store.yd2team.business.service.EstiSoVO">
        SELECT
               product_id,
               product_name,
               basis_sale_amt
          FROM tb_product
         WHERE product_id = #{productId}
    </select>

<!-- 신규견적서 모달 고객사 auto complete -->
	<!-- 고객사명 검색 -->
    <select id="searchCustcomId" parameterType="string" resultType="store.yd2team.business.service.EstiSoVO">
	    SELECT 
	        custcom_id AS custcomId,
	        custcom_name AS custcomName,
	        vend_id AS vendId
	    FROM tb_custcom
	    WHERE custcom_id LIKE '%' || #{keyword} || '%'
	    ORDER BY custcom_id
	</select>

    <!-- 고객사코드 검색 -->
    <select id="searchCustcomName" parameterType="string" resultType="store.yd2team.business.service.EstiSoVO">
	    SELECT 
	        custcom_id AS custcomId,
	        custcom_name AS custcomName,
	        vend_id AS vendId
	    FROM tb_custcom
	    WHERE custcom_name LIKE '%' || #{keyword} || '%'
	    ORDER BY custcom_name
	</select>
	

<!--  모달 저장버튼 -->
<!-- ======================= 헤더 INSERT (항상 INSERT) ======================= -->
    <insert id="insertEsti" parameterType="store.yd2team.business.service.EstiSoVO">

        <!-- fn_esti_id 로 PK 생성 → vo.estiId 에 세팅 -->
        <selectKey keyProperty="estiId" resultType="string" order="BEFORE">
            select fn_esti_id()
            from dual
        </selectKey>

        insert into tb_esti (
              esti_id
            , version
            , custcom_id
            , cdtln_no
            , custcom_name
            , so_dt
            , due_dt
            , cdtln_lmt
            , tt_supply_amt
            , esti_st
            , recall_resn
            , rm
            , crea_dt
        ) values (
              #{estiId}
            , #{version}
            , #{custcomId}
            , #{cdtlnNo}
            , #{custcomName}      <!-- 입력용 필드 -->
            , sysdate
            , #{dueDt}
            , #{cdtlnLmt}
            , #{ttSupplyAmt}
            , #{estiSt}
            , #{recallResn}
            , #{rm}
            , sysdate
        )
    </insert>

    <!-- ======================= 상세 INSERT (항상 INSERT) ======================= -->
    <insert id="insertEstiDetail" parameterType="store.yd2team.business.service.EstiSoDetailVO">

        <selectKey keyProperty="estiDetailNo" resultType="long" order="BEFORE">
            select seq_esti_detail.nextval
            from dual
        </selectKey>

        insert into tb_esti_detail (
              esti_detail_no
            , esti_id
            , version
            , product_id
            , qy
            , price
            , supply_amt
            , rm
            , crea_dt
        ) values (
              #{estiDetailNo}
            , #{estiId}
            , #{version}
            , #{productId}
            , #{qy}
            , #{price}
            , #{supplyAmt}
            , #{rm}
            , sysdate
        )
    </insert>

    <!-- ======================= 현재 버전 조회 ======================= -->
    <select id="selectCurrentVersion"
            parameterType="string"
            resultType="string">
        select nvl(max(version), 0)
        from tb_esti
        where esti_id = #{estiId}
    </select>

     <!-- ======================= 헤더 조회 (최신 버전 1건) ======================= -->
    <select id="selectEstiHeader"
            parameterType="string"
            resultType="store.yd2team.business.service.EstiSoVO">

        SELECT *
        FROM (
            SELECT
                  esti_id          AS estiId
                , version          AS version
                , custcom_id       AS custcomId
                , cdtln_no         AS cdtlnNo
                , custcom_name     AS custcomNameResult
                , so_dt            AS soDt
                , due_dt           AS dueDt
                , cdtln_lmt        AS cdtlnLmt
                , tt_supply_amt    AS ttSupplyAmt
                , esti_st          AS estiSt
                , recall_resn      AS recallResn
                , rm               AS rm
            FROM tb_esti
            WHERE esti_id = #{estiId}
            ORDER BY version DESC
        )
        WHERE ROWNUM = 1

    </select>

    <!-- ======================= 상세 조회 (해당 estiId의 최신버전 상세) ======================= -->
    <select id="selectEstiDetailList"
	        parameterType="string"
	        resultType="store.yd2team.business.service.EstiSoDetailVO">
	    SELECT
	          d.esti_detail_no   AS estiDetailNo
	        , d.esti_id          AS estiId
	        , d.version          AS version
	        , d.vend_id          AS vendId
	        , d.product_id       AS productId
	        , p.product_name     AS productName   <!-- ▶ 상품명 -->
	        , d.qy               AS qy
	        , d.price            AS price
	        , d.supply_amt       AS supplyAmt
	        , d.rm               AS rm
	    FROM tb_esti_detail d
	         LEFT JOIN tb_product p
	           ON d.product_id = p.product_id
	    WHERE d.esti_id = #{estiId}
	      AND d.version = (
	            SELECT MAX(version)
	            FROM tb_esti_detail
	            WHERE esti_id = #{estiId}
	      )
	    ORDER BY d.esti_detail_no
	</select>
    
    
    <!-- 주문번호 생성 -->
	<select id="createSoId" resultType="string">
	    select fn_so_id()
	    from dual
	</select>
	
	<!-- 주문 헤더 INSERT -->
	<insert id="insertSo" parameterType="store.yd2team.business.service.EstiSoVO">
	    insert into tb_so (
	          so_id
	        , custcom_id
	        , esti_id
	        , version
	        , due_dt
	        , tt_supply_price
	        , tt_surtax_price      -- ★ 추가
	        , tt_price             -- ★ 추가
	        , tt_so_qy
	        , rm
	        , ship_addr
	        , crea_dt
	    ) values (
	          #{soId}
	        , #{custcomId}
	        , #{estiId}
	        , #{version}
	        , #{dueDt}
	        , #{ttSupplyPrice}
	        , #{ttSurtaxPrice}     -- ★
	        , #{ttPrice}           -- ★
	        , #{ttSoQy}
	        , #{rm}
	        , #{shipAddr}
	        , sysdate
	    )
	</insert>
	
	<!-- 주문 상세 INSERT -->
	<insert id="insertSoDetail" parameterType="store.yd2team.business.service.EstiSoDetailVO">
	
	    <selectKey keyProperty="soDetailNo" resultType="long" order="BEFORE">
	        select seq_so_detail.nextval
	        from dual
	    </selectKey>
	
	    insert into tb_so_detail (
	          so_detail_no
	        , so_id
	        , product_id
	        , qy
	        , price
	        , supply_price
	        , rm
	        , crea_dt
	    ) values (
	          #{soDetailNo}
	        , #{soId}
	        , #{productId}
	        , #{qy}
	        , #{price}
	        , #{supplyAmt}  <!-- 견적 supply_amt 그대로 사용 -->
	        , #{rm}
	        , sysdate
	    )
	</insert>
	
	<!-- 견적 상태를 주문완료(es4)로 변경 -->
	<update id="updateEstiStatusToOrdered">
	    update tb_esti
	       set esti_st = 'es4'
	     where esti_id = #{estiId}
	       and version = #{version}
	</update>



<!-- ================= 주문서 관리 화면 ======================= -->
	<!-- 주문서 헤더 조회 -->
	<select id="selectSoHeaderList" parameterType="store.yd2team.business.service.EstiSoVO" resultType="store.yd2team.business.service.EstiSoVO">
	    SELECT
	        so.so_id,
	        c.custcom_name,
	        c.psch,
	        c.psch_tel,
	        so.so_dt,
	        so.due_dt,
	        so.tt_supply_price AS ttSupplyAmt,
	        so.tt_so_qy AS ttSoQy,
	        so.progrs_st,
	        code.code_id,
	        code.code_nm
	    FROM tb_so so
	    JOIN tb_custcom c
	      ON so.custcom_id = c.custcom_id
	    JOIN tb_code code
	      ON so.progrs_st = code.code_id
	    WHERE (#{custcomName} IS NULL OR c.custcom_name LIKE '%' || #{custcomName} || '%')
	      AND (#{dueStart} IS NULL OR so.due_dt >= #{dueStart})
	      AND (#{dueEnd} IS NULL OR so.due_dt &lt;= #{dueEnd})
	    ORDER BY so.so_id DESC
	</select>
	
	<!-- 주문 상세 조회 -->
	<select id="selectSoDetailList" parameterType="string" resultType="store.yd2team.business.service.EstiSoDetailVO">
	    SELECT
	        d.so_detail_no,
	        d.so_id,
	        d.product_id,
	        p.product_name,
	        d.qy AS ttSoQy,
	        d.price,
	        d.supply_price AS ttSupplyAmt,
	        (NVL(s.curr_stock_qy, 0) - NVL(s.oust_reserv_qy, 0)) AS currStockQy
	    FROM tb_so_detail d
	    JOIN tb_product p
	      ON d.product_id = p.product_id
	    LEFT JOIN tb_stock s
	      ON d.product_id = s.product_id
	    WHERE d.so_id = #{soId}
	    ORDER BY d.so_detail_no
	</select>
	
	<!-- 주문서관리화면 승인버튼 -->
	<!-- 단건 조회 (상태 확인용) -->
    <select id="getOrderHeader"
            parameterType="string"
            resultType="store.yd2team.business.service.EstiSoVO">
        SELECT so_id, progrs_st
        FROM tb_so
        WHERE so_id = #{soId}
    </select>


    <!-- 출고예약수량 += 주문수량 -->
    <update id="updateReserveStock" parameterType="store.yd2team.business.service.EstiSoDetailVO">
        UPDATE tb_stock
        SET oust_reserv_qy = oust_reserv_qy + #{ttSoQy}
        WHERE product_id = #{productId}
    </update>


    <!-- 출고 INSERT -->
    <insert id="insertOust" parameterType="store.yd2team.business.service.EstiSoDetailVO">
        INSERT INTO tb_oust (
            oust_id, so_id, product_id, oust_qy, oust_request_dt, oust_progrs_st
        ) VALUES (
            'OUST_' || TO_CHAR(SYSTIMESTAMP, 'YYYYMMDDHH24MISSFF3'),
            #{soId},
            #{productId},
            #{ttSoQy},
            SYSDATE,
            'os1'
        )
    </insert>


    <!-- 승인 상태 변경 -->
    <update id="updateApproveStatus" parameterType="string">
        UPDATE tb_so
        SET progras_st = 'es2'
        WHERE so_id = #{soId}
    </update>
</mapper>