<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="store.yd2team.business.mapper.EstiSoMapper">
<!-- Í≤¨Ï†ÅÏÑú Ï°∞Ìöå -->
	<select id="selectEsti" parameterType="store.yd2team.business.service.EstiSoVO" resultType="store.yd2team.business.service.EstiSoVO">
		SELECT
		       x.esti_id            AS estiId
		     , x.version            AS version
		     , x.custcom_name       AS custcomNameResult
		     , x.cdtln_lmt          AS cdtlnLmt
		     , x.total_amount       AS totalAmount
		     , CASE
		         WHEN x.item_cnt > 1 THEN
		              x.main_product_name || ' Ïô∏ ' || (x.item_cnt - 1) || 'Í±¥'
		         ELSE
		              x.main_product_name
		       END                  AS productName
		     , x.due_dt             AS dueDt
		     , x.so_dt              AS soDt
		     , x.esti_st            AS estiSt
		     , c.code_nm            AS estiStNm
		     , x.recall_resn        AS recallResn
		FROM (
		        SELECT
		               e.esti_id
		             , e.version
		             , e.custcom_name
		             , cd.cdtln_lmt
		             , SUM(d.supply_amt) AS total_amount
		             , COUNT(DISTINCT d.product_id) AS item_cnt
		             , MIN(p.product_name)
		                 KEEP (DENSE_RANK FIRST ORDER BY d.esti_detail_no)
		                 AS main_product_name
		             , e.due_dt
		             , e.so_dt
		             , e.esti_st
		             , e.recall_resn
		
		             -- üî• ÌïµÏã¨
		             , ROW_NUMBER() OVER (
		                   PARTITION BY e.esti_id
		                   ORDER BY
		                       TO_NUMBER(REPLACE(e.version, 'ver', '')) DESC
		               ) AS rn
		
		        FROM tb_esti e
		        JOIN tb_esti_detail d
		          ON d.esti_id = e.esti_id
		         AND d.version = e.version
		        LEFT JOIN tb_product p
		          ON p.product_id = d.product_id
		        LEFT JOIN tb_cdtln_lmt cd
		          ON e.custcom_id = cd.custcom_id
		
		        <where>
		            <if test="custcomName != null and custcomName != ''">
		                AND e.custcom_name LIKE '%' || #{custcomName} || '%'
		            </if>
		            <if test="dueStart != null">
		                AND e.due_dt &gt;= #{dueStart}
		            </if>
		            <if test="dueEnd != null">
		                AND e.due_dt &lt;= #{dueEnd}
		            </if>
		        </where>
		
		        GROUP BY
		               e.esti_id
		             , e.version
		             , e.custcom_name
		             , cd.cdtln_lmt
		             , e.due_dt
		             , e.so_dt
		             , e.esti_st
		             , e.recall_resn
		     ) x
		     LEFT JOIN tb_code c
		       ON c.grp_id = 'esti'
		      AND c.code_id = x.esti_st
		WHERE x.rn = 1        <!-- ‚úÖ ÏµúÏã† Î≤ÑÏ†ÑÎßå -->
		ORDER BY x.esti_id DESC
	</select>
	
<!-- Ïù¥Î†•Î≥¥Í∏∞ Î™®Îã¨ -->
	<select id="selectEstiHistory" resultType="store.yd2team.business.service.EstiSoVO">
	    SELECT
	        e.esti_id        AS estiId,
	        e.version        AS version,
	        e.tt_supply_amt  AS ttSupplyAmt,
	        e.esti_st        AS estiSt,
	        c.code_nm        AS estiStNm,
	        TO_CHAR(e.crea_dt, 'YYYY-MM-DD') AS creaDt,
	        e.crea_by        AS creaBy
	    FROM tb_esti e
	    LEFT JOIN tb_code c
	      ON c.grp_id = 'esti'
	     AND c.code_id = e.esti_st
	    WHERE e.esti_id = #{estiId}
	    ORDER BY e.version DESC
	</select>

<!-- Ïù¥Î†•Î≥¥Í∏∞Ïùò Î≥¥Í∏∞ Î™®Îã¨ -->
	<select id="selectEstiHeaderByVersion" resultType="store.yd2team.business.service.EstiSoVO">
	    SELECT
	        e.esti_id       AS estiId,
	        e.version       AS version,
	        e.custcom_id    AS custcomId,
	        e.custcom_name  AS custcomNameResult,
	        e.due_dt        AS dueDt,
	        e.tt_supply_amt AS ttSupplyAmt,
	        e.esti_st       AS estiSt,
	        e.rm            AS rm
	    FROM tb_esti e
	    WHERE e.esti_id = #{estiId}
	      AND e.version = #{version}
	</select>
	
	<select id="selectEstiDetailListByVersion" resultType="store.yd2team.business.service.EstiSoDetailVO">
	    SELECT
	        d.esti_detail_no AS estiDetailNo,
	        d.esti_id        AS estiId,
	        d.version        AS version,
	        d.product_id     AS productId,
	        p.product_name   AS productName,
	        d.qy             AS qy,
	        d.price          AS price,
	        d.supply_amt     AS supplyAmt,
	        d.rm             AS rm
	    FROM tb_esti_detail d
	    LEFT JOIN tb_product p
	      ON p.product_id = d.product_id
	    WHERE d.esti_id = #{estiId}
	      AND d.version = #{version}
	    ORDER BY d.esti_detail_no
	</select>

<!-- ÏäπÏù∏ Î∞òÎ†§ ÏÉÅÌÉúÍ∞í ÏóÖÎç∞Ïù¥Ìä∏ -->
	<update id="updateStatus" parameterType="store.yd2team.business.service.EstiSoVO">
	    UPDATE tb_esti
	       SET esti_st     = #{estiSt}
	         , recall_resn = #{recallResn}
	         , updt_dt     = SYSDATE
	         , updt_by     = #{updtBy}
	     WHERE esti_id = #{estiId}
	       AND version = #{version}
	       AND vend_id = #{vendId}
	</update>
	
<!-- Í≤¨Ï†ÅÏÑú Î™®Îã¨ ÏÉÅÌíà auto complete -->
    <!-- ÏÉÅÌíàÎ™Ö ÏûêÎèôÏôÑÏÑ± Í≤ÄÏÉâ -->
    <select id="searchProduct" resultType="store.yd2team.business.service.EstiSoVO">
        SELECT
               product_id AS productId,
               product_name AS productName,
               basis_sale_amt AS basisSaleAmt
          FROM tb_product
         WHERE product_name LIKE '%' || #{keyword} || '%'
         ORDER BY product_name
    </select>

    <!-- ÏÉÅÌíà ÏÉÅÏÑ∏Ï°∞Ìöå (Îã®Í∞Ä Í∞ÄÏ†∏Ïò§Í∏∞) -->
    <select id="getProductDetail" resultType="store.yd2team.business.service.EstiSoVO">
        SELECT
               product_id,
               product_name,
               basis_sale_amt
          FROM tb_product
         WHERE product_id = #{productId}
    </select>

<!-- Ïã†Í∑úÍ≤¨Ï†ÅÏÑú Î™®Îã¨ Í≥†Í∞ùÏÇ¨ auto complete -->
	<!-- Í≥†Í∞ùÏÇ¨Î™Ö Í≤ÄÏÉâ -->
    <select id="searchCustcomId" parameterType="string" resultType="store.yd2team.business.service.EstiSoVO">
	    SELECT 
	        custcom_id AS custcomId,
	        custcom_name AS custcomName,
	        vend_id AS vendId
	    FROM tb_custcom
	    WHERE custcom_id LIKE '%' || #{keyword} || '%'
	    ORDER BY custcom_id
	</select>

    <!-- Í≥†Í∞ùÏÇ¨ÏΩîÎìú Í≤ÄÏÉâ -->
    <select id="searchCustcomName" parameterType="string" resultType="store.yd2team.business.service.EstiSoVO">
	    SELECT 
	        custcom_id AS custcomId,
	        custcom_name AS custcomName,
	        vend_id AS vendId
	    FROM tb_custcom
	    WHERE custcom_name LIKE '%' || #{keyword} || '%'
	    ORDER BY custcom_name
	</select>
	

<!--  Ïã†Í∑ú Í≤¨Ï†ÅÏÑú Î™®Îã¨ Ï†ÄÏû•Î≤ÑÌäº -->
<!-- ======================= Ìó§Îçî INSERT (Ìï≠ÏÉÅ INSERT) ======================= -->
    <insert id="insertNewEsti" parameterType="store.yd2team.business.service.EstiSoVO">
	
	    <!-- Ïã†Í∑úÏùº ÎïåÎßå esti_id ÏÉùÏÑ± -->
	    <selectKey keyProperty="estiId" resultType="string" order="BEFORE">
	        SELECT fn_esti_id()
	        FROM dual
	    </selectKey>
	
	    INSERT INTO tb_esti (
	          esti_id
	        , version
	        , vend_id
	        , custcom_id
	        , custcom_name
	        , due_dt
	        , tt_supply_amt
	        , esti_st
	        , rm
	        , crea_dt
	        , crea_by
	    ) VALUES (
	          #{estiId}
	        , #{version}
	        , #{vendId}
	        , #{custcomId}
	        , #{custcomName}
	        , #{dueDt}
	        , #{ttSupplyAmt}
	        , #{estiSt}
	        , #{rm}
	        , SYSDATE
	        , #{creaBy}
	    )
	</insert>
	
	<!-- Í≤¨Ï†ÅÏÑú ÏàòÏ†ï (Ïù¥Î†• INSERT) -->
	<insert id="insertEstiHistory" parameterType="store.yd2team.business.service.EstiSoVO">
	
	    INSERT INTO tb_esti (
	          esti_id
	        , version
	        , vend_id
	        , custcom_id
	        , custcom_name
	        , due_dt
	        , tt_supply_amt
	        , esti_st
	        , rm
	        , crea_dt
	        , crea_by
	    ) VALUES (
	          #{estiId}        <!-- Í∏∞Ï°¥ esti_id Í∑∏ÎåÄÎ°ú -->
	        , #{version}
	        , #{vendId}
	        , #{custcomId}
	        , #{custcomName}
	        , #{dueDt}
	        , #{ttSupplyAmt}
	        , #{estiSt}
	        , #{rm}
	        , SYSDATE
	        , #{creaBy}
	    )
	</insert>

    <!-- ======================= ÏÉÅÏÑ∏ INSERT (Ìï≠ÏÉÅ INSERT) ======================= -->
    <insert id="insertEstiDetail" parameterType="store.yd2team.business.service.EstiSoDetailVO">

	    <selectKey keyProperty="estiDetailNo" resultType="long" order="BEFORE">
	        SELECT seq_esti_detail.nextval
	        FROM dual
	    </selectKey>
	
	    INSERT INTO tb_esti_detail (
	          esti_detail_no
	        , esti_id
	        , version
	        , vend_id
	        , product_id
	        , qy
	        , price
	        , supply_amt
	        , rm
	        , crea_dt
	        , crea_by
	    ) VALUES (
	          #{estiDetailNo}
	        , #{estiId}
	        , #{version}
	        , #{vendId}
	        , #{productId}
	        , #{qy}
	        , #{price}
	        , #{supplyAmt}
	        , #{rm}
	        , SYSDATE
	        , #{creaBy}
	    )
	</insert>


    <!-- ======================= ÌòÑÏû¨ Î≤ÑÏ†Ñ Ï°∞Ìöå ======================= -->
    <select id="selectCurrentVersion"
            parameterType="string"
            resultType="string">
        <!-- select nvl(max(version), 0) -->
        SELECT MAX(version)
        FROM tb_esti
        WHERE esti_id = #{estiId}
    </select>

     <!-- ======================= Ìó§Îçî Ï°∞Ìöå (ÏµúÏã† Î≤ÑÏ†Ñ 1Í±¥) ======================= -->
    <select id="selectEstiHeader"
            parameterType="string"
            resultType="store.yd2team.business.service.EstiSoVO">

        SELECT *
        FROM (
            SELECT
                  esti_id          AS estiId
                , version          AS version
                , custcom_id       AS custcomId
                , cdtln_no         AS cdtlnNo
                , custcom_name     AS custcomNameResult
                , so_dt            AS soDt
                , due_dt           AS dueDt
                , cdtln_lmt        AS cdtlnLmt
                , tt_supply_amt    AS ttSupplyAmt
                , esti_st          AS estiSt
                , recall_resn      AS recallResn
                , rm               AS rm
            FROM tb_esti
            WHERE esti_id = #{estiId}
            ORDER BY version DESC
        )
        WHERE ROWNUM = 1

    </select>

    <!-- ======================= ÏÉÅÏÑ∏ Ï°∞Ìöå (Ìï¥Îãπ estiIdÏùò ÏµúÏã†Î≤ÑÏ†Ñ ÏÉÅÏÑ∏) ======================= -->
    <select id="selectEstiDetailList" parameterType="string" resultType="store.yd2team.business.service.EstiSoDetailVO">
	
	  SELECT
	      d.esti_detail_no  AS estiDetailNo,
	      d.esti_id         AS estiId,
	      d.version         AS version,
	      d.product_id      AS productId,
	      p.product_name    AS productName,
	      d.qy              AS qy,
	      d.price           AS price,
	      d.supply_amt      AS supplyAmt,
	      d.rm              AS rm
	  FROM tb_esti_detail d
	  JOIN tb_product p
	    ON p.product_id = d.product_id
	  WHERE d.esti_id = #{estiId}
	    AND d.version = (
	        SELECT MAX(version)
	        FROM tb_esti_detail
	        WHERE esti_id = #{estiId}
	    )
	  ORDER BY d.esti_detail_no
	</select>
    
    
    <!-- Ï£ºÎ¨∏Î≤àÌò∏ ÏÉùÏÑ± -->
	<select id="createSoId" resultType="string">
	    select fn_so_id()
	    from dual
	</select>
	
	<!-- Ï£ºÎ¨∏ Ìó§Îçî INSERT -->
	<insert id="insertSo" parameterType="store.yd2team.business.service.EstiSoVO">
	    INSERT INTO tb_so (
	          so_id
	        , vend_id
	        , custcom_id
	        , esti_id
	        , version
	        , so_dt
	        , due_dt
	        , tt_supply_price
	        , tt_surtax_price
	        , tt_price
	        , tt_so_qy
	        , ship_addr
	        , rm
	        , rcipt_appo_dt
	        , rcipt_appo_amt
	        , appo_mtd
	        , crea_dt
	        , crea_by
	    ) VALUES (
	          #{soId}
	        , #{vendId}
	        , #{custcomId}
	        , #{estiId}
	        , #{version}
	        , SYSDATE
	        , #{dueDt}
	        , #{ttSupplyPrice}
	        , #{ttSurtaxPrice}
	        , #{ttPrice}
	        , #{ttSoQy}
	        , #{shipAddr}
	        , #{rm}
	        , #{rciptAppoDt}
	        , #{rciptAppoAmt}
	        , #{appoMtd}
	        , SYSDATE
	        , #{creaBy}
	    )
	</insert>

	
	<!-- Ï£ºÎ¨∏ ÏÉÅÏÑ∏ INSERT -->
	<insert id="insertSoDetail" parameterType="store.yd2team.business.service.EstiSoDetailVO">

    <selectKey keyProperty="soDetailNo" resultType="long" order="BEFORE">
        SELECT seq_so_detail.NEXTVAL
        FROM dual
    </selectKey>

	    INSERT INTO tb_so_detail (
	          so_detail_no
	        , so_id
	        , vend_id          -- ÌöåÏÇ¨ÏΩîÎìú
	        , product_id
	        , qy
	        , price
	        , supply_price
	        , rm
	        , crea_dt
	        , crea_by          -- Îì±Î°ùÏûê
	        , updt_dt
	        , updt_by
	    ) VALUES (
	          #{soDetailNo}
	        , #{soId}
	        , #{vendId}
	        , #{productId}
	        , #{qy}
	        , #{price}
	        , #{supplyAmt}
	        , #{rm}
	        , SYSDATE
	        , #{creaBy}
	        , SYSDATE
	        , #{updtBy}
	    )
	</insert>

	
	<!-- Í≤¨Ï†Å ÏÉÅÌÉúÎ•º Ï£ºÎ¨∏ÏôÑÎ£å(es4)Î°ú Î≥ÄÍ≤Ω -->
<!-- 	<update id="updateEstiStatusToOrdered">
	    update tb_esti
	       set esti_st = 'es4'
	     where esti_id = #{estiId}
	       and version = #{version}
	</update> -->
	<update id="updateEstiStatusToOrdered">
	    UPDATE tb_esti
	       SET esti_st  = 'es4',
	           updt_dt  = SYSDATE,
	           updt_by  = #{updtBy}
	     WHERE esti_id = #{estiId}
	       AND version = #{version}
	</update>



<!-- ================= Ï£ºÎ¨∏ÏÑú Í¥ÄÎ¶¨ ÌôîÎ©¥ ======================= -->
	<!-- Ï£ºÎ¨∏ÏÑú Ìó§Îçî Ï°∞Ìöå -->
	<select id="selectSoHeaderList" parameterType="store.yd2team.business.service.EstiSoVO" resultType="store.yd2team.business.service.EstiSoVO">
	    SELECT
	        'h' AS header,
	        so.so_id,
	        c.custcom_name,
	        c.psch,
	        c.psch_tel,
	        so.so_dt,
	        so.due_dt,
	        so.tt_supply_price AS ttSupplyAmt,
	        so.tt_so_qy AS ttSoQy,
	        so.progrs_st AS progrsSt,
	        code.code_id,
	        code.code_nm,
	        so.st_resn AS stResn,
	        so.rm,
	        so.ship_addr AS shipAddr
	    FROM tb_so so
	    JOIN tb_custcom c
	      ON so.custcom_id = c.custcom_id
	    JOIN tb_code code
	      ON so.progrs_st = code.code_id
	    WHERE (#{custcomName} IS NULL OR c.custcom_name LIKE '%' || #{custcomName} || '%')
	      AND (#{dueStart} IS NULL OR so.due_dt >= #{dueStart})
	      AND (#{dueEnd} IS NULL OR so.due_dt &lt;= #{dueEnd})
	    ORDER BY so.so_id DESC
	</select>
	
	<!-- Ï£ºÎ¨∏ ÏÉÅÏÑ∏ Ï°∞Ìöå -->
	<select id="selectSoDetailList" parameterType="string" resultType="store.yd2team.business.service.EstiSoDetailVO">
	    SELECT
	        d.so_detail_no,
	        d.so_id,
	        d.product_id,
	        p.product_name,
	        d.qy AS ttSoQy,
	        d.price,
	        d.supply_price AS ttSupplyAmt,
	        (NVL(s.curr_stock_qy, 0) - NVL(s.oust_reserv_qy, 0)) AS currStockQy
	    FROM tb_so_detail d
	    JOIN tb_product p
	      ON d.product_id = p.product_id
	    LEFT JOIN tb_stock s
	      ON d.product_id = s.product_id
	    WHERE d.so_id = #{soId}
	    ORDER BY d.so_detail_no
	</select>
	
	<!-- Ï£ºÎ¨∏ÏÑúÍ¥ÄÎ¶¨ÌôîÎ©¥ ÏäπÏù∏Î≤ÑÌäº -->
	<!-- Îã®Í±¥ Ï°∞Ìöå (ÏÉÅÌÉú ÌôïÏù∏Ïö©) -->
    <select id="getOrderHeader"
            parameterType="string"
            resultType="store.yd2team.business.service.EstiSoVO">
        SELECT so_id, progrs_st
        FROM tb_so
        WHERE so_id = #{soId}
    </select>

	<select id="selectSoStatus" resultType="String">
        SELECT progrs_st
        FROM tb_so
        WHERE so_id = #{soId}
    </select>

    <!-- ÏäπÏù∏ ÏÉÅÌÉú Î≥ÄÍ≤Ω -->
    <update id="updateSoStatusToApproved">
	    UPDATE tb_so
	       SET progrs_st = 'es2',
	           updt_dt   = SYSDATE,
	           updt_by   = #{updtBy}
	     WHERE so_id   = #{soId}
	       AND vend_id = #{vendId}
	</update>

    
    
    <!-- Ï£ºÎ¨∏ Î≥¥Î•ò Ï≤òÎ¶¨ -->
	<update id="updateRejectStatus">
	    UPDATE tb_so
	       SET progrs_st = 'es5',
	           st_resn   = #{reason},
	           updt_dt   = SYSDATE,
	           updt_by   = #{updtBy}
	     WHERE so_id   = #{soId}
	       AND vend_id = #{vendId}
	</update>

	
	<!-- Ï£ºÎ¨∏ Ï∑®ÏÜå Ï≤òÎ¶¨ -->
	<update id="updateCancelStatus">
	    UPDATE tb_so
	       SET progrs_st = 'es9',   -- Ï∑®ÏÜå ÏÉÅÌÉú
	           st_resn   = #{reason},
	           updt_dt   = SYSDATE,
	           updt_by   = #{updtBy}
	     WHERE so_id   = #{soId}
	       AND vend_id = #{vendId}
	</update>

	
	<!-- Ï∂úÌïòÏßÄÏãú INSERT -->
	<insert id="insertOust" parameterType="store.yd2team.business.service.OustVO">
	    INSERT INTO tb_oust (
	          oust_id
	        , so_id
	        , vend_id          -- ÌöåÏÇ¨ÏΩîÎìú
	        , oust_plan_dt
	        , oust_request_dt
	        , ship_addr
	        , rm
	        , crea_dt
	        , crea_by          -- Îì±Î°ùÏûê
	        , updt_dt
	        , updt_by
	    ) VALUES (
	          fn_oust_id()
	        , #{soId}
	        , #{vendId}
	        , #{oustPlanDt}
	        , #{oustRequestDt}
	        , #{shipAddr}
	        , #{rm}
	        , SYSDATE
	        , #{creaBy}
	        , SYSDATE
	        , #{updtBy}
	    )
	</insert>

	
	<!-- Ï£ºÎ¨∏ÏÑú ÏÉÅÌÉú ÏàòÏ†ï -->
	<update id="updateSoStatus">
	    UPDATE tb_so
	       SET progrs_st = #{status},
	           updt_dt   = SYSDATE,
	           updt_by   = #{updtBy}
	     WHERE so_id   = #{soId}
	       AND vend_id = #{vendId}
	</update>

</mapper>