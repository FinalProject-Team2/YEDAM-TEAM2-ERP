<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="store.yd2team.insa.mapper.AttdStatusMapper">

    <!-- HR ê´€ë¦¬ìž ê¶Œí•œ ì—¬ë¶€ ì²´í¬ -->
    <select id="selectHrAdminCnt" resultType="int">
        SELECT COUNT(1)
          FROM tb_user_role
         WHERE vend_id     = #{vendId}
           AND emp_acct_id = #{empAcctId}
           AND role_id     = 'ROLE_HR_ADMIN'
    </select>

    <!-- ============================
         ê´€ë¦¬ìžìš©: ì „ì²´ ì‚¬ì› ê·¼íƒœ ì¡°íšŒ
         - ì§ê¸‰: tb_emp.rspofc -> tb_code.code_nm
         - ê·¼íƒœìœ í˜•:
             * a.vcatn_id IS NOT NULL  -> tb_vcatn.vcatn_ty
             * ELSE                     -> a.attd_ty
       ============================ -->
    <select id="selectAttdListAdmin"
            parameterType="store.yd2team.insa.service.AttdStatusVO"
            resultType="store.yd2team.insa.service.AttdStatusVO">

        SELECT
              TO_CHAR(a.wk_dt, 'YYYY.MM.DD') AS wkDt
            , d.dept_nm                      AS deptNm
            , rspofc_cd.code_nm              AS roleNm
            , a.emp_id                       AS empId
            , e.nm                           AS empNm
            , CASE
                  WHEN a.vcatn_id IS NOT NULL THEN v.vcatn_ty
                  ELSE a.attd_ty
              END                            AS attdTy
            , TO_CHAR(a.atdc_tm, 'HH24:MI')  AS attdIn
            , TO_CHAR(a.afwk_tm, 'HH24:MI')  AS attdOut
        FROM tb_attd a
           JOIN tb_emp e
             ON a.emp_id  = e.emp_id
            AND a.vend_id = e.vend_id
      LEFT JOIN tb_dept d
             ON e.dept_id = d.dept_id
            AND d.vend_id = e.vend_id
      LEFT JOIN tb_vcatn v
             ON a.vcatn_id = v.vcatn_id
      LEFT JOIN tb_code rspofc_cd
             ON rspofc_cd.code_id = e.rspofc
            AND (rspofc_cd.vend_id IS NULL OR rspofc_cd.vend_id = e.vend_id)
        WHERE a.vend_id = #{vendId}

        <!-- ë¶€ì„œ ì¡°ê±´ -->
        <if test="deptId != null and deptId != ''">
            AND e.dept_id = #{deptId}
        </if>

        <!-- ì‚¬ì›ëª… like ê²€ìƒ‰ -->
        <if test="empNmCond != null and empNmCond != ''">
            AND e.nm LIKE '%' || #{empNmCond} || '%'
        </if>

        <!-- ðŸ”¥ ë‚ ì§œ ì¡°ê±´ ë¶„ë¦¬ -->
        <!-- ì‹œìž‘ì¼ë§Œ ìž…ë ¥ëœ ê²½ìš°: ì‹œìž‘ì¼ ì´ìƒ -->
        <if test="startDt != null and startDt != '' and (endDt == null or endDt == '')">
            AND a.wk_dt &gt;= TO_DATE(#{startDt}, 'YYYY-MM-DD')
        </if>

        <!-- ì¢…ë£Œì¼ë§Œ ìž…ë ¥ëœ ê²½ìš°: ì¢…ë£Œì¼ ì´í•˜ -->
        <if test="(startDt == null or startDt == '') and endDt != null and endDt != ''">
            AND a.wk_dt &lt;= TO_DATE(#{endDt}, 'YYYY-MM-DD')
        </if>

        <!-- ë‘˜ ë‹¤ ìžˆëŠ” ê²½ìš°: BETWEEN -->
        <if test="startDt != null and startDt != '' and endDt != null and endDt != ''">
            AND a.wk_dt BETWEEN TO_DATE(#{startDt}, 'YYYY-MM-DD')
                            AND TO_DATE(#{endDt},   'YYYY-MM-DD')
        </if>

        ORDER BY a.wk_dt DESC, d.dept_nm, e.nm
    </select>

    <!-- ============================
         ì¼ë°˜ ì‚¬ìš©ìž: ë³¸ì¸ ê·¼íƒœë§Œ ì¡°íšŒ
       ============================ -->
    <select id="selectAttdListUser"
            parameterType="store.yd2team.insa.service.AttdStatusVO"
            resultType="store.yd2team.insa.service.AttdStatusVO">

        SELECT
              TO_CHAR(a.wk_dt, 'YYYY.MM.DD') AS wkDt
            , d.dept_nm                      AS deptNm
            , rspofc_cd.code_nm              AS roleNm
            , a.emp_id                       AS empId
            , e.nm                           AS empNm
            , CASE
                  WHEN a.vcatn_id IS NOT NULL THEN v.vcatn_ty
                  ELSE a.attd_ty
              END                            AS attdTy
            , TO_CHAR(a.atdc_tm, 'HH24:MI')  AS attdIn
            , TO_CHAR(a.afwk_tm, 'HH24:MI')  AS attdOut
        FROM tb_attd a
           JOIN tb_emp e
             ON a.emp_id  = e.emp_id
            AND a.vend_id = e.vend_id
      LEFT JOIN tb_dept d
             ON e.dept_id = d.dept_id
            AND d.vend_id = e.vend_id
      LEFT JOIN tb_vcatn v
             ON a.vcatn_id = v.vcatn_id
      LEFT JOIN tb_code rspofc_cd
             ON rspofc_cd.code_id = e.rspofc
            AND (rspofc_cd.vend_id IS NULL OR rspofc_cd.vend_id = e.vend_id)
        WHERE a.vend_id = #{vendId}
          AND a.emp_id  = #{loginEmpId}

        <!-- ðŸ”¥ ë‚ ì§œ ì¡°ê±´ ë¶„ë¦¬ (ë¡œì§ ë™ì¼) -->
        <if test="startDt != null and startDt != '' and (endDt == null or endDt == '')">
            AND a.wk_dt &gt;= TO_DATE(#{startDt}, 'YYYY-MM-DD')
        </if>

        <if test="(startDt == null or startDt == '') and endDt != null and endDt != ''">
            AND a.wk_dt &lt;= TO_DATE(#{endDt}, 'YYYY-MM-DD')
        </if>

        <if test="startDt != null and startDt != '' and endDt != null and endDt != ''">
            AND a.wk_dt BETWEEN TO_DATE(#{startDt}, 'YYYY-MM-DD')
                            AND TO_DATE(#{endDt},   'YYYY-MM-DD')
        </if>

        ORDER BY a.wk_dt DESC, d.dept_nm, e.nm
    </select>

</mapper>
