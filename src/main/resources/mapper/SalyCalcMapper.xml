<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="store.yd2team.insa.mapper.SalyCalcMapper">

<select id="selectSalySpecCalcList"
        resultType="store.yd2team.insa.service.SalySpecCalcViewVO">
SELECT
    ss.saly_spec_id AS salySpecId,
    e.emp_id        AS empId,
    e.nm            AS empNm,
    d.dept_nm       AS deptNm,

    cc.code_nm      AS clsfNm,
    rc.code_nm      AS rspofcNm,

    si.grp_no       AS grpNo,
    g.grp_nm        AS calcGrpNm,

    ss.pay_amt      AS payAmt,
    ss.tt_duc_amt   AS ttDucAmt,
    ss.act_pay_amt  AS actPayAmt
FROM tb_saly_spec ss
JOIN tb_emp e
  ON e.emp_id = ss.emp_id
LEFT JOIN tb_dept d
  ON d.dept_id = e.dept_id

LEFT JOIN tb_code cc
  ON cc.code_id = e.clsf
 AND cc.grp_id  = 'k'   <!-- ⚠️ 여기를 "직급" 그룹ID로 바꿔 -->

LEFT JOIN tb_code rc
  ON rc.code_id = e.rspofc
 AND rc.grp_id  = 'l'   <!-- ⚠️ 여기를 "직책" 그룹ID로 바꿔 -->

LEFT JOIN (
    SELECT saly_spec_id,
           MAX(grp_no) KEEP (DENSE_RANK LAST ORDER BY crea_dt) AS grp_no
      FROM tb_saly_spec_item
     GROUP BY saly_spec_id
) si
  ON si.saly_spec_id = ss.saly_spec_id

LEFT JOIN tb_pay_cal_grp g
  ON g.grp_no  = si.grp_no
 AND g.vend_id = #{vendId}

WHERE ss.saly_ledg_id = #{salyLedgId}
</select>



  <select id="callPrcCalcSalyItems" statementType="CALLABLE" parameterType="map">
    { CALL prc_calc_saly_items(
        #{p_saly_ledg_id, mode=IN, jdbcType=VARCHAR},
        #{p_emp_id,       mode=IN, jdbcType=VARCHAR},
        #{p_grp_no,       mode=IN, jdbcType=NUMERIC},
        #{o_result,       mode=OUT, jdbcType=CURSOR, resultMap=payItemRowMap}
    ) }
  </select>

  <resultMap id="payItemRowMap" type="store.yd2team.insa.service.PayItemRowVO">
    <result property="itemTy" column="ITEM_TY"/>
    <result property="itemId" column="ITEM_ID"/>
    <result property="itemNm" column="ITEM_NM"/>
    <result property="amt"    column="AMT"/>
  </resultMap>

  <delete id="deleteSpecItemsBySpecAndGrp">
    DELETE
      FROM tb_saly_spec_item
     WHERE saly_spec_id = #{salySpecId}
       AND grp_no       = #{grpNo}
  </delete>

  <delete id="deleteSpecItemsBySpecAndItemIds" parameterType="map">
    DELETE
      FROM tb_saly_spec_item
     WHERE saly_spec_id = #{salySpecId}
       AND item_id IN
       <foreach collection="itemIdList" item="id" open="(" close=")" separator=",">
         #{id}
       </foreach>
  </delete>

  <!-- =========================
       ✅ FIX 핵심: 캐시 OFF
       - 파라미터 없는 NEXTVAL 조회는 MyBatis 로컬캐시로
         같은 값이 반복될 수 있음
       - useCache=false, flushCache=true로 강제
       ========================= -->

<insert id="insertSpecItems" parameterType="map">
  BEGIN
  <foreach collection="list" item="it">
    INSERT INTO tb_saly_spec_item (
        saly_spec_id,
        grp_no,
        item_no,
        item_ty,
        item_id,
        item_nm,
        amt,
        crea_dt,
        crea_by
    ) VALUES (
        #{it.salySpecId},
        #{it.grpNo},
        SEQ_SALY_SPEC_ITEM.NEXTVAL,
        #{it.itemTy},
        #{it.itemId},
        #{it.itemNm},
        #{it.amt},
        SYSDATE,
        #{it.creaBy}
    );
  </foreach>
  END;
</insert>


  <update id="updateSalySpecTotals">
    UPDATE tb_saly_spec
       SET pay_amt     = #{payAmt},
           tt_duc_amt  = #{ttDucAmt},
           act_pay_amt = #{actPayAmt},
           updt_dt     = SYSDATE,
           updt_by     = #{updtBy}
     WHERE saly_spec_id = #{salySpecId}
  </update>

  <select id="selectSalySpecItems" resultType="store.yd2team.insa.service.SalySpecItemVO">
    SELECT
        saly_spec_id      AS salySpecId,
        grp_no            AS grpNo,
        item_no           AS itemNo,
        item_ty           AS itemTy,
        item_id           AS itemId,
        item_nm           AS itemNm,
        amt               AS amt,
        crea_dt           AS creaDt,
        crea_by           AS creaBy,
        updt_dt           AS updtDt,
        updt_by           AS updtBy
      FROM tb_saly_spec_item
     WHERE saly_spec_id = #{salySpecId}
       AND grp_no       = #{grpNo}
     ORDER BY item_no
  </select>

  <select id="selectCalcGroupList" resultType="store.yd2team.insa.service.CalGrpVO">
    SELECT
        grp_no  AS grpNo,
        grp_nm  AS grpNm,
        crea_dt AS creaDt,
        crea_by AS creaBy,
        updt_dt AS updtDt,
        updt_by AS updtBy,
        vend_id AS vendId
      FROM tb_pay_cal_grp
     WHERE vend_id = #{vendId}
     ORDER BY grp_no
  </select>

  <select id="selectAllowListForCalc" resultType="store.yd2team.insa.service.AllowDucVO">
    SELECT
        a.vend_id   AS vendId,
        CAST(a.disp_no AS NUMBER(19,0)) AS dispNo,
        a.cal_fmlt  AS calFmlt,
        a.cal_mthd  AS calMthd,
        a.yn        AS ynCode,
        a.allow_id  AS allowId,
        a.allow_nm  AS allowNm,
        a.crea_dt   AS creaDt,
        a.crea_by   AS creaBy,
        a.updt_dt   AS updtDt,
        a.updt_by   AS updtBy
      FROM tb_allow a
     WHERE a.vend_id = #{vendId}
       AND a.yn      = 'e1'
    <if test="grpNo != null">
       AND EXISTS (
          SELECT 1
            FROM tb_pay_cal_grp_item gi
            JOIN tb_pay_cal_grp g
              ON g.grp_no = gi.grp_no
           WHERE gi.grp_no  = #{grpNo}
             AND gi.item_ty = 'A'
             AND gi.item_id = a.allow_id
             AND g.vend_id  = #{vendId}
       )
    </if>
     ORDER BY a.disp_no, a.allow_id
  </select>

  <select id="selectDucListForCalc" resultType="store.yd2team.insa.service.AllowDucVO">
    SELECT
        d.vend_id  AS vendId,
        CAST(d.disp_no AS NUMBER(19,0)) AS dispNo,
        d.cal_fmlt AS calFmlt,
        d.cal_mthd AS calMthd,
        d.yn       AS ynCode,
        d.duc_id   AS ducId,
        d.duc_nm   AS ducNm,
        d.crea_dt  AS creaDt,
        d.crea_by  AS creaBy,
        d.updt_dt  AS updtDt,
        d.updt_by  AS updtBy
      FROM tb_duc d
     WHERE d.vend_id = #{vendId}
       AND d.yn      = 'e1'
    <if test="grpNo != null">
       AND EXISTS (
          SELECT 1
            FROM tb_pay_cal_grp_item gi
            JOIN tb_pay_cal_grp g
              ON g.grp_no = gi.grp_no
           WHERE gi.grp_no  = #{grpNo}
             AND gi.item_ty = 'D'
             AND gi.item_id = d.duc_id
             AND g.vend_id  = #{vendId}
       )
    </if>
     ORDER BY d.disp_no, d.duc_id
  </select>

  <delete id="deleteGrpItemsByGrpNo">
    DELETE
      FROM tb_pay_cal_grp_item gi
     WHERE gi.grp_no = #{grpNo}
       AND EXISTS (
         SELECT 1
           FROM tb_pay_cal_grp g
          WHERE g.grp_no  = gi.grp_no
            AND g.vend_id = #{vendId}
       )
  </delete>

  <insert id="insertGrpItems" parameterType="map">
    INSERT ALL
    <foreach collection="list" item="it">
      INTO tb_pay_cal_grp_item (
        grp_no, item_ty, item_id, crea_dt, crea_by
      ) VALUES (
        #{it.grpNo}, #{it.itemTy}, #{it.itemId}, SYSDATE, #{it.creaBy}
      )
    </foreach>
    SELECT 1 FROM dual
  </insert>

  <select id="selectNextCalcGrpNo" resultType="long" useCache="false" flushCache="true">
    SELECT seq_pay_cal_grp.NEXTVAL FROM dual
  </select>

  <insert id="insertCalcGroup">
    INSERT INTO tb_pay_cal_grp (
        grp_no, vend_id, grp_nm, crea_dt, crea_by
    ) VALUES (
        #{grpNo}, #{vendId}, #{grpNm}, SYSDATE, #{creaBy}
    )
  </insert>

  <update id="updateCalcGroup">
    UPDATE tb_pay_cal_grp
       SET grp_nm  = #{grpNm},
           updt_dt = SYSDATE,
           updt_by = #{updtBy}
     WHERE vend_id = #{vendId}
       AND grp_no  = #{grpNo}
  </update>

  <delete id="deleteCalcGroup">
    DELETE FROM tb_pay_cal_grp
     WHERE vend_id = #{vendId}
       AND grp_no  = #{grpNo}
  </delete>
  <!-- =========================================================
     salySpecId → empId 조회
     (급여계산 미리보기/저장 공통)
     ========================================================= -->
<select id="selectEmpIdBySpecId"
        parameterType="string"
        resultType="string">
    SELECT emp_id
      FROM tb_saly_spec
     WHERE saly_spec_id = #{salySpecId}
</select>
    <!-- ✅ (추가) spec+grp에서 itemIdList에 "없는" 항목 삭제 -->
  <delete id="deleteSpecItemsBySpecAndItemIdsNotIn" parameterType="map">
    DELETE FROM tb_saly_spec_item
     WHERE saly_spec_id = #{salySpecId}
       AND grp_no       = #{grpNo}
       AND item_id NOT IN
       <foreach collection="itemIdList" item="id" open="(" separator="," close=")">
         #{id}
       </foreach>
  </delete>

  <!-- ✅ (추가) spec+grp+itemId 기준 MERGE (있으면 UPDATE, 없으면 INSERT) -->
<!-- ✅ 단건 upsert: (saly_spec_id, grp_no, item_id) 기준 -->
<insert id="mergeSpecItem" parameterType="map">
  MERGE INTO tb_saly_spec_item t
  USING (
    SELECT
      #{salySpecId} AS saly_spec_id,
      #{grpNo}      AS grp_no,
      #{itemTy}     AS item_ty,
      #{itemId}     AS item_id,
      #{itemNm}     AS item_nm,
      #{amt}        AS amt
    FROM dual
  ) s
  ON (
    t.saly_spec_id = s.saly_spec_id
    AND t.grp_no   = s.grp_no
    AND t.item_id  = s.item_id
  )
  WHEN MATCHED THEN
    UPDATE SET
      t.item_ty  = s.item_ty,
      t.item_nm  = s.item_nm,
      t.amt      = s.amt,
      t.updt_dt  = SYSDATE,
      t.updt_by  = #{updtBy}
  WHEN NOT MATCHED THEN
    INSERT (
      saly_spec_id,
      grp_no,
      item_no,
      item_ty,
      item_id,
      item_nm,
      amt,
      crea_dt,
      crea_by,
      updt_dt,
      updt_by
    )
    VALUES (
      s.saly_spec_id,
      s.grp_no,
      SEQ_SALY_SPEC_ITEM.NEXTVAL,
      s.item_ty,
      s.item_id,
      s.item_nm,
      s.amt,
      SYSDATE,
      #{creaBy},
      SYSDATE,
      #{updtBy}
    )
</insert>


</mapper>
