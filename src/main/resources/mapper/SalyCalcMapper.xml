<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="store.yd2team.insa.mapper.SalyCalcMapper">

<select id="selectSalySpecCalcList"
        resultType="store.yd2team.insa.service.SalySpecCalcViewVO">
  SELECT
      sp.saly_spec_id AS salySpecId,
      e.emp_id        AS empId,
      e.nm            AS empNm,
      d.dept_nm       AS deptNm,

      c1.code_nm      AS clsfNm,      <!-- ✅ 직급명 -->
      c2.code_nm      AS rspofcNm,    <!-- ✅ 직책명 -->

      NVL(sp.pay_amt, 0)      AS payAmt,
      NVL(sp.tt_duc_amt, 0)   AS ttDucAmt,
      NVL(sp.act_pay_amt, 0)  AS actPayAmt
  FROM tb_saly_spec sp
  JOIN tb_emp e
    ON e.emp_id = sp.emp_id
   AND e.vend_id = #{vendId}
  LEFT JOIN tb_dept d
    ON d.dept_id = e.dept_id
  LEFT JOIN tb_code c1
    ON c1.code_id = e.clsf        <!-- 직급 -->
   AND (c1.vend_id = #{vendId} OR c1.vend_id IS NULL)
  LEFT JOIN tb_code c2
    ON c2.code_id = e.rspofc      <!-- 직책 -->
   AND (c2.vend_id = #{vendId} OR c2.vend_id IS NULL)
  WHERE sp.saly_ledg_id = #{salyLedgId}
  ORDER BY e.emp_id
</select>

  <select id="callPrcCalcSalyItems" statementType="CALLABLE" parameterType="map">
    { CALL prc_calc_saly_items(
        #{p_saly_ledg_id, mode=IN, jdbcType=VARCHAR},
        #{p_emp_id,       mode=IN, jdbcType=VARCHAR},
        #{p_grp_no,       mode=IN, jdbcType=NUMERIC},
        #{o_result,       mode=OUT, jdbcType=CURSOR, resultMap=payItemRowMap}
    ) }
  </select>

  <resultMap id="payItemRowMap" type="store.yd2team.insa.service.PayItemRowVO">
    <result property="itemTy" column="ITEM_TY"/>
    <result property="itemId" column="ITEM_ID"/>
    <result property="itemNm" column="ITEM_NM"/>
    <result property="amt"    column="AMT"/>
  </resultMap>

  <delete id="deleteSpecItemsBySpecAndGrp">
    DELETE
      FROM tb_saly_spec_item
     WHERE saly_spec_id = #{salySpecId}
       AND grp_no       = #{grpNo}
  </delete>

  <delete id="deleteSpecItemsBySpecAndItemIds" parameterType="map">
    DELETE
      FROM tb_saly_spec_item
     WHERE saly_spec_id = #{salySpecId}
       AND item_id IN
       <foreach collection="itemIdList" item="id" open="(" close=")" separator=",">
         #{id}
       </foreach>
  </delete>

  <!-- =========================
       ✅ FIX 핵심: 캐시 OFF
       - 파라미터 없는 NEXTVAL 조회는 MyBatis 로컬캐시로
         같은 값이 반복될 수 있음
       - useCache=false, flushCache=true로 강제
       ========================= -->
  <select id="selectNextSpecItemNo" resultType="long" useCache="false" flushCache="true">
    SELECT SEQ_SALY_SPEC_ITEM.NEXTVAL FROM dual
  </select>

  <insert id="insertSpecItems" parameterType="map">
    INSERT ALL
    <foreach collection="list" item="it">
      INTO tb_saly_spec_item (
          saly_spec_id,
          grp_no,
          item_no,
          item_ty,
          item_id,
          item_nm,
          amt,
          crea_dt,
          crea_by
      ) VALUES (
          #{it.salySpecId},
          #{it.grpNo},
          #{it.itemNo},
          #{it.itemTy},
          #{it.itemId},
          #{it.itemNm},
          #{it.amt},
          SYSDATE,
          #{it.creaBy}
      )
    </foreach>
    SELECT 1 FROM dual
  </insert>

  <update id="updateSalySpecTotals">
    UPDATE tb_saly_spec
       SET pay_amt     = #{payAmt},
           tt_duc_amt  = #{ttDucAmt},
           act_pay_amt = #{actPayAmt},
           updt_dt     = SYSDATE,
           updt_by     = #{updtBy}
     WHERE saly_spec_id = #{salySpecId}
  </update>

  <select id="selectSalySpecItems" resultType="store.yd2team.insa.service.SalySpecItemVO">
    SELECT
        saly_spec_id      AS salySpecId,
        grp_no            AS grpNo,
        item_no           AS itemNo,
        item_ty           AS itemTy,
        item_id           AS itemId,
        item_nm           AS itemNm,
        amt               AS amt,
        crea_dt           AS creaDt,
        crea_by           AS creaBy,
        updt_dt           AS updtDt,
        updt_by           AS updtBy
      FROM tb_saly_spec_item
     WHERE saly_spec_id = #{salySpecId}
       AND grp_no       = #{grpNo}
     ORDER BY item_no
  </select>

  <select id="selectCalcGroupList" resultType="store.yd2team.insa.service.CalGrpVO">
    SELECT
        grp_no  AS grpNo,
        grp_nm  AS grpNm,
        crea_dt AS creaDt,
        crea_by AS creaBy,
        updt_dt AS updtDt,
        updt_by AS updtBy,
        vend_id AS vendId
      FROM tb_pay_cal_grp
     WHERE vend_id = #{vendId}
     ORDER BY grp_no
  </select>

  <select id="selectAllowListForCalc" resultType="store.yd2team.insa.service.AllowDucVO">
    SELECT
        a.vend_id   AS vendId,
        CAST(a.disp_no AS NUMBER(19,0)) AS dispNo,
        a.cal_fmlt  AS calFmlt,
        a.cal_mthd  AS calMthd,
        a.yn        AS ynCode,
        a.allow_id  AS allowId,
        a.allow_nm  AS allowNm,
        a.crea_dt   AS creaDt,
        a.crea_by   AS creaBy,
        a.updt_dt   AS updtDt,
        a.updt_by   AS updtBy
      FROM tb_allow a
     WHERE a.vend_id = #{vendId}
       AND a.yn      = 'e1'
    <if test="grpNo != null">
       AND EXISTS (
          SELECT 1
            FROM tb_pay_cal_grp_item gi
            JOIN tb_pay_cal_grp g
              ON g.grp_no = gi.grp_no
           WHERE gi.grp_no  = #{grpNo}
             AND gi.item_ty = 'A'
             AND gi.item_id = a.allow_id
             AND g.vend_id  = #{vendId}
       )
    </if>
     ORDER BY a.disp_no, a.allow_id
  </select>

  <select id="selectDucListForCalc" resultType="store.yd2team.insa.service.AllowDucVO">
    SELECT
        d.vend_id  AS vendId,
        CAST(d.disp_no AS NUMBER(19,0)) AS dispNo,
        d.cal_fmlt AS calFmlt,
        d.cal_mthd AS calMthd,
        d.yn       AS ynCode,
        d.duc_id   AS ducId,
        d.duc_nm   AS ducNm,
        d.crea_dt  AS creaDt,
        d.crea_by  AS creaBy,
        d.updt_dt  AS updtDt,
        d.updt_by  AS updtBy
      FROM tb_duc d
     WHERE d.vend_id = #{vendId}
       AND d.yn      = 'e1'
    <if test="grpNo != null">
       AND EXISTS (
          SELECT 1
            FROM tb_pay_cal_grp_item gi
            JOIN tb_pay_cal_grp g
              ON g.grp_no = gi.grp_no
           WHERE gi.grp_no  = #{grpNo}
             AND gi.item_ty = 'D'
             AND gi.item_id = d.duc_id
             AND g.vend_id  = #{vendId}
       )
    </if>
     ORDER BY d.disp_no, d.duc_id
  </select>

  <delete id="deleteGrpItemsByGrpNo">
    DELETE
      FROM tb_pay_cal_grp_item gi
     WHERE gi.grp_no = #{grpNo}
       AND EXISTS (
         SELECT 1
           FROM tb_pay_cal_grp g
          WHERE g.grp_no  = gi.grp_no
            AND g.vend_id = #{vendId}
       )
  </delete>

  <insert id="insertGrpItems" parameterType="map">
    INSERT ALL
    <foreach collection="list" item="it">
      INTO tb_pay_cal_grp_item (
        grp_no, item_ty, item_id, crea_dt, crea_by
      ) VALUES (
        #{it.grpNo}, #{it.itemTy}, #{it.itemId}, SYSDATE, #{it.creaBy}
      )
    </foreach>
    SELECT 1 FROM dual
  </insert>

  <select id="selectNextCalcGrpNo" resultType="long" useCache="false" flushCache="true">
    SELECT seq_pay_cal_grp.NEXTVAL FROM dual
  </select>

  <insert id="insertCalcGroup">
    INSERT INTO tb_pay_cal_grp (
        grp_no, vend_id, grp_nm, crea_dt, crea_by
    ) VALUES (
        #{grpNo}, #{vendId}, #{grpNm}, SYSDATE, #{creaBy}
    )
  </insert>

  <update id="updateCalcGroup">
    UPDATE tb_pay_cal_grp
       SET grp_nm  = #{grpNm},
           updt_dt = SYSDATE,
           updt_by = #{updtBy}
     WHERE vend_id = #{vendId}
       AND grp_no  = #{grpNo}
  </update>

  <delete id="deleteCalcGroup">
    DELETE FROM tb_pay_cal_grp
     WHERE vend_id = #{vendId}
       AND grp_no  = #{grpNo}
  </delete>
  <!-- =========================================================
     salySpecId → empId 조회
     (급여계산 미리보기/저장 공통)
     ========================================================= -->
<select id="selectEmpIdBySpecId"
        parameterType="string"
        resultType="string">
    SELECT emp_id
      FROM tb_saly_spec
     WHERE saly_spec_id = #{salySpecId}
</select>
  

</mapper>
